/*
 © 2013 Bluenod - All rights reserved.
 @version 20130520_3
*/
var Blu={app:{urls:{main:"",alt:[],preview:"",ajax_base:"ajax/",graphs_base:"data/json/"}},config:{tweets:{getNew:!0,load:!0,loadLimit:400,loadAllPrevious:!1,grabClientSide:!1,max_pages:5,prettyDate:!0},users:{connectVisitor:!0,profilePopUp:!1},map:{nodeLabel:"id",showLabels:!1,usercards:{show:!1,showHover:!1,distance:1},showFollowing:!0,style:{nodes:{font_family:"Helvetica, Arial, sans-serif",gradient:!0,gradRadius:0.7,monochrome:!0}},zoomAnimation:!0},mapOnly:!1,timeline:{style:{cursorBegin:!0,
plotType:"lines",plotWave:!0,plotStep:{x:4},bgNotSelected:"rgba(255,255,255,0.6)",lineColor:"rgba(26,186,255,1)",waveColor:"rgba(26,186,255,0.5)"}},timemachine:{activated:!0},others:{embedly:{activated:!0}},style:{scrollbar:{cursorcolor:"#666",cursorborder:"0"}},UI:{animatePanels:!1}},images:{default_user:"/style/mapping/img/Default_Twitter_Avatar_128px.png",default_search:"/style/mapping/img/Default_Twitter_Avatar_Hashtag_128px.png"},is:{},has:{},needs:{},projects:{current:{id:0,dates:{min:"",max:"",
timeOffset:0}},list:[]},user:{},dates:{min:"",max:""},rayonLoupe:200,gammaLoupe:0.5,zoneGraphe:{largeur:0,hauteur:0},oldZoneGraphe:{},viz:{current:"",by_default:"map"},canvas:{},canvas_mini:{timeline:{},map:{}},canvas_timemachine:{},timeline:{activated:!1,params:{zoomLevel:0,centreY:0,granularite:"auto",trancheCourante:-1,trancheHover:-1,filter:{string:"",dates:{min:null,max:null}}},oldParams:{},minZoom:-1,maxZoom:6,width:600,mini:{width:358,height:30},maxTweets:0,cursors:{timetravel:{}}},map:{defaults:{},
params:{zoomLevel:3,centreX:410,centreY:410,hoverNode:-1,selectedNode:-1,showEdges:!1,loupeActive:!1},oldParams:{},minZoom:1,maxZoom:14,mini:{width:150,height:125},width:800,height:700,miniScale:0.25},graphs:{current:"",all:[]},timemachine:{dragOn:!1,colors:{timeTravel:"#008fcd",currentTime:"#dc0000",graph:"#aaa",graphHover:"#ff640f"}},timeNav:{mode:"live"},datasets:[],currentDataset:"global",currentSubset:"",mouse:{pos:null,scroll:0,dragPx:{x:0,y:0}},touch:{scale:0},positionListeTweets:0,topWords:[],
topUsers:[],timers:{showUserCard:0},AC:{lastEntry:"",position:0},debugMode:!1,chrono:{},share:{html:""},timestamps:[],tranches:[],tweets:[],newTweets:[],intervals:[],counts:{tweets:{alltime:0,filter:0},users:{alltime:0,graph:0,filter:0}},history:[],DOM:{},usercards:{hover:{node:-1,position:{align:"",fromNode:0,x:0,y:0},state:{closed:!1,expanded:!0,locked:!1,mouseChanged:!1,mouseOver:!1,show:!1}},selected:{node:-1,position:{align:"",x:0,y:0},state:{closed:!1,expanded:!0,locked:!1,mouseChanged:!1,mouseOver:!1,
show:!1}}},users:[],templates:{},fn:{app:{},canvas:{},map:{},timeline:{},timemachine:{},timestamps:{},project:{},projects:{},tweet:{},tweets:{},tags:{},words:{},user:{},users:{},usercards:{},tranches:{},AC:{},url:{},misc:{},color:{},UI:{},history:{},timers:{},touch:{}},lang:"en",txt:function(){if(!arguments[0]||!Blu.localizedStrings[arguments[0]])return"";for(var a=arguments.length,b=Blu.localizedStrings[arguments[0]][Blu.lang],c,d=1;d<a;d++)c="\\{"+(d-1)+"\\}",c=RegExp(c,"g"),b=b.replace(c,arguments[d]);
return b}};Blu.fn.color.fondu=function(a,b){for(var c=a.split(/[(),]/),d=b.split(/[(),]/),e=[],f=1;f<Math.min(c.length-1,d.length-1);f++){var g=(parseFloat(c[f])+parseFloat(d[f]))/2;4>f&&(g=Math.floor(g));e.push(g)}return(4==e.length?"rgba":"rgb")+"("+e.join(",")+")"};Blu.fn.color.hue2rgb=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-c):a};
Blu.fn.color.hslToRgb=function(a,b,c,d){if(0==b)c=b=a=c;else{var e=0.5>c?c*(1+b):c+b-c*b,f=2*c-e;c=Math.round(255*Blu.fn.color.hue2rgb(f,e,a+1/3));b=Math.round(255*Blu.fn.color.hue2rgb(f,e,a));a=Math.round(255*Blu.fn.color.hue2rgb(f,e,a-1/3))}return{r:c,g:b,b:a,string:d?"rgba("+c+","+b+","+a+","+d+")":"rgb("+c+","+b+","+a+")"}};
Blu.fn.misc.texteJour=function(a,b){var c=Blu.localizedStrings["undefined"!==typeof b&&b?"months_abbrev":"months"][Blu.lang][a.getMonth()];return Blu.txt("date_format",a.getDate(),c)};Blu.fn.misc.monthName=function(a,b){return Blu.txt("undefined"!==typeof b&&b?"months_abbrev":"months")[a.getMonth()]};Blu.fn.misc.texteHeure=function(a){var b=a.getHours()+"";a=a.getMinutes()+"";return(1==b.length?"0":"")+b+":"+(1==a.length?"0":"")+a};
Blu.fn.timestamps.getAll=function(){Blu.info("Blu.fn.timestamps.getAll...");var a=Blu.fn.project.ajaxParams();a.action="list-timestamps";$.getJSON(Blu.app.urls.ajax_base,a,function(a){a.timestamps&&(Blu.has.loadedTimestamps=!0,Blu.timestamps=a.timestamps,Blu.fn.timestamps.calcSlices(),Blu.fn.tranches.updateCounts())})};
Blu.fn.timestamps.calcSlices=function(){Blu.info("Blu.fn.timestamps.calcSlices()");if(!Blu.has.loadedTimestamps||!Blu.timestamps.length)Blu.warn("Pas de timestamps\u2026");else{Blu.timestamps.sort(function(a,c){return a.time-c.time});var a=Blu.timestamps[0].time,b=Blu.timestamps[Blu.timestamps.length-1].time;Blu.warn("Nb de timestamps : "+Blu.timestamps.length);Blu.timeline.params.centreX||(Blu.timeline.params.centreX=(a+b)/2);var c=Blu.timeline.params.granularite;"auto"===c&&(c=Math.floor((b-a)*
{bars:3,lines:Blu.config.timeline.style.plotStep.x}[Blu.config.timeline.style.plotType]/Blu.timeline.mini.width),c=Math.max(c,1),Blu.timeline.params.granularite=c,Blu.log("Granularit\u00e9 Timeline : "+c+" secondes"));a=c*Math.floor(a/c);b=c*Math.floor(b/c);for(Blu.tranches=[];a<=b;a+=c){var d=a+c,e=new Date(1E3*a),f=new Date(1E3*d),g=Blu.fn.misc.texteJour(e),h=Blu.fn.misc.texteHeure(e),j=Blu.fn.misc.texteHeure(f);Blu.tranches.push({dateStart:e,dateEnd:f,debut:a,fin:d,jour:g,jour:g,debut_heure:h,
fin_heure:j})}for(b=c=0;b<=Blu.timestamps.length-1;b++){for(;Blu.timestamps[b].time>Blu.tranches[c].fin;)c++;Blu.timestamps[b].tranche=c}Blu.fn.tranches.jours()}};
Blu.fn.tranches.jours=function(){Blu.jours=[{nom:Blu.tranches[0].jour,debut:Blu.tranches[0].debut}];for(var a in Blu.tranches)Blu.tranches[a].jour!=Blu.jours[Blu.jours.length-1].nom&&(Blu.jours[Blu.jours.length-1].fin=Blu.tranches[a].debut,Blu.jours.push({nom:Blu.tranches[a].jour,debut:Blu.tranches[a].debut}));Blu.jours[Blu.jours.length-1].fin=Blu.tranches[Blu.tranches.length-1].fin};
Blu.fn.tranches.updateCounts=function(){Blu.info("Blu.fn.tranches.updateCounts...");if(1>Blu.tranches.length)Blu.warn("Pas de tranches.");else{for(var a in Blu.tranches)Blu.tranches[a].nombre=0;for(a in Blu.timestamps)Blu.tranches[Blu.timestamps[a].tranche].nombre++;Blu.timeline.maxTweets=0;for(a in Blu.tranches)Blu.timeline.maxTweets=Math.max(Blu.tranches[a].nombre,Blu.timeline.maxTweets)}};
Blu.fn.topWordsUsers=function(){if(!Blu.config.mapOnly){var a=Blu.fn.project.ajaxParams();a.action="top-words-users";$.getJSON(Blu.app.urls.ajax_base,a,function(a){Blu.wordsBase=a.top_words;Blu.usersBase=a.top_users})}};Blu.fn.users.fillAll=function(a){Blu.warn("Blu.fn.users.fillAll");for(var b in a){var c=a[b].from_user.toLowerCase();Blu.users[c]&&Blu.users[c].data.profile_image_url!==Blu.images.default_user||(Blu.users[c]={data:{screen_name:c,profile_image_url:a[b].profile_image_url}})}};
Blu.fn.history.add=function(a){Blu.history.push(a)};Blu.fn.history.clear=function(){Blu.history=[]};Blu.fn.users.add=function(a){if(a.screen_name){var b=a.screen_name.toLowerCase();Blu.users[b]={data:a}}};Blu.fn.user.get=function(a){a=(a||"").replace("@","").toLowerCase();Blu.users[a]||(Blu.users[a]={data:{screen_name:a,profile_image_url:Blu.images.default_user}});return Blu.users[a]};
Blu.fn.user.getById=function(a){Blu.users["id:"+a]||(Blu.users["id:"+a]={data:{screen_name:"",profile_image_url:Blu.images.default_user}});return Blu.users["id:"+a]};
Blu.fn.users.showTopUsers=function(){var a=$("#panels .panel.users"),b=a.children(".wrap"),c=Blu.topUsers.global.by_mentions;Blu.info("Blu.fn.users.showTopUsers... >> "+c.length+" users (global)");Blu.timers.calcTopUsers&&(Blu.fn.timers.resetInterval("calcTopUsers"),Blu.warn("Blu.timers.calcTopUsers : finished @ "+(new Date).toString()));Blu.user.id?(Blu.fn.user.lookupTopUsers(c),b.html(Blu.fn.users.listUsers({theClass:"topUsers by_mentions",userRanked:"User",numberTitle:"Mentions",tab:c.slice(0,
36)})),a.getNiceScroll().resize()):b.html(Blu.fn.UI.getPleaseConnectTemplate()).show()};
Blu.fn.users.calcAndShowTopUsers=function(){Blu.info("Blu.fn.users.calcAndShowTopUsers... @ "+(new Date).toString());Blu.timers.calcTopUsers?Blu.warn("We are alreading waiting for top users. We keep the first timer on."):(Blu.fn.users.topUsers(),Blu.fn.timers.resetInterval("calcTopUsers"),Blu.timers.calcTopUsers=setInterval(function(){1>Blu.tweets.length||(!Blu.topUsers.global||!Blu.is.topUsersReady)||Blu.fn.users.showTopUsers()},100))};
Blu.fn.users.topUsers=function(a,b){Blu.info("users.topUsers...");var c;"undefined"===typeof a?(a=Blu.tweets,c=!1,b=Blu.timeline.params.filter.string):c=!0;Blu.is.topUsersReady=!1;var d=/@[0-9a-zA-Z_]+/gi,e={global:{by_mentions:[],by_tweets:[]},user:{mentioned:[],mentioners:[],mentions:[]}},f,g,h,j=b.replace("@","").toLowerCase(),k=0,l=0,m=0,n=0,p="search-user"===Blu.projects.current.type?Blu.projects.current.twitter_screen_name.toLowerCase().replace("@",""):b,q;for(q in a)if(c||a[q].matchFilter){n++;
f=a[q].from_user.replace("@","").toLowerCase();f!==p&&Blu.fn.users.freqUser(e.global.by_mentions,f,"tweeted");g=a[q].text.match(d);for(var s in g)m++,h=g[s].replace("@","").toLowerCase(),h!==p&&Blu.fn.users.freqUser(e.global.by_mentions,h),j===f&&j!==h&&(l++,h!==p&&Blu.fn.users.freqUser(e.user.mentions,h,"mentioning")),j===h&&j!==f&&(k++,f!==p&&Blu.fn.users.freqUser(e.user.mentions,f,"mentioned"))}Blu.log("Sur les "+n+" tweets, il y a "+m+" mentions (auto-mentions comprises)");e.global.by_mentions=
e.global.by_mentions.sort(Blu.fn.misc.sortMentions);e.user.mentions=e.user.mentions.sort(Blu.fn.misc.sortMentions);Blu.log("  > Top users global : "+e.global.by_mentions.length+" users");Blu.log("  > Top users associ\u00e9 au profile : "+e.user.mentions.length+" users");Blu.is.topUsersReady=!0;clearTimeout(Blu.timers.updateTagCloud);if(c)return e;Blu.topUsers=e;Blu.fn.users.showTopUsers()};Blu.fn.misc.sortMentions=function(a,b){return b.count-a.count};
Blu.fn.misc.sortLastTweets=function(a,b){return b.id-a.id};Blu.fn.users.freqUser=function(a,b,c){b=b.toLowerCase();c=c||"mentions";var d="tweeted"===c?0:1,e;for(e in a)if(b==a[e].user){a[e].count+=d;c&&("mentioning"===c?a[e].searchMentioning++:"mentioned"===c&&a[e].searchMentioned++);return}a.push({user:b,count:d,searchMentioning:c&&"mentioning"===c?1:0,searchMentioned:c&&"mentioned"===c?1:0})};
Blu.fn.tweets.showList=function(){Blu.info("Blu.fn.tweets.showList...");var a=$("#panels .panel.tweets").find(".tweets-list");a.html("").scrollTop(0);Blu.positionListeTweets=0;Blu.fn.tweets.showPartialList();Blu.fn.UI.notifNewTweets();if(Blu.counts.tweets.filter){var b=a.siblings(".about-tweets");b.length||(a.before('<div class="about-tweets"></div>'),b=a.siblings(".about-tweets"));Blu.timeline.params.filter.string?(a=Blu.counts.tweets.filter,b.text(Blu.txt(1<a?"tweetsWithX":"tweetWithX",a,Blu.timeline.params.filter.string)).show()):
b.text("").hide()}};
Blu.fn.tweets.showPartialList=function(){var a=$("#panels .panel.tweets"),b="",c=0,d,e,f=0;Blu.regexFilter=Blu.fn.tweets.regexFilter();for(var g in Blu.tweets)if(d=Blu.tweets[g],e=-1===Blu.timeline.params.trancheCourante||Blu.timeline.params.trancheCourante===d.tranche,d.matchFilter&&e&&(c++,c>Blu.positionListeTweets&&(f++,b+=Blu.fn.tweet.display(d)),c>=Blu.positionListeTweets+10))break;Blu.positionListeTweets+=10;c<Blu.positionListeTweets&&clearInterval(Blu.timers.refreshListe);0<f&&a.find(".tweets-list").append(b).show()};
Blu.fn.tweet.display=function(a){a.isReady||Blu.fn.tweet.process(a);var b="",c=a.text,d=[];if("undefined"!==typeof a.entities){var e=[],f,g,h=0,j;for(j in a.entities)for(g in a.entities[j])f=a.entities[j][g],e.push(f),f.url&&d.push(f.url);e.sort(function(a,c){return parseInt(a.indices[0],10)-parseInt(c.indices[0],10)});for(j in e)f=e[j],g="",f.text?g='<a class="hashtag" href="https://twitter.com/#!/search/%23'+encodeURIComponent(f.text)+'" data-hashtag="'+f.text+'" target="_blank">#'+f.text+"</a>":
f.url?g='<a class="url" href="'+f.expanded_url+'" target="_blank">'+f.display_url+"</a>":f.screen_name&&(g='<a class="mention" href="http://twitter.com/'+f.screen_name+'" data-user="'+f.screen_name+'" target="_blank" title="'+f.name+'"><span>@</span>'+f.screen_name+"</a>"),parseInt(f.indices[0],10)>h&&(b+=c.substring(h,parseInt(f.indices[0],10))),b+=g,h=parseInt(f.indices[1],10);c.length>h&&(b+=c.substring(h));b=b.replace(/RT @[\w_]+: /g,"")}else{b=a.text;d=b.match(/(https?:[0-9a-zA-Z\/\-_\.~&?=\#]+)/g);
for(j in d)c='<a class="url" href="'+d[j]+'" target="_blank">'+d[j]+"</a>",b=b.replace(d[j],c);b=b.replace(/(^|\s)(@)([\w_]+)/g,'$1<a class="mention" href="http://twitter.com/$3" data-user="$3" target="_blank"><span>$2</span>$3</a>');b=b.replace(/(^|[^\w'"]+)\#([a-zA-Z0-9_]+)/g,function(a,c,b){return c+'<a class="hashtag" href="https://twitter.com/#!/search/%23'+b+'" data-hashtag="'+b+'" target="_blank">#'+b+"</a>"})}for(j in d)!Blu.fn.localhost()&&Blu.config.others.embedly.activated&&Blu.fn.tweets.embedly(d[j],
a.id,j);return'<li class="tweet" id="tweet_'+a.id+'"><div class="profile-pic"><a href="http://twitter.com/'+a.from_user+'" title="'+Blu.txt("showProfile")+'"><img class="avatar" src="'+a.profile_image_url+'" data-user="'+a.from_user+'" /></a></div><div class="tweet-content"><h4><a href="http://twitter.com/'+a.from_user+'" data-user="'+a.from_user+'" title="'+Blu.txt("showProfile")+'">'+a.from_user_name+"</a><span>@"+a.from_user+'</span></h4><p class="tweet-text">'+b+'</p><p class="time"> <a href="'+
Blu.fn.tweet.statusUrl(a.from_user,a.id)+'" target="_blank" title="'+Blu.fn.misc.dateObjectToString(a.dateObj)+'" data-date="'+a.dateObj.toString()+'">'+Blu.fn.misc.prettyDate(a.dateObj)+'</a></p><ul class="actions"><li><a class="favorite" href="#favorite"><span></span>'+Blu.txt("twActions_favorite")+'</a></li><li><a class="retweet" href="#retweet"><span></span>'+Blu.txt("twActions_retweet")+'</a></li><li><a class="reply" href="#reply"><span></span>'+Blu.txt("twActions_reply")+"</a></li></ul></div></li>"};
Blu.fn.tweet.statusUrl=function(a,b){return"http://twitter.com/"+a+"/status/"+b};Blu.fn.misc.domainFromUrl=function(a){return a.match(/:\/\/(.[^/]+)/)?a.match(/:\/\/(.[^/]+)/)[1].replace("www.",""):a};
Blu.fn.tweets.embedly=function(a,b,c){if(!$("#tweet_"+b).data("show_embedly_"+b+"_"+c)){var d=$(".tweets-list .tweet:first .tweet-content"),d=d.length?d.width():$(".tweets-list").width()-81,d=$.getJSON("http://api.embed.ly/1/oembed?format=json&callback=?",{key:"744caa38fe4411e0ab234040d3dc5c07",url:a,maxwidth:d,autoplay:!0,chars:200},function(a,c,b){if(!("undefined"===typeof a.type||"error"===a.type))if(a.url="undefined"!==typeof a.url?a.url:"",a.provider_url="undefined"!==typeof a.provider_url?a.provider_url:
"",a.title="undefined"!==typeof a.title?a.title:"undefined"!==typeof a.provider_name?a.provider_name:"",a.description="undefined"!==typeof a.description?a.description:"",a.thumbnail_url="undefined"!==typeof a.thumbnail_url?a.thumbnail_url:Blu.fn.app.isAppUrl(a.url)?Blu.app.urls.preview:"",a.html="undefined"!==typeof a.html?a.html:"",!(""===a.thumbnail_url&&""===a.title&&""===a.description)){c=$("#tweet_"+b.tweetid);var d=""!=a.thumbnail_url,j=""!=a.html,k=Blu.fn.misc.domainFromUrl(a.provider_url);
b="embedly_"+b.tweetid+"_"+b.index;var l=d?{width:a.thumbnail_width,height:a.thumbnail_height,maxWidth:85,maxHeight:85}:0;if(l)var m=l.width/l.height,n=l.maxWidth/l.maxHeight,p=parseInt(Math.min(l.maxWidth*m,l.width*n),10),m=parseInt(Math.min(l.maxHeight/m,l.height/n),10);l=l&&p<l.maxWidth?' style="margin-left:'+(p+8)+'px"':"";p='<div id="'+b+'" class="embed type-'+a.type+(!d?" no-thumb":"")+(j?" has-html":"")+'">'+(!d?"":'<a class="thumb" href="'+a.url+'" target="_blank" title="'+Blu.txt("titleEmbedImage")+
'"><img src="'+a.thumbnail_url+'" width="'+p+'" height="'+m+'"/><div class="play"></div></a>')+'<div class="infos"'+l+'><a class="title" href="'+a.url+'" target="_blank">'+a.title+'</a><br/><a class="source" href="'+a.provider_url+'" target="_blank">'+k+'</a><div class="description">'+a.description+"</div></div></div>";if(c.data("show_"+b))Blu.log("embed d\u00e9j\u00e0 affich\u00e9 > embedlyid = "+b);else if(c.append(p),c.data("show_"+b,!0),c=$("#"+b).find(".thumb, .infos .title"),a.html&&"Twitter"!=
a.provider_name)c.click(function(){$(this).parent(".embed").html(a.html);return!1});else switch(a.type){case "link":c.click(function(){if(Blu.fn.app.isAppUrl(a.url)||Blu.fn.app.blockingIframeWebsites(a.url))return!0;Blu.fn.UI.lightbox.iframe(a.url);return!1});break;case "photo":c.click(function(){Blu.fn.UI.lightbox.image(a.url,a.width,a.height);return!1});break;default:c.click(function(){return!0})}}});d.tweetid=b;d.url=a;d.index=c}};
Blu.fn.tweets.highlightSearch=function(a,b){if(!b)return a;var c=document.createElement("p");c.innerHTML=a;for(var d=0;d<c.childNodes.length;d++){var e=document.createElement("span");c.childNodes[d].childNodes&&c.childNodes[d].childNodes[0]?(e.innerHTML=c.childNodes[d].childNodes[0].textContent.replace(b.text,'<span class="surbrillance">$1</span>'),c.childNodes[d].replaceChild(e,c.childNodes[d].childNodes[0])):(e.innerHTML=c.childNodes[d].textContent.replace(b.text,'<span class="surbrillance">$1</span>'),
c.replaceChild(e,c.childNodes[d]))}return c.innerHTML};Blu.fn.tweets.timerNewTweets=function(){Blu.config.tweets.getNew&&(Blu.timers.loadNewTweets=setInterval(function(){Blu.fn.project.loadNewTweetsFromDb()},6E4))};Blu.fn.tweets.timerNewTweets_API=function(){Blu.config.tweets.getNew_API&&(Blu.timers.checkNewTweets_API=setInterval(function(){Blu.fn.project.grabNewTweets()},12E4))};
Blu.fn.tweets.timerOldTweets=function(){Blu.config.tweets.loadAllPrevious&&(Blu.timers.getOldTweets=setInterval(function(){if(!(1>Blu.tweets.length)&&Blu.timemachine.initialized){Blu.info("Premiers tweets charg\u00e9s");var a=Blu.tweets[Blu.tweets.length-1].id;Blu.info("Chargement anciens tweets");Blu.fn.tweets.load({tweetid_max:a,limit:0});clearInterval(Blu.timers.getOldTweets)}},200))};
Blu.fn.tweets.updateTweetDates=function(){!Blu.config.mapOnly&&Blu.config.tweets.prettyDate&&(Blu.fn.timers.resetInterval("updateTweetDates"),Blu.timers.updateTweetDates=setInterval(function(){$(".tweets-list .tweet-content .time a").each(function(){var a=$(this);a.text(Blu.fn.misc.prettyDate(new Date(a.data("date"))))})},45E3))};Blu.fn.tweets.getLastTweetId=function(){return 0<Blu.tweets.length&&Blu.tweets[0].id?Blu.tweets[0].id:0};Blu.fn.tweets.grab={};
Blu.fn.tweets.grabViaSearchAPI=function(a){a.url_params="?q="+encodeURIComponent(a.twQuery)+"&include_entities=1"+(a.since_id?"&since_id="+a.since_id:"")+(a.lang?"&lang="+a.lang:"")+"&rpp="+a.rpp+"&callback=?";a.url=a.url_base+a.url_params;Blu.info("Blu.fn.tweets.grabViaSearchAPI()");Blu.log(a);Blu.is.grabbingTweets=!0;a.showNotifications&&Blu.fn.UI.notification({message:"Loading tweets...",type:"info",id:"grabbing-tweets"});Blu.ajax=Blu.ajax||{};Blu.ajax.saveRequests=[];Blu.ajax.countSavedTweets=
0;Blu.fn.tweets.grabViaSearchAPI_request(a)};
Blu.fn.tweets.grabViaSearchAPI_request=function(a){Blu.log(a.url);$.ajax({url:a.url,dataType:"json",timeout:1E4,tryCount:0,retryLimit:3}).success(function(b,c){Blu.log("status XHR : "+c);b.results=b.results||[];b.next_page=b.next_page||"";a.tweets=a.tweets.concat(b.results);Blu.counts.tweets.alltime+=b.results.length;Blu.log(b);Blu.log("["+b.page+"] "+a.twQuery+" >> "+b.results.length+" tweets.");a.showNotifications&&Blu.fn.UI.notification({message:a.tweets.length+" tweets loaded...",type:"info",
id:"grabbing-tweets"});var d=""===b.next_page&&1==b.page&&b.results.length>0.9*a.rpp,e=(b.next_page||d)&&b.page<a.max_pages;d&&Blu.warn("Le param\u00e8tre next_page est vide (bug de l'API Twitter)");a.url=a.url_base;a.url+=!d?b.next_page+"&callback=?":a.url_params+"&page="+(b.page+1);Blu.fn.tweets.grab.save(a,b);e?Blu.fn.tweets.grabViaSearchAPI_request(a):(Blu.is.grabbingTweets=!1,Blu.fn.tweets.callbackAfterSearchAPI(a))}).error(function(b,c,d){Blu.warn("Probl\u00e8me avec la requ\u00eate \u00e0 la Search API.");
Blu.log("Text Status : "+c);Blu.log("xhr.status = "+b.status);Blu.warn(d);Blu.log(this);500==b.status&&Blu.warn("Il semble y avoir un probl\u00e8me du serveur (erreur 500), veuillez r\u00e9essayer plus tard.");this.tryCount++;this.tryCount<=this.retryLimit?(Blu.warn("On relance la requ\u00eate Ajax \u00e0 la Search API... ("+this.tryCount+"/"+this.retryLimit+")"),Blu.fn.tweets.grabViaSearchAPI_request(a)):Blu.warn("La requ\u00eate Ajax \u00e0 la Search API \u00e9t\u00e9 ex\u00e9cut\u00e9e "+this.retryLimit+
" fois et il y a toujours un probl\u00e8me... on arr\u00eate.")})};
Blu.fn.tweets.grab.save=function(a,b){var c=$.ajax({type:"POST",url:Blu.app.urls.ajax_base,data:{action:"save-tweets",project_id:Blu.projects.current.id,tweets:b.results},dataType:"json",timeout:3E4,tryCount:0,retryLimit:3,success:function(a,c,f){Blu.log("status XHR : "+c);f.isDone=!0;Blu.ajax.countSavedTweets+=b.results.length;Blu.info(b.results.length+" tweets sauvegard\u00e9s.")},error:function(a,c){Blu.warn("status XHR : error");if("timeout"===c)if(this.tryCount++,this.tryCount<=this.retryLimit){Blu.warn("On relance la requ\u00eate Ajax...");
var b=$.ajax(this);Blu.ajax.saveRequests.push(b);this.isDone=!0}else Blu.warn("La requ\u00eate Ajax \u00e9t\u00e9 ex\u00e9cut\u00e9e "+this.retryLimit+" fois et il y a toujours un probl\u00e8me... on arr\u00eate.");else 500==a.status?Blu.warn("Il semble y avoir un probl\u00e8me du serveur (erreur 500), veuillez r\u00e9essayer plus tard."):Blu.warn("Il y a un probl\u00e8me avec la requ\u00eate Ajax... :/")}});Blu.ajax.saveRequests.push(c)};
Blu.fn.tweets.callbackAfterSearchAPI=function(a){a.showNotifications&&Blu.fn.UI.notification({id:"grabbing-tweets",delayOut:1});Blu.info("Blu.fn.tweets.callbackAfterSearchAPI()");for(var b in a.tweets)a.tweets[b].isFromTwitterAPI=!0;Blu.fn.tweets.process.basic(a.tweets);Blu.tweets=Blu.tweets.concat(a.tweets);Blu.tweets.sort(Blu.fn.misc.sortLastTweets);Blu.timeline.params.filter.string="";Blu.fn.tweets.filter();a.backgroundTask||Blu.fn.tweets.showList();Blu.timers.waitingForTweets=setInterval(function(){Blu.fn.tweets.grab.waitingForTweets(a)},
100)};Blu.fn.tweets.grab.waitingForTweets=function(a){for(var b in Blu.ajax.saveRequests)if(!Blu.ajax.saveRequests[b].isDone){a.showNotifications&&Blu.fn.UI.notification({message:"Synchronizing tweets... ("+Blu.ajax.countSavedTweets+")",type:"info",id:"syncing-tweets"});return}Blu.log("Fin des requ\u00eates Twitter.");clearInterval(Blu.timers.waitingForTweets);a&&a.create_graph&&Blu.fn.project.createGraph(a)};
Blu.fn.project.createGraph=function(a){a=a||{};a.showNotifications&&Blu.fn.UI.notification({message:"Calculating graph...",id:"syncing-tweets"});Blu.fn.map.createGraph({},function(b){Blu.info("Graphe calcul\u00e9");b.graph&&(a.showNotifications&&Blu.fn.UI.notification({message:"Loading graph...",type:"ok",id:"syncing-tweets",delayOut:2}),Blu.app.getParams.chrono&&Blu.chrono&&(Blu.chrono["Create graph (stop)"]=new Date,Blu.fn.UI.popupWindow.open({title:"Temps de calcul",content:'<p class="align-right">R\u00e9cup\u00e9ration des tweets : '+
(Blu.chrono["Create graph (start)"]-Blu.chrono["Loading tweets (start)"])/1E3+"s<br/>Calcul du graphe : "+(Blu.chrono["Create graph (stop)"]-Blu.chrono["Create graph (start)"])/1E3+"s<br/>>> Temps total : "+(Blu.chrono["Create graph (stop)"]-Blu.chrono["Loading tweets (start)"])/1E3+"s</p>"})),a.backgroundTask?b.graph.filename?(Blu.fn.UI.showGraphNotif({html:'<a href="#">Refresh graph</a>',cssClass:"refresh"}),$("#graph-notif").find("a").data("graph",b.graph)):Blu.fn.UI.removeGraphNotif():Blu.fn.map.chargeGraphe(b.graph));
Blu.DOM.zc.spinStop()})};Blu.fn.project.grabTweetsViaSearchAPI=function(a){var b=Blu.projects.current,c={search:b.query,"search-user":"@"+b.twitter_screen_name+" OR from:"+b.twitter_screen_name};"search"!==b.type&&"search-user"!==b.type||(a=$.extend({since_id:0,rpp:100,dataset:"global",twQuery:c[b.type],page:1,lang:"",max_pages:Blu.config.tweets.max_pages,url_base:"http://search.twitter.com/search.json",tweets:[],create_graph:!1,showNotifications:!0,backgroundTask:!1},a||{}),Blu.fn.tweets.grabViaSearchAPI(a))};
Blu.fn.project.grabNewTweets=function(a){if(Blu.projects.current)if(Blu.is.grabbingTweets)Blu.fn.UI.notification({message:"Bluenod is loading your tweets, please wait... :)",type:"warning",delayOut:5});else if(("search"===Blu.projects.current.type||"search-user"===Blu.projects.current.type)&&Blu.config.tweets.grabClientSide)Blu.fn.project.grabTweetsViaSearchAPI({since_id:Blu.fn.tweets.getLastTweetId(),create_graph:!0});else{var b=Blu.fn.project.ajaxParams();Blu.app.getParams.limitTweets&&(b.limitTweets=
Blu.app.getParams.limitTweets,Blu.chrono={},Blu.chrono["Loading tweets (start)"]=new Date);a.showNotifications&&Blu.fn.UI.notification({message:"Loading tweets...",type:"info",id:"grab-tweets"});$.getJSON(Blu.app.urls.main+"/projects/refresh-tweets",b,function(c){if(c.success)if(a.showNotifications&&Blu.fn.UI.notification({message:c.message,type:"ok",id:"grab-tweets",delayOut:4}),0<c.count_new_tweets){if(Blu.fn.project.loadNewTweetsFromDb(),!Blu.graphs.current.filename||a.create_graph)Blu.chrono["Create graph (start)"]=
new Date,Blu.fn.project.createGraph(a)}else Blu.fn.UI.showCanvasScreen({error:!0,no_tweets:!0});else a.showNotifications&&Blu.fn.UI.notification({message:c.message,type:"fail",id:"grab-tweets",delayOut:8})})}else Blu.fn.UI.notification({message:"Please create a project.",type:"fail",delayOut:5})};Blu.fn.project.loadNewTweetsFromDb=function(){var a=0;0<Blu.tweets.length&&Blu.tweets[0].id&&(a=Blu.tweets[0].id);0<Blu.newTweets.length&&Blu.newTweets[0].id&&(a=Blu.newTweets[0].id);Blu.fn.tweets.load({tweetid_min:a})};
Blu.fn.tweets.load=function(a){if(!Blu.config.mapOnly){a=a||{};a.tweetid_min=a.tweetid_min||0;a.tweetid_max=a.tweetid_max||0;a.time_max=a.time_max||0;a.limit="undefined"!==typeof a.limit?a.limit:Blu.config.tweets.loadLimit;a.show="undefined"!==typeof a.show?a.show:!1;Blu.info("Blu.fn.tweets.load() with params = ");Blu.log(a);Blu.is.loadingTweets=!0;var b=Blu.fn.project.ajaxParams();b.action="list-some-tweets";b.params=a;$.getJSON(Blu.app.urls.ajax_base,b,function(c){Blu.has.loadedTweets=!0;$(".tweets-list").spinStop();
if(c&&c.tweets&&!(1>c.tweets.length)){var b=1>Blu.tweets.length;b&&(Blu.counts.tweets.alltime=parseInt(c.count_all_tweets,10),Blu.counts.tweets.filter=parseInt(c.count_all_tweets,10));Blu.fn.tweets.process.basic(c.tweets);Blu.intervals.push({min:{id:c.tweets[c.tweets.length-1].id,date:c.tweets[c.tweets.length-1].created_at,date_utc:c.tweets[c.tweets.length-1].created_at_utc},max:{id:c.tweets[0].id,date:c.tweets[0].created_at,date_utc:c.tweets[0].created_at_utc}});Blu.fn.tweets.mergeIntervals();b?
Blu.tweets=c.tweets:(a.tweetid_min&&Blu.fn.tweets.process.newTweets(c),(a.tweetid_max||a.time_max)&&Blu.fn.tweets.process.oldTweets(c));Blu.fn.users.fillAll(c.tweets);Blu.timeline.params.filter.string="";Blu.fn.tweets.filter();(a.show||b)&&Blu.fn.tweets.showList()}Blu.is.loadingTweets=!1})}};Blu.fn.tweets.process={};Blu.fn.tweets.process.basic=function(a){for(var b in a)Blu.fn.tweet.process(a[b])};
Blu.fn.tweet.process=function(a){if(a.isReady)return a;a.dateObj=a.id_str?new Date(a.created_at):a.created_at_utc?Blu.fn.misc.dateStringToObject(a.created_at_utc,0):Blu.fn.misc.dateStringToObject(a.created_at);if("undefined"!=typeof a.texte_date){var b=new Date(1E3*a.seconds);a.texte_date=Blu.fn.misc.texteJour(b)+" "+Blu.fn.misc.texteHeure(b)}a.id_str&&(a.id=a.id_str);a.isReady=!0;return a};
Blu.fn.tweets.process.newTweets=function(a){Blu.newTweets=a.tweets.concat(Blu.newTweets);Blu.fn.tweets.process.basic(Blu.newTweets);Blu.fn.UI.notifNewTweets()};
Blu.fn.UI.notifNewTweets=function(){var a=Blu.newTweets.length;if(a&&!Blu.timeline.params.filter.string&&!$(".profile-info .profile-image-aside").length){var a=1<a?Blu.txt("notifNewTweets",a):Blu.txt("notifNewTweet"),b=$("#panels .panel.tweets .tweets-list"),c=b.find(".new-tweets");c.length?c.html('<a href="#">'+a+"</a>"):b.prepend('<li class="new-tweets"><a href="#">'+a+"</a></li>")}};
Blu.fn.tweets.process.oldTweets=function(a){var b=[],c,d,e;for(d in Blu.tweets){c=!1;for(e in b)Blu.tweets[d].id==b[e]&&(c=!0);c||b.push(Blu.tweets[d].id)}for(d in a.tweets){c=!1;for(e in b)a.tweets[d].id==b[e]&&(c=!0);c||Blu.tweets.push(a.tweets[d])}};
Blu.fn.tweets.showNewTweets=function(){var a=$("#panels .panel.tweets .tweets-list").find(".new-tweets");Blu.counts.tweets.alltime=parseInt(Blu.counts.tweets.alltime,10)+Blu.newTweets.length;Blu.tweets=Blu.newTweets.concat(Blu.tweets);Blu.newTweets=[];a.length&&a.remove();Blu.timeline.params.filter.dates.max=new Date;Blu.fn.tweets.filter();Blu.fn.tweets.showList();Blu.config.clientMode&&$("#refreshTweets").show()};
Blu.fn.timestamps.load=function(){Blu.needs.timestamps&&(Blu.warn("Initializing timestamps..."),Blu.fn.timers.resetInterval("loadTimestamps"),Blu.timers.loadTimestamps=setInterval(function(){if(!Blu.needs.lastGraph||Blu.has.loadedGraph)Blu.fn.timers.resetInterval("loadTimestamps"),Blu.fn.timestamps.getAll()},100))};
Blu.fn.timemachine.load=function(){Blu.config.timemachine.activated?(Blu.warn("Initializing Time Machine..."),Blu.timemachine.initialized=!1,Blu.fn.timemachine.initInterface(),Blu.fn.timers.resetInterval("initTM"),Blu.timers.initTM=setInterval(function(){Blu.needs.timestamps&&!Blu.has.loadedTimestamps||(!Blu.has.loadedTweets||Blu.needs.allGraphs&&!Blu.has.loadedAllGraphs)||(Blu.fn.timers.resetInterval("initTM"),Blu.fn.timemachine.init(),Blu.info("Time Machine is now initialized."),Blu.fn.timemachine.currentGraphCursor(),
Blu.config.timemachine.hasArchive&&("archive"===Blu.timeNav.mode&&!Blu.config.timeNavGlobal)&&Blu.fn.timemachine.createAllGraphCursors(),Blu.fn.timemachine.trace())},100)):Blu.warn("Time Machine not activated.")};Blu.fn.timemachine.init=function(){Blu.log("timemachine.init()");Blu.fn.timeline.traceTimeline();Blu.timeline.cursors=[];Blu.fn.timemachine.trace();Blu.timemachine.initialized=!0;$("#time-machine").spinStop()};
Blu.fn.timemachine.initInterface=function(){if(Blu.config.timeline.autoWidth){var a=Blu.DOM.gHeader.find(".count-tweets-alltime"),a=Blu.DOM.gHeader.width()-a.outerWidth();Blu.timeline.mini.width=a-2*Blu.DOM.tmSideLeft.outerWidth()}Blu.DOM.tmZone.css({width:Blu.timeline.mini.width+2*Blu.DOM.tmSideLeft.outerWidth()+"px"});Blu.DOM.tmZone.show();Blu.DOM.miniTimeline.attr({width:Blu.timeline.mini.width,height:Blu.timeline.mini.height});Blu.DOM.tm.css({width:Blu.timeline.mini.width+"px",height:Blu.timeline.mini.height+
"px"});Blu.DOM.tm.mouseout(Blu.fn.timemachine.displayTip)};Blu.fn.timemachine.setCursor=function(a,b,c){b={time:b,timeBegin:c||0,id:a,isHovered:!1};"graph"===a?(Blu.timeline.cursors.graphs||(Blu.timeline.cursors.graphs=[]),Blu.timeline.cursors.graphs.push(b)):Blu.timeline.cursors[a]=b};Blu.fn.timemachine.deleteCursor=function(a){Blu.timeline.cursors&&"undefined"!==typeof Blu.timeline.cursors[a]&&delete Blu.timeline.cursors[a]};
Blu.fn.timemachine.createAllGraphCursors=function(){for(var a in Blu.graphs.all){var b=Blu.graphs.all[a],c=b.datesObj.max.getTime()/1E3,b=b.datesObj.min.getTime()/1E3;Blu.fn.timemachine.setCursor("graph",c,b)}};
Blu.fn.timemachine.currentGraphCursor=function(){var a=Blu.graphs.current;if(a){var b=a.datesObj.min,a=a.datesObj.max,c=Blu.fn.misc.dateStringToObject(Blu.projects.current.dates.max,0);a.getTime()>c.getTime()&&0<c.getTime()&&(a=c);Blu.fn.timemachine.setCursor("current",a.getTime()/1E3,b.getTime()/1E3)}};
Blu.fn.timemachine.renderCursor=function(a){var b=Blu.canvas_timemachine.ctx,c,d,e=Blu.DOM.tmTitle.find(".timetravel"),f=Blu.DOM.tmTitle.find(".graph.min"),g=Blu.DOM.tmTitle.find(".graph.max");c=Blu.fn.timeline.timeToX(a.time,!0);d=a.timeBegin?Blu.fn.timeline.timeToX(a.timeBegin,!0):-10;Blu.fn.timemachine.displayDate();Blu.DOM.tm.css("cursor","default");switch(a.id){case "current":if(Blu.config.timeline.style.plotWave)break;b.strokeStyle=Blu.timemachine.colors.currentTime;b.lineWidth=2;b.beginPath();
b.moveTo(c,-10);b.lineTo(c,Blu.timeline.mini.height+10);b.closePath();b.stroke();g.css({left:Math.max(0,c-g.outerWidth())});Blu.config.timeline.style.cursorBegin&&(b.beginPath(),b.moveTo(d,-10),b.lineTo(d,Blu.timeline.mini.height+10),b.closePath(),b.stroke(),f.css({left:Math.max(0,d-f.outerWidth())}));break;case "timetravel":Blu.timeline.cursors.graphs||(b.strokeStyle=Blu.timemachine.colors.timeTravel,b.lineWidth=1,b.beginPath(),b.moveTo(c,-10),b.lineTo(c,Blu.timeline.mini.height+10),b.closePath(),
b.stroke(),e.css({left:Math.max(0,c-e.outerWidth())}).show());break;case "graph":b.strokeStyle=a.isHovered?Blu.timemachine.colors.graphHover:Blu.timemachine.colors.graph,b.lineWidth=1,a.isHovered?(b.beginPath(),b.dashedLineTo(c,-10,c,Blu.timeline.mini.height+10,[2,3]),b.closePath(),b.stroke(),b.beginPath(),b.dashedLineTo(d,-10,d,Blu.timeline.mini.height+10,[2,3]),b.closePath(),b.stroke(),Blu.DOM.tm.css("cursor","pointer")):(b.beginPath(),b.dashedLineTo(c,-10,c,Blu.timeline.mini.height+10,[2,3]),b.closePath(),
b.stroke()),b.closePath(),b.stroke()}};Blu.fn.canvas.setPixel=function(a,b,c,d,e,f,g){b=4*(b+c*a.width);a.data[b+0]=d;a.data[b+1]=e;a.data[b+2]=f;a.data[b+3]=g};Blu.fn.canvas.grayscale=function(a){for(var b=a.data,c=0;c<b.length;c+=4)b[c]=b[c+1]=b[c+2]=0.2126*b[c]+0.7152*b[c+1]+0.0722*b[c+2];return a};
Blu.fn.timemachine.renderBackgrounds=function(){if("undefined"!==typeof Blu.timeline.cursors){var a=Blu.canvas_timemachine.ctx,b=Blu.timeline.cursors.current,c,d;c=-10;a.fillStyle=Blu.config.timeline.style.bgNotSelected;if(Blu.timeline.cursors.graphs)for(var e in Blu.timeline.cursors.graphs)c=Blu.timeline.cursors.graphs[e],c.hasBG=!(c.isHovered||c.timeBegin==b.timeBegin&&c.time==b.time),c.hasBG&&(d=Blu.fn.timeline.timeToX(c.time,!0),c=c.timeBegin?Blu.fn.timeline.timeToX(c.timeBegin,!0):-10,a.beginPath(),
a.moveTo(d,-10),a.lineTo(d,Blu.timeline.mini.height+10),a.lineTo(c,Blu.timeline.mini.height+10),a.lineTo(c,-10),a.closePath(),a.fill());else b&&(d=Blu.fn.timeline.timeToX(b.timeBegin,!0),b=Blu.fn.timeline.timeToX(b.time,!0),Blu.config.timeline.style.plotWave?(0<d&&(d=a.getImageData(0,0,d,Blu.timeline.mini.height+10),d=Blu.fn.canvas.grayscale(d),a.putImageData(d,0,0)),d=a.getImageData(b,0,Blu.timeline.mini.width+10,Blu.timeline.mini.height+10),d=Blu.fn.canvas.grayscale(d),a.putImageData(d,b,0)):(a.beginPath(),
a.moveTo(d,-10),a.lineTo(d,Blu.timeline.mini.height+10),a.lineTo(-10,Blu.timeline.mini.height+10),a.lineTo(-10,-10),a.closePath(),a.fill(),a.beginPath(),a.moveTo(b,-10),a.lineTo(b,Blu.timeline.mini.height+10),a.lineTo(Blu.timeline.mini.width+10,Blu.timeline.mini.height+10),a.lineTo(Blu.timeline.mini.width+10,-10),a.closePath(),a.fill()))}};
Blu.fn.timemachine.renderCursors=function(){var a;if(Blu.timeline.cursors.graphs)for(var b in Blu.timeline.cursors.graphs)a=Blu.timeline.cursors.graphs[b],Blu.fn.timemachine.renderCursor(a);for(b in Blu.timeline.cursors)a=Blu.timeline.cursors[b],"graphs"!==b&&Blu.fn.timemachine.renderCursor(a)};
Blu.fn.timemachine.trace=function(){"undefined"===typeof Blu.canvas_mini.timeline.image||!Blu.canvas_mini.timeline.image?Blu.warn("Blu.canvas_mini.timeline.image est vide"):(Blu.canvas_timemachine.ctx.putImageData(Blu.canvas_mini.timeline.image,0,0),Blu.fn.timemachine.renderBackgrounds(),Blu.fn.timemachine.renderCursors())};
Blu.fn.timemachine.hoverCursors=function(a){a=Math.round(Blu.fn.timeline.xToTime(a.x-Blu.DOM.miniTimeline.offset().left,!0));Blu.fn.timemachine.setCursor("timetravel",a);if(Blu.timeline.cursors.graphs)for(var b in Blu.timeline.cursors.graphs){var c=Blu.timeline.cursors.graphs[b];c.isHovered=a>=c.timeBegin&&a<c.time}};
Blu.fn.timemachine.mouseMove=function(a){a={x:a.pageX,y:a.pageY};var b=-Blu.timeline.miniScale;Blu.mouse.dragOn&&(Blu.mouse.dragPx.x+=(Blu.mouse.lastPos.x-a.x)/b,Blu.mouse.dragPx.y+=(Blu.mouse.lastPos.y-a.y)/b,Blu.mouse.lastPos=a);Blu.fn.timemachine.hoverCursors(a);Blu.fn.timemachine.trace();Blu.fn.timemachine.displayDate()};Blu.fn.timeNav={};
Blu.fn.timeNav.createHtml=function(){var a=$("#time-nav"),b="";if(0==a.length){Blu.DOM.zc.before('<div id="time-nav"></div>');a=$("#time-nav");Blu.timeNav={mode:Blu.config.timemachine.hasArchive?"archive":"live",interval:Blu.config.timeNavGlobal?"custom":"1day",dates:{min:"",max:""},datesObj:{min:"",max:""}};var c=new Date,d=Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.max,0),d=d<c?d:c,c=new Date(d.getFullYear(),d.getMonth(),d.getDate()-1);Blu.fn.timeNav.calcNewDates(d);Blu.projects.current.dates=
Blu.timeNav.dates;b+='<a id="datepicker" class="glyph general" href="#calendar" title="Calendar">i</a><div id="calendar"></div><ul id="time-prev-next"><li><a class="prev" href="#prev" title="Previous day"><span></span></a></li><li><a class="next" href="#next" title="Next day"><span></span></a></li></ul><span class="title"></span>';a.css("top",Blu.DOM.zc.css("top"));a.html(b);Blu.DOM.zc.animate({top:"+="+a.height()+"px"},"slow");a=$("#calendar");a.datepicker({dateFormat:"yy-mm-dd",firstDay:1,onSelect:Blu.fn.timeNav.calendarSelect,
hideIfNoPrevNext:!0});a.datepicker("option","minDate",Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.min,0));a.datepicker("option","maxDate",c);Blu.fn.timeNav.updateHtml()}};
Blu.fn.timeNav.updateHtml=function(){var a=$("#time-nav"),b=a.find("#time-prev-next"),c=b.find("a.prev"),d=b.find("a.next"),e=a.find("#time-interval"),b=b.next(".title"),f=$("#calendar");if(0!=a.length){if(Blu.timeNav.interval){c.removeClass("deactivated");d.removeClass("deactivated");var a=Blu.timeNav.datesObj.min,g=Blu.timeNav.datesObj.max,a=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1),g=new Date(g.getFullYear(),g.getMonth(),g.getDate()+1),h=Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.min,
0),j=Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.max,0);a.getTime()<h.getTime()&&c.addClass("deactivated");g.getTime()>j.getTime()&&d.addClass("deactivated")}else c.addClass("deactivated"),d.addClass("deactivated"),e.find("a.live").addClass("selected");"live"!==Blu.timeNav.mode&&"archive"===Blu.timeNav.mode&&e.find("a.archive-"+Blu.timeNav.interval).addClass("selected");Blu.timeNav.datesObj.min&&(b.text(Blu.fn.misc.dateToTextDate(Blu.timeNav.datesObj.min)),c={"1hour":"min","1day":"min",
"1week":"day","1month":"day"}[Blu.timeNav.interval],c=Blu.fn.misc.dateObjectToString(Blu.timeNav.datesObj.min,c)+" to "+Blu.fn.misc.dateObjectToString(Blu.timeNav.datesObj.max,c),b.attr("title",c),f.datepicker("setDate",Blu.fn.misc.dateObjectToString(Blu.timeNav.datesObj.min,"day")))}};
Blu.fn.timeNav.calcDates=function(a,b){var c,d;c="undefined"===typeof b?-1:b;"string"===typeof a&&(a=Blu.fn.misc.dateStringToObject(a));switch(Blu.timeNav.interval){case "custom":c=Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.min,0);d=Blu.fn.misc.dateStringToObject(Blu.projects.current.datesTotal.max,0);break;case "1hour":c=new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours()+c);d=new Date(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours()+1);break;case "1day":c=new Date(a.getFullYear(),
a.getMonth(),a.getDate()+c);d=new Date(c.getFullYear(),c.getMonth(),c.getDate()+1);break;case "1week":c=a.getDate()+7*c-a.getDay()+1+(0==a.getDay()?-7:0);c=new Date(a.getFullYear(),a.getMonth(),c);d=new Date(c.getFullYear(),c.getMonth(),c.getDate()+7);break;default:return!1}return{min:c,max:d}};
Blu.fn.timeNav.calcNewDates=function(a,b){Blu.timeNav.dates={min:"",max:""};Blu.timeNav.datesObj={min:"",max:""};var c=Blu.fn.timeNav.calcDates(a,b);c&&(Blu.timeNav.datesObj={min:c.min,max:c.max},Blu.timeNav.dates={min:Blu.fn.misc.dateObjectToString(c.min),max:Blu.fn.misc.dateObjectToString(_dshates.max)})};
Blu.fn.timeNav.calendarSelect=function(a){var b=$("#datepicker"),c=$("#calendar");if(a<Blu.projects.current.datesTotal.min.substr(0,10)||a>Blu.projects.current.datesTotal.max.substr(0,10)){Blu.warn(a+" is not in [ "+Blu.projects.current.datesTotal.min+" , "+Blu.projects.current.datesTotal.max+" ]");c.append('<p class="notif-calendar">Sorry, no data here.</p>').fadeIn();var d=$(".notif-calendar");setTimeout(function(){d.fadeOut("slow",function(){d.remove()})},3E3);return!1}c.hide();b.removeClass("selected");
Blu.timeNav.interval="1day";Blu.fn.timeNav.loadFromDate(Blu.fn.misc.dateStringToObject(a));Blu.fn.timeNav.updateHtml();c.datepicker("setDate",a);return!1};Blu.fn.timeNav.loadFromDate=function(a,b){Blu.info("Blu.fn.timeNav.loadFromDate()");Blu.fn.timeNav.calcNewDates(a,b);if(!Blu.timeNav.dates.min)return!1;Blu.fn.timeNav.updateHtml();Blu.projects.current.dates=Blu.timeNav.dates;Blu.fn.project.loadCurrent();return!0};
Blu.fn.timeNav.events=function(){Blu.config.timeNavigation&&($("#calendar"),$("#datepicker").live("click",function(){var a=$("#calendar");$(this).toggleClass("selected");a.toggle();return!1}),$("#time-interval a").live("click",function(){var a=$(this),b=a.data("mode"),c=a.data("interval");a.parents("ul").find("a").removeClass("selected");a.addClass("selected");Blu.timeNav.mode=b;Blu.timeNav.interval=c;"live"===b?(Blu.fn.project.getLastGraph(),Blu.fn.timeNav.updateHtml()):"archive"===b&&Blu.fn.timeNav.loadFromDate(new Date);
return!1}),$("#time-prev-next a").live("click",function(){var a=$(this);if(a.hasClass("deactivated"))return!1;var b=Blu.fn.misc.dateStringToObject(Blu.timeNav.dates.min),a=a.hasClass("prev")?-1:1;Blu.fn.timeNav.loadFromDate(b,a);return!1}),$("#time-nav-selector").live("click",function(){var a=$(this),b=$("#list-days");a.toggleClass("selected");b.toggle();return!1}),$("#zonecentre, #barre, .panel").click(function(){var a=$("#datepicker");$("#calendar").hide();a.removeClass("selected")}),$("#list-days a").live("click",
function(){var a=$(this),b=$("#list-days"),c=$("#time-nav-selector");b.find("a").removeClass("selected");a.addClass("selected");c.removeClass("selected");b.hide();c.find(".title").text(a.text());b=Blu.fn.misc.dateStringToObject(a.data("day"));b.setTime(b.getTime()+864E5);c=b.getMonth()+1;b=b.getFullYear()+"-"+(10>c?"0"+c:c)+"-"+b.getDate();Blu.projects.current.dates={min:a.data("day"),max:b};Blu.fn.project.loadCurrent();return!1}))};
Blu.fn.tweets.search=function(a,b,c){Blu.info("tweets.search > "+a);var d=Blu.timeline.params.filter,e=null!==d.dates.min||null!==d.dates.max;if(a!==d.string||e||"boolean"===typeof c&&c)Blu.is.tweetsSearchFinished=!1,d.string=a,Blu.fn.tweets.filter(),Blu.fn.tweets.showList(),Blu.DOM.findUser.val(a),Blu.fn.tranches.updateCounts(),b&&Blu.fn.map.selectUser(d.string)};
Blu.fn.tweets.filter=function(){var a=Blu.timeline.params.filter,b=Blu.fn.tweets.regexFilter(),c=null!==a.dates.min&&0<a.dates.min.getTime()||null!==a.dates.max&&0<a.dates.max.getTime(),d=0,e,f,g,h;Blu.info("Blu.fn.tweets.filter...");for(var j in Blu.tweets)e=Blu.tweets[j],f=h=!0,b&&b.from_user&&(f=-1<e.from_user.search(b.from_user),g=-1<e.text.search(b.text),f=f||g),c&&(h=e.dateObj.getTime()>=a.dates.min.getTime()&&e.dateObj.getTime()<a.dates.max.getTime()),e.matchFilter=f&&h,e.matchFilter&&d++;
Blu.warn("Filtered tweets: "+d+" / "+Blu.tweets.length);Blu.counts.tweets.filter=d;Blu.fn.UI.miniStats({countTweets:Blu.counts.tweets.filter,countUsers:Blu.counts.users.graph});Blu.fn.users.topUsers()};Blu.fn.tweets.regexFilter=function(a){"undefined"===typeof a&&(a=Blu.timeline.params.filter.string);var b;if(""===a)return null;b=RegExp("("+a.replace(/([^0-9a-zA-Z ])/g,"\\$1")+")","gi");return{from_user:"@"===a[0]?RegExp("("+a.substr(1).replace(/([^0-9a-zA-Z ])/g,"\\$1")+")","gi"):b,text:b}};
Blu.fn.tweets.find=function(a){Blu.info("Blu.fn.tweets.find()");a=$.extend({id:"",string:Blu.timeline.params.filter.string,dates:Blu.timeline.params.filter.dates},a);Blu.log(a);var b,c=[],d=Blu.fn.tweets.regexFilter(a.string),e=null!==a.dates.min&&0<a.dates.min.getTime()||null!==a.dates.max&&0<a.dates.max.getTime(),f,g,h;for(h in Blu.tweets)b=Blu.tweets[h],g=d&&d.from_user?-1<b.from_user.search(d.from_user)||-1<b.text.search(d.text):!0,f=e?b.dateObj.getTime()>=a.dates.min.getTime()&&b.dateObj.getTime()<
a.dates.max.getTime():!0,(f=g&&f&&(a.id?a.id==b.id:!0))&&c.push(b);Blu.log(c.length+" tweet(s) trouv\u00e9(s)");return c};
Blu.fn.UI.updateSize=function(){$("#barre").height();Blu.zoneGraphe.largeur=Blu.DOM.zc.width();Blu.zoneGraphe.hauteur=Blu.DOM.zc.height();Blu.map.isIdentical=!0;for(var a in Blu.zoneGraphe)Blu.map.isIdentical=Blu.map.isIdentical&&Blu.zoneGraphe[a]==Blu.oldZoneGraphe[a];if(!Blu.map.isIdentical)for(a in Blu.DOM.canvas.attr({width:Blu.zoneGraphe.largeur,height:Blu.zoneGraphe.hauteur}).css({width:Blu.zoneGraphe.largeur+"px",height:Blu.zoneGraphe.hauteur+"px"}),Blu.zoneGraphe)Blu.oldZoneGraphe[a]=Blu.zoneGraphe[a]};
Blu.fn.misc.filenameToDate=function(a){var b;if(b=a.match(/[a-z]+.[\w]+.(.*).json/))a=b[1];a=a.match(/\d+/g).concat([0,0,0,0,0,0]);return a[0]+"-"+a[1]+"-"+a[2]+" "+a[3]+":"+a[4]};Blu.fn.misc.dateToTime=function(a){var b;if(b=a.match(/[a-z]+.[\w]+.(.*).json/))a=b[1];a=a.match(/\d+/g).concat([0,0,0,0,0,0]);return Math.round((new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])).getTime()/1E3)};
Blu.fn.misc.filenameToTimes=function(a){var b;if(b=a.match(/[a-z]+.[\w_-]+.(.*).json/))a=b[1];if(""===a)return{timeMin:0,timeMax:0};a=a.split(",");b=2==a.length?a[1]:a[0];return{timeMin:Blu.fn.misc.dateToTime(2==a.length?a[0]:Blu.projects.current.dates.min)+3600*Blu.projects.current.dates.timeOffset,timeMax:Blu.fn.misc.dateToTime(b)+3600*Blu.projects.current.dates.timeOffset}};
Blu.fn.misc.timeToDate=function(a){var b=new Date;b.setTime(1E3*a);a=10>b.getMonth()+1?"0"+(b.getMonth()+1):b.getMonth()+1;var c=10>b.getDate()?"0"+b.getDate():b.getDate(),d=10>b.getHours()?"0"+b.getHours():b.getHours(),e=10>b.getMinutes()?"0"+b.getMinutes():b.getMinutes();return Blu.txt("date_hhmm",c,a,b.getFullYear(),d,e)};
Blu.fn.misc.dateObjectToString=function(a,b){var c={year:a.getFullYear(),month:10>a.getMonth()+1?"0"+(a.getMonth()+1):a.getMonth()+1,day:10>a.getDate()?"0"+a.getDate():a.getDate(),hour:10>a.getHours()?"0"+a.getHours():a.getHours(),min:10>a.getMinutes()?"0"+a.getMinutes():a.getMinutes(),sec:10>a.getSeconds()?"0"+a.getSeconds():a.getSeconds(),ms:100<=a.getMilliseconds()?a.getMilliseconds():10<=a.getMilliseconds()?"0"+a.getMilliseconds():"00"+a.getMilliseconds()},d="",e="week"===b?"day":b||"sec",f=[{interval:"year",
separator:""},{interval:"month",separator:"-"},{interval:"day",separator:"-"},{interval:"hour",separator:" "},{interval:"min",separator:":"},{interval:"sec",separator:":"},{interval:"ms",separator:":"}],g;for(g in f){var h=f[g].interval,d=d+(f[g].separator+c[h]);if(h==e)break}return d};Blu.fn.misc.dateStringToObject=function(a,b){if(!a)return new Date(0);var c=a.match(/\d+/g).concat([0,0,0,0,0,0]);return new Date(Date.UTC(c[0],c[1]-1,c[2],c[3]-("undefined"===typeof b?1:b),c[4],c[5]))};
Blu.fn.misc.timeToDate2=function(a,b){var c=new Date;c.setTime(1E3*a);var d=Blu.fn.misc.monthName(c,"undefined"===typeof b?!0:b),e=10>c.getDate()?"0"+c.getDate():c.getDate(),f=10>c.getHours()?"0"+c.getHours():c.getHours(),g=10>c.getMinutes()?"0"+c.getMinutes():c.getMinutes();return Blu.txt("date_hhmm2",e,d,c.getFullYear(),f,g)};
Blu.fn.misc.dateToTextDate=function(a){a="string"===typeof a?Blu.fn.misc.dateStringToObject(a):a;var b=a.getDate(),c=Blu.txt("days")[a.getDay()],d=Blu.fn.misc.monthName(a);return Blu.txt("date_text",b,d,a.getFullYear(),c)};Blu.fn.misc.dateHour=function(a){var b="string"===typeof a?Blu.fn.misc.dateStringToObject(a):"number"===typeof a?new Date(a):a;a=10>b.getHours()?"0"+b.getHours():b.getHours();b=10>b.getMinutes()?"0"+b.getMinutes():b.getMinutes();return a+":"+b};
Blu.fn.misc.timeNow=function(){return(new Date).toTimeString().slice(0,8)};Blu.fn.misc.timeHour=function(a){return a.toTimeString().slice(0,8)};
Blu.fn.misc.prettyDate=function(a,b){b="undefined"===typeof b?!1:b;if(!Blu.config.tweets.prettyDate)return a;var c="string"===typeof a?Blu.fn.misc.dateStringToObject(a):a,d=c.getDate(),e=Blu.txt("days")[c.getDay()],f=10>c.getHours()?"0"+c.getHours():c.getHours(),g=10>c.getMinutes()?"0"+c.getMinutes():c.getMinutes(),h=new Date;h.getDate();var h=(h.getTime()-c.getTime())/1E3,j=Math.floor(h/86400);return isNaN(j)||0>j||31<=j?Blu.fn.misc.timeToDate(c.getTime()/1E3):0==j&&(10>h&&Blu.txt("just_now")||60>
h&&Blu.txt("x_seconds_ago",Math.floor(h))||120>h&&Blu.txt("1_minute_ago")||3600>h&&Blu.txt("x_minutes_ago",Math.floor(h/60))||7200>h&&Blu.txt("1_hour_ago")||86400>h&&Blu.txt("x_hours_ago",Math.floor(h/3600)))||1>=j&&Blu.txt("yesterday")||7>j&&(b?Blu.txt("x_days_ago",j):Blu.txt("day_with_hour",e,d,f,g))||31>j&&Blu.txt("day_with_hour",e,d,f,g)};Blu.fn.misc.isInt=function(a){return parseFloat(a)==parseInt(a)&&!isNaN(a)?!0:!1};
Blu.fn.timeline.timeToX=function(a,b){return!0==("undefined"!==typeof b?b:!1)?Blu.timeline.decalageXMini+a*Blu.timeline.miniScale:Blu.timeline.decalageX+a*Blu.timeline.scale};Blu.fn.timeline.xToTime=function(a,b){return!0==("undefined"!==typeof b?b:!1)?(a-Blu.timeline.decalageXMini)/Blu.timeline.miniScale:(a-Blu.timeline.decalageX)/Blu.timeline.scale};
Blu.fn.timeline.traceTimeline=function(a,b,c){Blu.info("Blu.fn.timeline.traceTimeline...");a="undefined"!==typeof a?a:!1;b="undefined"!==typeof b?b:!0;var d="undefined"!==typeof c?c:!0;c=Blu.canvas.ctx;var e=a?Blu.canvas_mini.ctx:Blu.canvas_timemachine.ctx;Blu.fn.UI.updateSize();Blu.fn.timemachine.displayDate();if(1>Blu.tranches.length)e.clearRect(0,0,Blu.timeline.mini.width,Blu.timeline.mini.height);else{var d=Blu.map.isIdentical&&!d,f;for(f in Blu.timeline.params)d=d&&Blu.timeline.params[f]===Blu.timeline.oldParams[f];
if(!d){for(f in Blu.timeline.params)Blu.timeline.oldParams[f]=Blu.timeline.params[f];Blu.timeline.timeInterval=Blu.tranches[Blu.tranches.length-1].fin-Blu.tranches[0].debut;Blu.timeline.largeurTotale=Math.pow(Math.SQRT2,Blu.timeline.params.zoomLevel)*Blu.timeline.width;Blu.timeline.scale=Blu.timeline.largeurTotale/Blu.timeline.timeInterval;Blu.timeline.miniScale=Blu.timeline.mini.width/Blu.timeline.timeInterval;Blu.timeline.decalageX=Blu.zoneGraphe.largeur/2-Blu.timeline.params.centreX*Blu.timeline.scale;
Blu.timeline.decalageXMini=-(Blu.timeline.miniScale*Blu.tranches[0].debut);Blu.timeline.largeurTranche=Blu.timeline.scale*Blu.timeline.params.granularite;Blu.timeline.largeurTrancheMini=Blu.timeline.miniScale*Blu.timeline.params.granularite;Blu.timeline.limGauche=Blu.fn.timeline.timeToX(Blu.tranches[0].debut);Blu.timeline.initialise=!0;Blu.timeline.hauteurGraphe=Blu.zoneGraphe.hauteur-120;Blu.timeline.decalageY=35;Blu.timeline.echelleY=Blu.timeline.hauteurGraphe/Math.max(1,Blu.timeline.maxTweets);
Blu.timeline.echelleYMiniature=Blu.timeline.mini.height/Math.max(1,Blu.timeline.maxTweets);Blu.timeline.echelleRGB=255/Math.max(1,Blu.timeline.maxTweets);a&&c.clearRect(0,0,Blu.zoneGraphe.largeur,Blu.zoneGraphe.hauteur);b&&e.clearRect(0,0,Blu.timeline.mini.width,Blu.timeline.mini.height);if(a)for(f in c.textBaseline="middle",c.font="14px Arial",c.textAlign="center",Blu.jours)c.fillStyle=f%2?"transparent":"rgba(240,240,240,.25)",d=Blu.fn.timeline.timeToX(Blu.jours[f].debut),Blu.fn.timeline.timeToX(Blu.jours[f].fin),
c.fillStyle="#888";var g=[2,5,10,20,50,100,200,500,1E3],d=1,h=Blu.timeline.maxTweets/3,j;for(j in g)Math.abs(h-g[j])<Math.abs(h-d)&&(d=g[j]);if(a){c.font="12px Arial";c.textAlign="right";c.strokeStyle="#aaa";c.lineWidth="0.5";c.beginPath();for(f=0;f<=Blu.timeline.maxTweets;f+=d)j=Blu.timeline.decalageY+Blu.timeline.hauteurGraphe-Blu.timeline.echelleY*f,c.moveTo(Blu.timeline.limGauche-5,j),c.lineTo(Blu.timeline.limGauche+Blu.timeline.largeurTotale,j),c.fillText(f,Blu.timeline.limGauche-8,j);c.stroke()}g=
Blu.tranches.length;for(f in Blu.tranches){var k=Blu.tranches[f],h=k.nombre;j=Blu.timeline.echelleY*h;var l=Blu.timeline.decalageY+Blu.timeline.hauteurGraphe-j,d=Blu.fn.timeline.timeToX(k.debut),m=255-Math.floor(Blu.timeline.echelleRGB*h),n=Blu.timeline.decalageY+Blu.timeline.hauteurGraphe,p=Blu.timeline.echelleYMiniature*h,q=Blu.timeline.mini.height-p,s=Blu.timeline.miniScale*k.debut+Blu.timeline.decalageXMini;a&&(Blu.timeline.params.trancheHover==f&&(c.fillStyle="rgba(255,255,0,.5)",c.fillRect(d,
Blu.timeline.decalageY,Blu.timeline.largeurTranche,Blu.timeline.hauteurGraphe-j),c.beginPath(),c.moveTo(d+Blu.timeline.largeurTranche/2,n),c.lineTo(d+Blu.timeline.largeurTranche/2,n+40),c.strokeStyle="#888",c.stroke(),c.beginPath(),c.moveTo(d,Blu.timeline.decalageY),c.stroke(),c.save(),c.translate(d-5,n+12),c.fillStyle="#888",k=k.debut_heure==k.fin_heure?Blu.txt("legendSliceAxisOneDay",k.jour):Blu.txt("legendSliceAxis",k.jour,k.debut_heure,k.fin_heure),c.fillText(k,0,0),c.restore(),c.beginPath(),
c.moveTo(d,Blu.timeline.decalageY),c.stroke(),c.save(),c.translate(d-5,n+30),c.fillStyle="#000",c.font="16px Arial",k=h+(1<h?" tweets":" tweet"),c.fillText(k,0,0),c.restore()),c.fillStyle=Blu.timeline.params.trancheHover==f?"rgb(0,0,128)":-1===Blu.timeline.params.trancheCourante||Blu.timeline.params.trancheCourante==f?"rgb(0,"+m+",255)":"rgb(170,"+(170+Math.floor(m/3))+",255)",c.fillRect(d,l,Blu.timeline.largeurTranche+0.5,j));if(b)switch(e.fillStyle="rgb(0,"+m+",255)",Blu.config.timeline.style.plotType){case "bars":e.fillRect(s,
q,Blu.timeline.largeurTrancheMini+0.5,p);break;default:d={x:s,y:q};"undefined"!==typeof r&&f!==g-1&&(Blu.config.timeline.style.plotWave&&(e.fillStyle=Blu.config.timeline.style.waveColor,e.strokeStyle=Blu.config.timeline.style.waveColor,e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(r.x,r.y),e.lineTo(r.x,Blu.timeline.mini.height+10),e.lineTo(d.x,Blu.timeline.mini.height+10),e.lineTo(d.x,d.y),e.closePath(),e.fill()),e.strokeStyle=Blu.config.timeline.style.lineColor,e.beginPath(),e.moveTo(d.x,d.y),e.lineTo(r.x,
r.y),e.closePath(),e.stroke());var r=d}}b&&(Blu.canvas_mini.timeline.image=e.getImageData(0,0,Blu.timeline.mini.width,Blu.timeline.mini.height))}}};
Blu.fn.tweets.loadIfNecessary=function(){var a=Blu.timeline.params.filter.dates.min,b=Blu.timeline.params.filter.dates.max,c,d,e;if(b){for(var f in Blu.intervals)if(c=Blu.intervals[f],d=Blu.fn.misc.dateStringToObject(c.min.date_utc,0),e=Blu.fn.misc.dateStringToObject(c.max.date_utc,0),d=b>d&&b.getTime()<=e.getTime()&&a>d&&a.getTime()<=e.getTime()){Blu.warn("Intervalle de temps d\u00e9j\u00e0 explor\u00e9 ("+c.min.date+" >> "+c.max.date);return}Blu.warn("Chargement n\u00e9cessaire de tweets avec date_max = "+
b);Blu.fn.tweets.load({time_max:b.getTime()/1E3,show:!0})}};Blu.fn.misc.sortIntervals=function(a,b){return a.min.id-b.min.id};Blu.fn.tweets.mergeIntervals=function(){};
Blu.fn.timemachine.timeTravel=function(){Blu.info("Blu.fn.timemachine.timetravel()");var a=!0;Blu.timeline.cursors.timetravel.time&&(a="undefined"!==typeof Blu.timeline.cursors.timetravel?Math.round(Blu.timeline.cursors.timetravel.time):Math.round(Blu.fn.timeline.xToTime(Blu.mouse.lastPos.x-Blu.DOM.miniTimeline.offset().left,!0)),a=Blu.fn.timemachine.selectGraphFromDate(new Date(1E3*a)));a&&(Blu.fn.timemachine.deleteCursor("timetravel"),Blu.fn.timetravel(Blu.graphs.timemachine));Blu.fn.timemachine.displayDate();
Blu.fn.timemachine.displayTip()};
Blu.fn.timetravel=function(a){Blu.info("Blu.fn.timetravel()");Blu.DOM.zc.spin("big");Blu.fn.initialiseVue("map");Blu.fn.map.chargeGraphe(a);var b=Blu.fn.misc.dateStringToObject(a.date_min_utc,0);a=Blu.fn.misc.dateStringToObject(a.date_max_utc,0);Blu.timeline.params.filter.dates={min:b,max:a};Blu.fn.UI.goHome();Blu.fn.tweets.loadIfNecessary();Blu.fn.timers.resetInterval("delaySearch");Blu.timers.delaySearch=setInterval(function(){if(Blu.map.initialise||!Blu.is.loadingTweets)Blu.fn.tweets.search(Blu.timeline.params.filter.string,!0,
!0),Blu.fn.timers.resetInterval("delaySearch")},100);Blu.fn.map.traceMap();Blu.log("refreshCanvas : map (timetravel)");Blu.timers.refreshCanvas=setInterval(Blu.fn.map.traceMap,60);Blu.DOM.zc.spinStop()};
Blu.fn.timemachine.backToThePresent=function(){Blu.fn.timemachine.setCursor("timetravel",Blu.fn.misc.dateStringToObject(Blu.projects.current.dates.max,0).getTime()/1E3);Blu.fn.timemachine.timeTravel();Blu.timeline.params.filter.dates.min=null;Blu.timeline.params.filter.dates.max=null;Blu.fn.tweets.search(Blu.timeline.params.filter.string,!1,!0)};
Blu.fn.timemachine.displayDate=function(){var a=Blu.tranches.length?Blu.tranches[0]:"",b=Blu.tranches.length?Blu.tranches[Blu.tranches.length-1]:"",c=a?Blu.fn.misc.texteJour(a.dateStart,!0):"",d=b?Blu.fn.misc.texteJour(b.dateStart,!0):"",a=a.debut_heure||"",b=b.fin_heure||"";Blu.DOM.tmSideLeft.find(".date .day").text(c);Blu.DOM.tmSideLeft.find(".date .hour").text(a);Blu.DOM.tmSideRight.find(".date .day").text(d);Blu.DOM.tmSideRight.find(".date .hour").text(b);Blu.timeline.cursors.timetravel&&Blu.timeline.cursors.timetravel.time?
Blu.DOM.tmTimeTravel.text(Blu.timeline.cursors.timetravel?Blu.fn.misc.dateObjectToString(new Date(1E3*Blu.timeline.cursors.timetravel.time),"min"):""):(Blu.DOM.tmTimeTravel.text(""),Blu.DOM.tmTimeTravel.hide())};Blu.fn.timemachine.displayTip=function(){};
Blu.fn.timemachine.selectGraphFromDate_NoOverlap=function(a){var b,c;c=null;var d;for(b in Blu.graphs.all)if(c=Blu.graphs.all[b],d=a.getTime()>=c.datesObj.min.getTime()&&a.getTime()<c.datesObj.max.getTime())if(c.filename==Blu.graphs.current.filename)break;else return Blu.graphs.timemachine=c,!0;return!1};
Blu.fn.timemachine.selectGraphFromDate_detectMax=function(a){var b,c,d,e;d=null;for(b in Blu.graphs.all)if(c=Blu.graphs.all[b],c.datesObj.max>a){d=c;e=0<b?Blu.graphs.all[b-1]:c;c=Math.abs(d.datesObj.max-a);a=Math.abs(a-e.datesObj.max);d=c<a?d:e;break}null===d&&(d=Blu.graphs.all[b]);Blu.graphs.timemachine=d;return!0};
Blu.fn.timemachine.selectGraphFromDate_detectCenter=function(a){var b,c,d=null,e,f;if(!Blu.graphs.all.length)return!1;for(b in Blu.graphs.all)c=Blu.graphs.all[b],e=(c.datesObj.min.getTime()+c.datesObj.max.getTime())/2,e=Math.abs(a.getTime()-e),null===d?(d=c,f=e):e<f&&(d=c,f=e);Blu.graphs.timemachine=d;return!0};
Blu.fn.timemachine.selectGraphFromDate=function(a){Blu.info("selectGraphFromDate() : date = ");Blu.log(a);return Blu.timeline.cursors.graphs?Blu.fn.timemachine.selectGraphFromDate_NoOverlap(a):Blu.fn.timemachine.selectGraphFromDate_detectCenter(a)};Blu.fn.canvas.click=function(a){Blu.is.movingCanvas||("timeline"===Blu.viz.current&&Blu.fn.timeline.click(),"map"===Blu.viz.current&&Blu.fn.map.click());Blu.fn.canvas.endMoving(a)};
Blu.fn.timeline.click=function(){Blu.is.movingCanvas||(Blu.timeline.params.trancheCourante=Blu.timeline.params.trancheHover,Blu.fn.tweets.showList())};
Blu.fn.map.click=function(){if(!Blu.is.movingCanvas)if(Blu.map.params.selectedNode=Blu.map.params.hoverNode,-1===Blu.map.params.selectedNode)(!Blu.config.map.usercards.show||Blu.usercards.selected.state.show||Blu.usercards.hover.state.show||Blu.usercards.hover.state.closed||Blu.usercards.selected.state.closed)&&Blu.fn.users.resetPanels();else{var a=Blu.carto.nodes[Blu.map.params.selectedNode],b=a.name;if(!Blu.config.users.profilePopUp){if(Blu.config.map.usercards.show){if(Blu.timers.showUserCard&&
(!Blu.usercards.selected.state.show||Blu.usercards.selected.node!==Blu.map.params.selectedNode)&&!Blu.usercards.hover.state.show)Blu.DOM.zc.find(".user-card").remove(),Blu.fn.user.showUserCard(b),Blu.usercards.selected.state.show=!0;if(Blu.usercards.selected.node===Blu.map.params.selectedNode){Blu.usercards.selected.state.show=!0;Blu.usercards.selected.state.closed=!1;return}Blu.fn.usercards.reset();Blu.usercards.selected.state.show=!0;Blu.usercards.selected.node=Blu.map.params.selectedNode}Blu.fn.user.showProfile(b,
"click-map");mixpanel.track("Show Profile (via Map)",{User:b})}Blu.fn.UI.miniStats({username:a.name,countTweets:a.tweets,countUsers:a.mentions})}};Blu.fn.canvas.startMoving=function(a){a.preventDefault();Blu.mouse.dragOn=!0;Blu.mouse.dragPx={x:0,y:0};a.gesture?Blu.touch.lastPos={x:a.gesture.center.pageX,y:a.gesture.center.pageY}:Blu.mouse.lastPos={x:a.pageX,y:a.pageY};Blu.is.movingCanvas=!1};
Blu.fn.canvas.endMoving=function(){document.body.style.cursor="default";Blu.mouse.dragOn=!1;Blu.is.movingCanvas=!1};Blu.fn.canvas.move=function(a,b){document.body.style.cursor="move";var c=a.gesture?{x:a.gesture.center.pageX,y:a.gesture.center.pageY}:{x:a.pageX,y:a.pageY},d=a.gesture?Blu.touch.lastPos:Blu.mouse.lastPos;Blu[Blu.viz.current].params.centreX+=(d.x-c.x)/b;Blu[Blu.viz.current].params.centreY+=(d.y-c.y)/b;a.gesture?Blu.touch.lastPos=c:Blu.mouse.lastPos=c};
Blu.fn.canvas.mouseMove=function(a){if(Blu[Blu.viz.current].initialise){var b=Blu.DOM.canvas.offset();a.gesture?Blu.touch.pos={x:a.gesture.center.pageX-b.left,y:a.gesture.center.pageY-b.top}:Blu.mouse.pos={x:a.pageX-b.left,y:a.pageY-b.top};Blu.mouse.dragOn?(Blu.fn.canvas.move(a,Blu[Blu.viz.current].scale),Blu.is.movingCanvas=!0):"timeline"===Blu.viz.current?Blu.fn.canvas.hoverTimeline():"map"===Blu.viz.current&&Blu.fn.canvas.hoverMap()}};
Blu.fn.canvas.hoverTimeline=function(){Blu.mouse.pos.x>Blu.timeline.limGauche&&Blu.mouse.pos.x<Blu.timeline.limGauche+Blu.timeline.largeurTotale&&Blu.mouse.pos.y>Blu.timeline.decalageY&&Blu.mouse.pos.y<Blu.timeline.decalageY+Blu.timeline.hauteurGraphe?Blu.fn.timeline.hoverTranche(Math.floor(Blu.tranches.length*(Blu.mouse.pos.x-Blu.timeline.limGauche)/Blu.timeline.largeurTotale)):Blu.fn.timeline.hoverTranche(-1);document.body.style.cursor=-1!=Blu.timeline.params.trancheHover?"pointer":"default"};
Blu.fn.canvas.hoverMap=function(){var a,b,c,d,e,f=Blu.fn.map.getNodeFromPos(Blu.mouse.pos),g=Blu.usercards.hover,h=Blu.usercards.selected;Blu.map.params.hoverNode=f;document.body.style.cursor=-1!=f?"pointer":"default";if(-1!==f){a=Blu.carto.nodes[f];var j=a.name.toLowerCase().replace("@","");b=h.node===f?h:g;e=h.node===f?!h.state.show:f!==g.node;a&&(Blu.fn.UI.miniStats({username:a.name,countTweets:a.tweets,countUsers:a.mentions}),$(".user-list").find("li."+j).addClass("selected"));if(Blu.config.map.usercards.show&&
!Blu.timers.showUserCard&&(e||h.state.closed||g.state.closed))Blu.timers.showUserCard=setTimeout(function(){Blu.timers.showUserCard=0;b=h.node===f?h:g;if(-1!==f&&(!b.state.show||f!==b.node))c=Blu.carto.nodes[f].name,d=-1!==h.node?"hover":"all",Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset(d),Blu.usercards.selected.state.show=!1,Blu.usercards.selected.state.mouseOver=!1,Blu.usercards.hover.state.show=Blu.config.map.usercards.showHover,Blu.usercards.hover.node=Blu.map.params.hoverNode,
Blu.fn.user.showUserCard(c)},300)}else if($(".user-list").find("li").removeClass("selected"),Blu.config.map.usercards.show&&(clearTimeout(Blu.timers.showUserCard),Blu.timers.showUserCard=0),!g.state.mouseOver&&!h.state.mouseOver)if(-1!=Blu.map.params.selectedNode){var k=Blu.map.params.selectedNode;a=Blu.carto.nodes[k];Blu.config.map.usercards.show&&(!h.state.show&&!Blu.timers.removeUC)&&(Blu.timers.removeUC=setTimeout(function(){Blu.timers.removeUC=0;!g.state.mouseOver&&(!h.state.mouseOver&&-1===
f&&k===Blu.map.params.selectedNode)&&(b=Blu.DOM.zc.find(".user-card"),b.remove(),Blu.fn.usercards.reset("hover"),h.state.closed||(h.state.show=!0,Blu.fn.user.showUserCard(a.id)))},300));a&&Blu.fn.UI.miniStats({username:a.name,countTweets:a.tweets,countUsers:a.mentions})}else Blu.config.map.usercards.show&&(g.state.show&&!Blu.timers.removeUC)&&(Blu.timers.removeUC=setTimeout(function(){Blu.timers.removeUC=0;!Blu.usercards.hover.state.mouseOver&&-1===Blu.map.params.hoverNode&&(Blu.DOM.zc.find(".user-card").remove(),
Blu.fn.usercards.reset())},300)),Blu.fn.UI.miniStats({countTweets:Blu.counts.tweets.filter,countUsers:Blu.counts.users.graph})};
Blu.fn.timemachine.endMoving=function(a){a.gesture?Blu.touch.lastPos={x:a.gesture.center.pageX,y:a.gesture.center.pageY}:Blu.mouse.lastPos={x:a.pageX,y:a.pageY};Blu.mouse.dragOn?Blu.fn.timemachine.timeTravel():(Blu.fn.timemachine.deleteCursor("timetravel"),Blu.fn.timemachine.trace(),Blu.fn.timemachine.displayDate(),Blu.fn.timemachine.displayTip());Blu.mouse.dragOn=!1;Blu.is.movingCanvas=!1};
Blu.fn.map.selectUser=function(a,b){if(Blu.carto){b="undefined"!==typeof b?b:!0;var c=a.replace("@","").toLowerCase(),d;for(d in Blu.carto.nodes)if(Blu.carto.nodes[d].name.replace("@","").toLowerCase()===c){Blu.map.params.selectedNode=parseInt(d,10);Blu.config.map.usercards.show&&(Blu.usercards.selected.node=Blu.map.params.selectedNode);b&&(Blu.map.params.centreX=Blu.carto.nodes[d].coords.base.x,Blu.map.params.centreY=Blu.carto.nodes[d].coords.base.y);return}Blu.map.params.selectedNode=-1}};
Blu.fn.timeline.hoverTranche=function(a){"timeline"===Blu.viz.current&&(Blu.timeline.params.trancheHover=a,a=-1!=a?a:Blu.timeline.params.trancheCourante,-1===a?Blu.fn.UI.miniStats({countTweets:Blu.counts.tweets.filter,countUsers:Blu.counts.users.graph}):Blu.tranches[a].debut_heure==Blu.tranches[a].fin_heure?$("#mini-stats").html(Blu.txt("legendSliceOneDay",Blu.tranches[a].jour,Blu.tranches[a].nombre)):$("#mini-stats").html(Blu.txt("legendSlice",Blu.tranches[a].jour,Blu.tranches[a].debut_heure,Blu.tranches[a].fin_heure,
Blu.tranches[a].nombre)))};Blu.fn.canvas.moveFromMini=function(a){Blu.mouse.dragOn&&Blu.fn.canvas.move(a,-Blu[Blu.viz.current].miniScale)};
Blu.fn.map.scrollMap=function(a,b){Blu.mouse.scroll+=b;Blu.config.map.zoomAnimation?Blu.timers.zoomingOnMap||(Blu.timers.gettingScrollOnMap?Blu.map.scrollDelta+=b:(Blu.map.scrollDelta=b,Blu.timers.gettingScrollOnMap=setTimeout(function(){Blu.timers.zoomingOnMap||Blu.fn.map.zoom(a,Blu.map.scrollDelta);Blu.timers.gettingScrollOnMap=0},100))):1<=Math.abs(Blu.mouse.scroll)&&Blu.fn.map.zoom(a,0>Blu.mouse.scroll?-1:1)};
Blu.fn.touch.logGesture=function(a){var b=a.gesture,c=a.gesture.startEvent,d="";Blu.log(a);"undefined"!==typeof b.touches&&2<=b.touches.length&&(d+="touches = ("+b.touches[0].pageX+", "+b.touches[0].pageY+") and ("+b.touches[1].pageX+", "+b.touches[1].pageY+")  <br/>");c&&"undefined"!==typeof c.touches&&2<=c.touches.length&&(d+="touches (start) = ("+c.touches[0].pageX+", "+c.touches[0].pageY+") and ("+c.touches[1].pageX+", "+c.touches[1].pageY+")  <br/>");return d+="center = ( "+b.center.pageX+", "+
b.center.pageY+" ) <br/>deltaTime = "+b.deltaTime+" <br/>delta = ( "+b.deltaX+", "+b.deltaY+" ) <br/>velocity = ( "+b.velocityX+", "+b.velocityY+" ) <br/>angle = "+b.angle+" <br/>direction = "+b.direction+" <br/>distance = "+b.distance+" <br/>rotation = "+b.rotation+" <br/>eventType = "+b.eventType+"<br/>scale = "+b.scale};Blu.fn.touch.getDistance=function(a){return 2>a.length?0:Math.sqrt(Math.pow(a[1].pageX-a[0].pageX,2)+Math.pow(a[1].pageY-a[0].pageY,2))};
Blu.fn.map.pinchMap=function(a){var b=a.gesture.startEvent,c=Math.pow(Math.SQRT2,Blu.touch.startZoomLevel-4),d=Blu.DOM.canvas.offset().left,e=Blu.DOM.canvas.offset().top,f=a.gesture.center.pageX-d,g=a.gesture.center.pageY-e,d=(b.center.pageX-d-Blu.zoneGraphe.largeur/2)/c+Blu.touch.startMapCenterX,e=(b.center.pageY-e-Blu.zoneGraphe.hauteur/2)/c+Blu.touch.startMapCenterY,b=Blu.fn.touch.getDistance(b.touches);a=Blu.fn.touch.getDistance(a.gesture.touches);c*=Math.pow(a/b,1/0.85);f=d-(f-Blu.zoneGraphe.largeur/
2)/c;g=e-(g-Blu.zoneGraphe.hauteur/2)/c;c=2*Math.log(c)/Math.log(2)+4;c=Math.min(Math.max(c,Blu.map.minZoom),Blu.map.maxZoom);Blu.map.params.centreX=f;Blu.map.params.centreY=g;Blu.map.params.zoomLevel=c;Blu.map.params.zoomLevel=_targetZoom;Blu.mouse.scroll=0};
Blu.fn.map.resetZoom=function(){var a=$("#slider");Blu.map.params.zoomLevel=Blu.map.defaults.zoomLevel;Blu.map.params.centreX=Blu.map.defaults.centreX;Blu.map.params.centreY=Blu.map.defaults.centreY;a.slider("value",Blu.map.defaults.zoomLevel);Blu.mouse.scroll=0};
Blu.fn.map.zoom=function(a,b,c){if(b){var d=Blu[Blu.viz.current],e=d.params.zoomLevel;a="boolean"===typeof c?c:Blu.config.map.zoomAnimation;var f=0<b?Math.min(e+b,d.maxZoom):Math.max(e+b,d.minZoom);if(e!==f)if(a){if(!Blu.timers.zoomingOnMap){var g=new Date;Blu.fn.timers.resetInterval("zoomingOnMap");Blu.timers.zoomingOnMap=setInterval(function(){var a=new Date-g;500<a?(Blu.fn.timers.resetInterval("zoomingOnMap"),Blu.mouse.scroll=0):(a=$.easing.easeOutExpo(a/500,a,0,1,500),d.params.zoomLevel=e+a*(f-
e));Blu.fn.map.traceMap(!0)},40)}}else d.params.zoomLevel=f,Blu.mouse.scroll=0}};
Blu.fn.canvas.drawImage=function(a){if(!a.canvas)throw"A canvas is required";if(!a.image)throw"Image is required";var b=a.canvas,c=b.getContext("2d"),d=a.image,e=a.srcx||0,f=a.srcy||0,g=a.srcw||d.naturalWidth,d=a.srch||d.naturalHeight,h=a.desx||e,j=a.desy||f,k=a.desw||g,l=a.desh||d,m=a.auto,n=window.devicePixelRatio||1,p=c.webkitBackingStorePixelRatio||c.mozBackingStorePixelRatio||c.msBackingStorePixelRatio||c.oBackingStorePixelRatio||c.backingStorePixelRatio||1;a=n/p;"undefined"===typeof m&&(m=!0);
m&&n!==p&&(m=b.width,n=b.height,b.width=m*a,b.height=n*a,b.style.width=m+"px",b.style.height=n+"px",c.scale(a,a));c.drawImage(pic,e,f,g,d,h,j,k,l)};Blu.fn.initialiseVue=function(a){Blu.log("refreshCanvas : clear (initialiseVue)");clearInterval(Blu.timers.refreshCanvas);Blu.viz.current=a;Blu[Blu.viz.current].initialise=!1;Blu[Blu.viz.current].oldParams={};Blu.canvas.ctx.clearRect(0,0,Blu.zoneGraphe.largeur,Blu.zoneGraphe.hauteur)};
Blu.fn.timeline.init=function(){Blu.log("Blu.fn.timeline.init...");Blu.fn.initialiseVue("timeline");document.location.href=Blu.currentDataset?"#/"+Blu.currentDataset+"/chrono":"#chrono";$("#ulgranul").show();$("#btnedges, #time-machine, #time-machine-date, #time-machine-tip").hide();"undefined"===typeof Blu.canvas_mini.timeline.image&&(Blu.canvas_mini.timeline.image="");Blu.log("refreshCanvas : timeline");Blu.timers.refreshCanvas=setInterval(function(){Blu.fn.timeline.traceTimeline(!1,!0,!1)},120)};
Blu.fn.map.init=function(){Blu.info("Blu.fn.map.init...");Blu.fn.initialiseVue("map");$("#ulgranul").hide();Blu.fn.UI.updateBtnEdges();$("#time-machine, #time-machine-date, #time-machine-tip").show();Blu.log("refreshCanvas : map");Blu.timers.refreshCanvas=setInterval(Blu.fn.map.traceMap,60);Blu.carto?Blu.map.initialise=!0:(Blu.needs.lastGraph&&Blu.fn.project.getLastGraph(),Blu.needs.allGraphs&&Blu.fn.project.getAllGraphs())};
Blu.fn.project.ajaxParams=function(){var a={project_id:Blu.projects.current.id,dataset:Blu.currentDataset,subset:Blu.currentSubset,refresh:Math.random()};Blu.projects.current.dates.min&&(a.date_min=Blu.projects.current.dates.min);Blu.projects.current.dates.max&&(a.date_max=Blu.projects.current.dates.max);return a};
Blu.fn.project.getLastGraph=function(){var a=Blu.fn.project.ajaxParams();a.action="get-last-graph";Blu.timeNav&&(a.timeNav={mode:Blu.timeNav.mode});$.getJSON(Blu.app.urls.ajax_base,a,function(a){Blu.log("Last graph is known, now let's load it...");Blu.has.loadedGraph=!0;Blu.fn.map.prepareGraph(a.last_graph);Blu.fn.map.chargeGraphe(a.last_graph)})};
Blu.fn.project.getAllGraphs=function(){var a=Blu.fn.project.ajaxParams();a.action="get-all-graphs";Blu.timeNav&&(a.timeNav={mode:Blu.timeNav.mode});$.getJSON(Blu.app.urls.ajax_base,a,function(a){Blu.has.loadedAllGraphs=!0;if(a.graphs){for(var c in a.graphs)Blu.fn.map.prepareGraph(a.graphs[c]);Blu.graphs.all=a.graphs;Blu.graphs.last=Blu.graphs.all[Blu.graphs.all.length-1]}})};
Blu.fn.map.prepareGraph=function(a){a.datesObj={min:a.date_min_utc?Blu.fn.misc.dateStringToObject(a.date_min_utc,0):a.date_min?Blu.fn.misc.dateStringToObject(a.date_min):"",max:a.date_max_utc?Blu.fn.misc.dateStringToObject(a.date_max_utc,0):a.date_max?Blu.fn.misc.dateStringToObject(a.date_max):""};a.type=a.type||"mentions"};
Blu.fn.map.createGraph=function(a,b){Blu.info("map.createGraph()");a=a||{};var c=Blu.fn.project.ajaxParams();c.graph=a;Blu.is.creatingGraph=!0;$.getJSON(Blu.app.urls.main+"/projects/create-graph",c,function(a){"function"===typeof b&&b(a)})};Blu.fn.project.getGraph=function(a,b){Blu.info("Blu.fn.project.getGraph()");a=a||{};var c=Blu.fn.project.ajaxParams();c.action="get-graph";c.graph=a;$.getJSON(Blu.app.urls.ajax_base,c,function(a){"function"===typeof b&&b(a)})};
Blu.fn.map.chargeGraphe=function(a){Blu.info("Chargement d'un graphe > "+(a.filename||""));var b=Blu.DOM.zc;Blu.fn.UI.removeCanvasScreen();a.filename?(a.datesObj||Blu.fn.map.prepareGraph(a),Blu.graphs.current=a,Blu.timeline.params.filter.dates={min:a.datesObj.min,max:a.datesObj.max},b.spin("big"),Blu.fn.UI.mapNotification(""),$.getJSON(Blu.app.urls.graphs_base+Blu.projects.current.graphs_dir+a.filename,function(a){Blu.log("Graph JSON charg\u00e9");Blu.DOM.zc.spinStop();Blu.fn.UI.mapNotification("");
Blu.carto=a;a.nodes.length||Blu.fn.UI.graphNotAvailable();Blu.fn.map.afterLoad()})):(Blu.fn.UI.graphNotAvailable(),Blu.carto={nodes:[],edges:[]},Blu.fn.map.afterLoad())};Blu.fn.UI.graphNotAvailable=function(){Blu.fn.UI.mapNotification("");Blu.DOM.zc.spinStop();Blu.fn.UI.showCanvasScreen({error:!0})};
Blu.fn.map.afterLoad=function(){Blu.info("Blu.fn.map.afterLoad()");Blu.counts.users.graph=Blu.carto.nodes.length;Blu.fn.UI.miniStats();Blu.fn.UI.updateNodesCounts();Blu.map.isIdentical=!1;Blu.timemachine.initialized&&(Blu.fn.timemachine.currentGraphCursor(),Blu.fn.timemachine.trace());if(Blu.carto.nodes.length){var a=1E9,b=-1E9,c=1E9,d=-1E9,e=0,f,g;for(g in Blu.carto.nodes)f=Blu.carto.nodes[g],a=Math.min(f.x,a),b=Math.max(f.x,b),c=Math.min(f.y,c),d=Math.max(f.y,d),"undefined"===typeof f.tweets&&(f.tweets=
"0"),e=Math.max(f.tweets,e);var h=Math.min((Blu.map.width-30)/(b-a),(Blu.map.height-30)/(d-c)),a=(Blu.map.width-h*(a+b))/2,c=(Blu.map.height-h*(c+d))/2;for(g in Blu.carto.nodes)f=Blu.carto.nodes[g],f.coords={base:{x:a+h*f.x,y:c+h*f.y,r:h*f.size}},"search-user"===Blu.projects.current.type&&f.name.replace("@","").toLowerCase()==Blu.projects.current.twitter_screen_name.replace("@","").toLowerCase()&&(f.coords.base.r=5*h,f.isUserMapped=!0),f.name.replace("@","").toLowerCase()==Blu.user.screen_name.replace("@",
"").toLowerCase()&&(f.isMe=!0),b=Math.sqrt(f.tweets/e),f.colors={},f.colors.blue={},f.colors.green={},Blu.config.map.style.nodes.monochrome&&(b=0.52),d=0.75-0.5*b,b=0.45-0.2*b,f.colors.blue.base=Blu.fn.color.hslToRgb(0.55,1,d,1).string,f.colors.blue.base2=Blu.fn.color.hslToRgb(0.55,1,d-0.06,1).string,f.colors.blue.off=Blu.fn.color.hslToRgb(0.55,0.3,d,0.5).string,f.colors.blue.off2=Blu.fn.color.hslToRgb(0.55,0.3,d-0.06,0.5).string,f.colors.green.base=Blu.fn.color.hslToRgb(0.42,1,b,1).string,f.colors.green.base2=
Blu.fn.color.hslToRgb(0.42,1,b-0.06,1).string,f.colors.green.off=Blu.fn.color.hslToRgb(0.42,0.3,b,0.5).string,f.colors.green.off2=Blu.fn.color.hslToRgb(0.42,0.3,b-0.06,0.5).string;for(var j in Blu.carto.edges){var e=0,k;for(k in Blu.carto.nodes)if(Blu.carto.nodes[k].id==Blu.carto.edges[j].source&&(Blu.carto.edges[j].s=k,e++),Blu.carto.nodes[k].id==Blu.carto.edges[j].target&&(Blu.carto.edges[j].t=k,e++),2==e)break}Blu.map.initialise=!0;Blu.fn.map.traceMap(!0)}else Blu.warn("No graph to display!"),
Blu.map.initialise=!0,Blu.DOM.zc.spinStop()};
Blu.fn.map.calcFollowed=function(){Blu.info("Blu.fn.map.calcFollowed...");if(Blu.user.following.list)if(Blu.carto){var a;Blu.graphs.current.followedNodes=0;for(var b in Blu.carto.nodes)a=Blu.carto.nodes[b],Blu.fn.user.isFollowed(a.name)?(a.followed=!0,Blu.graphs.current.followedNodes++):a.followed=!1;Blu.log(Blu.graphs.current.followedNodes+" users are followed on this graph.");Blu.fn.UI.updateNodesCounts();Blu.fn.map.traceMap(!0)}else Blu.warn("No graph...");else Blu.warn("No following...")};
Blu.fn.map.survolNoeud=function(a){if(Blu.carto&&"map"===Blu.viz.current){a=a.toLowerCase();for(var b in Blu.carto.nodes)if(Blu.carto.nodes[b].name.toLowerCase()===a){Blu.map.params.hoverNode=b;break}}};
Blu.fn.map.getNodeFromPos=function(a){if(!Blu.carto||!Blu.carto.nodes)return-1;for(var b,c=Blu.carto.nodes.length-1;0<=c;c--)if("undefined"!==typeof Blu.carto.nodes[c].coords.actuel&&(b=Math.sqrt(Math.pow(Blu.carto.nodes[c].coords.actuel.x-a.x,2)+Math.pow(Blu.carto.nodes[c].coords.actuel.y-a.y,2)),b<Blu.carto.nodes[c].coords.actuel.r))return c;return-1};
Blu.fn.canvas.calcCoord=function(a,b,c){var d=Math.sqrt(Math.pow(c.x-a,2)+Math.pow(c.y-b,2));if(d<Blu.rayonLoupe){var e=(c.x-a)/d,f=(c.y-b)/d,g=Blu.rayonLoupe*Math.pow(d/Blu.rayonLoupe,Blu.gammaLoupe),d=Blu.gammaLoupe*Math.pow((d+1)/Blu.rayonLoupe,Blu.gammaLoupe-1);return{x:a+g*e,y:b+g*f,r:d*c.r}}return c};
Blu.fn.usercards.reset=function(a){a=a||"all";Blu.log("Blu.fn.usercards.reset( "+a+" )");for(var b in Blu.usercards)if(a==b||"all"===a)Blu.usercards[b]={node:-1,position:{align:"",fromNode:0,x:0,y:0},state:{closed:!1,expanded:!0,locked:!1,mouseChanged:!1,mouseOver:!1,show:!1}}};
Blu.fn.usercards.events=function(){$(".user-card").live({mouseover:function(){var a=Blu.usercards.hover.state.show?"hover":"selected";Blu.usercards[a].state.mouseOver=!0;Blu.usercards[a].state.mouseChanged=!0;Blu.fn.map.traceMap()},mouseout:function(){var a=Blu.usercards.hover.state.show?"hover":"selected";Blu.usercards[a].state.mouseOver=!1;Blu.usercards[a].state.mouseChanged=!0}});$(".user-card .bt-more").live({click:function(){var a=Blu.usercards.hover.state.show?"hover":"selected",b=$(".user-card"),
a=Blu.usercards[a];a.state.expanded=!0;b.addClass("expanded");b.find(".twitter-follow-button");b.find(".more-container .more").removeClass("hide");Blu.fn.user.positionUserCard();a.state.locked=!0;return!1}});$(".user-card .close").live({click:function(){$(".user-card").remove();var a=Blu.usercards.selected.state,b=Blu.usercards.hover.state;a.closed=!0;a.mouseOver=!1;a.expanded=!1;b.mouseOver=!1;b.mouseChanged=!0;a.show=!1;Blu.fn.usercards.reset("hover");return!1}})};
Blu.fn.map.traceArc=function(a,b,c){a.beginPath();a.moveTo(b.x,b.y);var d,e,f,g;b.x==c.x&&b.y==c.y?(d=b.x+2.8*b.r,e=b.y-b.r,f=b.x,g=b.y+2.8*b.r,a.bezierCurveTo(d,e,f,g,b.x+1,b.y)):(d=0.3*c.y-0.3*b.y+0.8*b.x+0.2*c.x,e=0.8*b.y+0.2*c.y-0.3*c.x+0.3*b.x,f=0.3*c.y-0.3*b.y+0.2*b.x+0.8*c.x,g=0.2*b.y+0.8*c.y-0.3*c.x+0.3*b.x,a.bezierCurveTo(d,e,f,g,c.x,c.y));a.stroke()};Blu.fn.map.resetCanvas=function(){Blu.canvas.ctx.clearRect(0,0,Blu.zoneGraphe.largeur,Blu.zoneGraphe.hauteur)};
Blu.fn.map.traceMap=function(a){a="boolean"===typeof a?a:!1;Blu.fn.UI.updateSize();if(!Blu.carto||!Blu.map.initialise)Blu.counts.users.graph=0,Blu.fn.map.resetCanvas();else{var b=Blu.canvas.ctx,c,d,e,f,g;Blu.map.params.posSouris=Blu.map.params.loupeActive?Blu.mouse.pos?Blu.mouse.pos.x+","+Blu.mouse.pos.y:"out":null;var h=Blu.map.isIdentical&&!Blu.usercards.hover.state.mouseChanged,j;for(j in Blu.map.params)h=h&&Blu.map.params[j]===Blu.map.oldParams[j];if(h&&!a)(-1!==Blu.usercards.hover.node||-1!==
Blu.usercards.selected.node)&&Blu.fn.user.positionUserCard();else{for(j in Blu.map.params)Blu.map.oldParams[j]=Blu.map.params[j];Blu.fn.map.resetCanvas();Blu.map.scale=Math.pow(Math.SQRT2,Blu.map.params.zoomLevel-4);Blu.map.decalageX=Blu.zoneGraphe.largeur/2-Blu.map.params.centreX*Blu.map.scale;Blu.map.decalageY=Blu.zoneGraphe.hauteur/2-Blu.map.params.centreY*Blu.map.scale;g=Math.pow(Blu.map.scale,-0.15);Blu.map.params.loupeActive&&Blu.mouse.pos&&(b.fillStyle="rgba(220,220,250,0.4)",b.beginPath(),
b.arc(Blu.mouse.pos.x,Blu.mouse.pos.y,Blu.rayonLoupe,0,2*Math.PI,!0),b.closePath(),b.fill());a=-1;-1!==Blu.map.params.hoverNode?a=Blu.map.params.hoverNode:Blu.usercards.hover.state.mouseOver||Blu.usercards.selected.state.mouseOver?(a=-1!==Blu.usercards.hover.node?Blu.usercards.hover.node:Blu.usercards.selected.node,Blu.usercards.hover.state.mouseOver&&(Blu.map.params.hoverNode=Blu.usercards.hover.node)):a=Blu.map.params.selectedNode;var h=-1!==a,k=[Blu.map.params.selectedNode,Blu.map.params.hoverNode],
l=[];-1!==a&&(l=[a]);for(j in Blu.carto.nodes)c=Blu.carto.nodes[j],c.coords.actuel={x:Blu.map.scale*c.coords.base.x+Blu.map.decalageX,y:Blu.map.scale*c.coords.base.y+Blu.map.decalageY,r:Blu.map.scale*c.coords.base.r*g},c.visible=0<c.coords.actuel.x+c.coords.actuel.r&&c.coords.actuel.x-c.coords.actuel.r<Blu.zoneGraphe.largeur&&0<c.coords.actuel.y+c.coords.actuel.r&&c.coords.actuel.y-c.coords.actuel.r<Blu.zoneGraphe.hauteur;for(j in Blu.carto.edges){e=Blu.carto.edges[j];d="rgba(100,100,100,0.2)";f=
!1;if(h)for(var m in k)-1!==k[m]&&(c=k[m],e.source==Blu.carto.nodes[c].id&&(l.push(e.target),d=Blu.carto.nodes[e.t],d=d.followed&&Blu.config.map.showFollowing?d.colors.green.base:d.colors.blue.base,f=!0),e.target==Blu.carto.nodes[c].id&&(l.push(e.source),d=Blu.carto.nodes[e.s],d=d.followed&&Blu.config.map.showFollowing?d.colors.green.base:d.colors.blue.base,f=!0));if((f||Blu.map.params.showEdges)&&(Blu.carto.nodes[e.s].visible||Blu.carto.nodes[e.t].visible))b.lineWidth=Blu.map.scale*g*e.weight,c=
e.s,e=e.t,c=Blu.map.params.loupeActive&&Blu.mouse.pos?Blu.fn.canvas.calcCoord(Blu.mouse.pos.x,Blu.mouse.pos.y,Blu.carto.nodes[c].coords.actuel):Blu.carto.nodes[c].coords.actuel,e=Blu.map.params.loupeActive&&Blu.mouse.pos?Blu.fn.canvas.calcCoord(Blu.mouse.pos.x,Blu.mouse.pos.y,Blu.carto.nodes[e].coords.actuel):Blu.carto.nodes[e].coords.actuel,b.strokeStyle=d,Blu.fn.map.traceArc(b,c,e)}b.lineWidth=4;if(h)for(m in k)-1!==k[m]&&(c=Blu.carto.nodes[k[m]],c.coords.reel=Blu.map.params.loupeActive&&Blu.mouse.pos?
Blu.fn.canvas.calcCoord(Blu.mouse.pos.x,Blu.mouse.pos.y,c.coords.actuel):c.coords.actuel);for(j in Blu.carto.nodes)c=Blu.carto.nodes[j],c.visible&&(j!==a&&j!==Blu.map.params.selectedNode)&&(c.coords.reel=Blu.map.params.loupeActive&&Blu.mouse.pos?Blu.fn.canvas.calcCoord(Blu.mouse.pos.x,Blu.mouse.pos.y,c.coords.actuel):c.coords.actuel,c.isFeatured=-1!==l.indexOf(c.id),b.beginPath(),e=l.length&&!c.isFeatured?"off":"base",d=c.followed&&Blu.config.map.showFollowing?"green":"blue",Blu.config.map.style.nodes.gradient?
(f=b.createRadialGradient(c.coords.reel.x,c.coords.reel.y,Blu.config.map.style.nodes.gradRadius*c.coords.reel.r,c.coords.reel.x,c.coords.reel.y,c.coords.reel.r),f.addColorStop(0,c.colors[d][e]),f.addColorStop(1,c.colors[d][e+"2"]),b.fillStyle=f):b.fillStyle=c.colors[d][e],b.arc(c.coords.reel.x,c.coords.reel.y,c.coords.reel.r,0,2*Math.PI,!0),b.closePath(),b.fill());for(j in Blu.carto.nodes)c=Blu.carto.nodes[j],c.visible&&(j!==a&&j!==Blu.map.params.selectedNode)&&(d=1*c.coords.reel.r,c.isFeatured&&
(-1!==a?80<Math.sqrt(Math.pow(c.coords.reel.x-Blu.carto.nodes[a].coords.reel.x,2)+Math.pow(c.coords.reel.y-Blu.carto.nodes[a].coords.reel.y,2))&&(d=Math.max(11,d)):d=Math.max(11,d)),9<d&&Blu.config.map.showLabels&&(g=c[Blu.config.map.nodeLabel],b.font=Math.floor(d)+"px "+Blu.config.map.style.nodes.font_family,b.textAlign="center",b.textBaseline="middle",b.fillStyle="rgba(255,255,250,0.3)",b.fillText(g,c.coords.reel.x-2,c.coords.reel.y),b.fillText(g,c.coords.reel.x+2,c.coords.reel.y),b.fillText(g,
c.coords.reel.x,c.coords.reel.y-2),b.fillText(g,c.coords.reel.x,c.coords.reel.y+2),b.fillStyle=c.id!==Blu.map.params.hoverNode&&l.length&&(!c.isFeatured||h)?"rgb(60,60,60)":"rgb(0,0,0)",b.fillText(g,c.coords.reel.x,c.coords.reel.y)));if(h)for(m in k)-1!==k[m]&&(c=Blu.carto.nodes[k[m]],g=c[Blu.config.map.nodeLabel],e="base",d=c.followed&&Blu.config.map.showFollowing?"green":"blue",b.fillStyle=c.colors[d][e],Blu.config.map.style.nodes.gradient&&(f=b.createRadialGradient(c.coords.reel.x,c.coords.reel.y,
Blu.config.map.style.nodes.gradRadius*c.coords.reel.r,c.coords.reel.x,c.coords.reel.y,c.coords.reel.r),f.addColorStop(0,c.colors[d][e]),f.addColorStop(1,c.colors[d][e+"2"]),b.fillStyle=f),b.beginPath(),b.arc(c.coords.reel.x,c.coords.reel.y,c.coords.reel.r,0,2*Math.PI,!0),b.closePath(),b.fill(),b.strokeStyle="rgba( 0, 0, 0, 0.7 )",b.lineWidth=3,b.stroke(),d=Math.max(11,1*c.coords.reel.r)+2,b.font="bold "+Math.floor(d)+"px "+Blu.config.map.style.nodes.font_family,b.textAlign="center",b.textBaseline=
"middle",b.fillStyle="rgba(255,255,250,0.8)",b.fillText(g,c.coords.reel.x-2,c.coords.reel.y),b.fillText(g,c.coords.reel.x+2,c.coords.reel.y),b.fillText(g,c.coords.reel.x,c.coords.reel.y-2),b.fillText(g,c.coords.reel.x,c.coords.reel.y+2),b.fillStyle="rgb(0,0,0)",b.fillText(g,c.coords.reel.x,c.coords.reel.y));Blu.config.map.usercards.show&&(Blu.usercards.hover.state.show||Blu.usercards.selected.state.show)&&Blu.fn.user.positionUserCard()}}};
Blu.fn.AC.hoverAC=function(){Blu.DOM.ac.find("li").removeClass("hover");var a=Blu.DOM.ac.find("#liac_"+Blu.AC.position);a.addClass("hover");"@"===a.text()[0]&&Blu.fn.map.survolNoeud(a.text())};Blu.fn.AC.changePosAC=function(a){Blu.AC.position=a;Blu.fn.AC.hoverAC()};
Blu.fn.AC.majAC=function(a){var b;a=$(a).val().toLowerCase();var c=Blu.DOM.ac,d=Blu.DOM.findUser;if(a!=Blu.AC.lastEntry||""===c.html()){Blu.AC.lastEntry=a;var e="",f=0;if(""===a){c.html("").fadeOut();return}var g=[],h,j;for(b in Blu.carto.nodes)if(h=Blu.carto.nodes[b],j=h.id.search(a),-1!=j&&0==j&&g.push({screen_name:h.id}),8<=g.length)break;if(g.length){e+="<div><ul>";for(b in g)e+='<li class="item" id="liac_'+f+'" data-posAC="'+f+'"><a href="#" data-user="'+g[b].screen_name+'"><img src="'+Blu.fn.user.getAvatarUrl(g[b].screen_name,
"mini")+'" /><span>@'+g[b].screen_name+"</span></a></li>",f++;c.html(e+"</ul></div>")}else c.hide();Blu.AC.position=0}Blu.fn.AC.hoverAC();c.css({top:d.offset().top+d.outerHeight()+"px",left:d.offset().left+"px",width:d.outerWidth()-parseInt(c.css("border-left-width"),10)-parseInt(c.css("border-right-width"),10)+"px"});c.show()};
Blu.fn.UI.lightbox={open:function(a,b,c,d){var e=$("#lightbox"),f=e.find(".box"),g=e.find(".bg"),h=e.find(".content"),j=e.find(".box > .close");"undefined"===typeof showCloseButton||d?j.show():j.hide();h.html(a);"auto"===c&&(c=h.outerHeight(!0)+30);c=Math.min(c,$(window).height()-40);f.css({left:"50%",top:"50%",width:b+"px",height:c+"px","margin-top":"-"+c/2+"px","margin-left":"-"+b/2+"px"});g.show();f.show();e.show()},close:function(){$("#lightbox").fadeOut(500)},image:function(a,b,c){var d=$(window).width(),
e=$(window).height(),d=Math.min(1,Math.min((d-40)/b,(e-50)/c));b=Math.round(d*b);c=Math.round(d*c);Blu.fn.UI.lightbox.open('<img src="'+a+'" width="'+b+'" height="'+c+'" />',b,c)},iframe:function(a,b,c){var d=$(window).width(),e=$(window).height();b=b?b:Math.min(d-40,960);c=c?c:Math.min(e-60,700);Blu.fn.UI.lightbox.open('<iframe src="'+a+'" width="'+b+'" height="'+c+'" frameborder="0"></iframe>',b,c)}};
Blu.fn.UI.popupWindow={open:function(a){a=$.extend({title:"",content:"",width:400,height:"auto",closeButton:!0,closeOverlay:!0,top:"90px",bg:"",padding:"20px",callback:function(){}},a||{});$("#popupWindow").length||$("body").append('<div id="popupWindow" class="hide"><div class="bg"></div><div class="box"><a href="#close" class="close glyph general">g</a><div class="title"></div><div class="content"><div class="wrap"></div></div></div></div>');var b=$("#popupWindow"),c=b.find(".box"),d=b.find(".bg"),
e=c.find(".title"),f=c.find(".content > .wrap");c.children(".close")[a.closeButton?"show":"hide"]();b[a.closeOverlay?"addClass":"removeClass"]("closeOverlay");f.html(a.content);e.html("<h3>"+a.title+"</h3>");d.attr("style",a.bg);c.find(".content").css("padding",a.padding);d.show();c.show();b.show();d=c.height();c.outerHeight();c.outerHeight(!0);c.width();c.outerWidth();c.outerWidth(!0);"auto"===a.height&&(b.css("visibility","hidden"),a.height=d);a.height=Math.min(a.height,$(window).height()-40);c.css({width:a.width,
margin:a.top+" auto 0",position:"relative"});b.css({visibility:"visible"});b.data("callback",a.callback)},close:function(){var a=$("#popupWindow"),b=a.find(".box");a.data("callback")();a.hide();a.find(".content > .wrap").html("");b.attr("style","")}};
Blu.fn.UI.lightbox.events=function(){$("#lightbox .bg, #lightbox .close").click(function(){var a=$("#lightbox");a.hide();a.find(".content").html("");return!1});$("#popupWindow .bg").live({click:function(){$("#popupWindow").hasClass("closeOverlay")&&Blu.fn.UI.popupWindow.close();return!1}});$('#popupWindow .close, #popupWindow a[data-action="close"]').live({click:function(){Blu.fn.UI.popupWindow.close();return!1}})};
Blu.fn.UI.openPopup=function(a,b,c,d){var e=($(window).width()-b)/2,f=($(window).height()-c)/2,g=window.open(a,"","width="+b+",height="+c+",left="+e+",top="+f),h=a+" @ "+(new Date).getTime();Blu.info('openPopup("'+a+'")');"function"===typeof d&&(Blu.timers.popups=Blu.timers.popups||{},Blu.timers.popups[h]=setInterval(function(){g&&g.closed&&(clearInterval(Blu.timers.popups[h]),delete Blu.timers.popups[h],Blu.log('Fermeture de la popup "'+h+'"'),d())},200));g&&g.focus()};
Blu.fn.UI.mapNotification=function(a){var b=$("#map-notification"),c=Blu.DOM.zc;1>b.length&&(c.append('<div id="map-notification"></div>'),b=$("#map-notification"));b.text(a).show();a||b.hide();b.css({"margin-left":"-"+parseInt(b.width()/2,10)+"px","margin-top":"-"+parseInt(b.height()/2,10)+"px"})};
Blu.fn.UI.notification=function(a){a=a||{};a.id=a.id||(new Date).getTime();var b=$("#notifications"),c=Blu.DOM.zc,d;1>b.length&&(c.append('<ul id="notifications"></ul>'),b=$("#notifications"));d=b.find("#notif-"+a.id);1>d.length&&(c="<li "+(a.id?'id="notif-'+a.id+'" ':"")+"></li>",b.prepend(c),d=b.find("#notif-"+a.id),d.hide(),d.html(a.message),d.fadeIn());a.message&&d.html(a.message);a.type&&d.attr("class",a.type);a.delayOut&&setTimeout(function(){d.fadeOut("slow",function(){d.remove()})},1E3*a.delayOut)};
Blu.fn.UI.updateBtnEdges=function(){var a=$("#btnedges");a.attr("class",Blu.map.params.showEdges?"":"off");a.attr("title",Blu.map.params.showEdges?Blu.txt("hideEdges"):Blu.txt("showEdges"))};
Blu.fn.UI.miniStats=function(a){var b=$("#mini-stats");a=a||{};a.mode=a.mode||"all";a.username=a.username||"";a.countTweets=a.countTweets||0;a.countUsers=a.countUsers||Blu.counts.users.graph;if(a.username)a.mode="user","mentions"===Blu.graphs.current.type&&b.addClass("user").removeClass("general");else{var c=null!==Blu.timeline.params.filter.dates.min||null!==Blu.timeline.params.filter.dates.max;b.removeClass("user").addClass("general");a.countTweets=!Blu.timeline.params.filter.string&&!c?Blu.counts.tweets.alltime:
Blu.counts.tweets.filter}b.find(".user-preview").text(a.username);b.find(".tweets .count").text(a.countTweets);b.find(".users .count").text(a.countUsers);1>$("h1 a.text .count").length&&$("h1 a.text").append(' <span class="count"></span>');$("h1 a.text .count").text("("+Blu.counts.tweets.alltime+" tweets)");a=$(".count-tweets-alltime .count");a.text(Blu.counts.tweets.alltime+" tweets").show();Blu.counts.tweets.alltime||a.hide()};
Blu.fn.UI.showPanel=function(a){a||(a=Blu.user.id?"users":"tweets");"users"===a&&Blu.fn.users.topUsers();var b=$("#tabs-menu"),c=b.children("."+a),d=$(".panel."+a);d.is(":visible")&&c.hasClass("selected");b.children("li").removeClass("selected");c.addClass("selected");$(".panel").fadeOut(10);d.fadeIn(200,function(){"profile"===a&&!d.find(".profile-image-aside").length&&d.find("#inputrecherche").focus()})};
Blu.fn.users.resetPanels=function(){Blu.info("Blu.fn.users.resetPanels()");Blu.config.map.usercards.show&&(Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset());$(".panel.users .wrap").html("");Blu.fn.UI.showPanel("users");Blu.fn.tweets.search("");Blu.fn.tweets.showList();Blu.fn.user.emptyProfile()};Blu.fn.UI.goHome=function(){Blu.fn.users.resetPanels();Blu.map.params.hoverNode=-1;Blu.map.params.selectedNode=-1;Blu.fn.map.resetZoom();Blu.fn.map.traceMap(!0)};
Blu.fn.user.createPanel=function(a){$("#panels").append('<li class="panel user '+a+' flying"><a class="prev-user" href="#prev-user"></a><ul class="sidebar-tabs-content"><li class="tweets"><ul class="tweets-list"></ul></li><li class="by_mentions hide"><div class="statistics"></div></li></ul></li>')};
Blu.fn.users.createPanel=function(a){Blu.log("2 utilisateurs");a='<li class="panel user '+a+' flying"><a class="toggle" href="#" title="'+Blu.txt("togglePanel")+'">&nbsp;</a><a class="bthome" href="#">HOME</a><a class="prev-user"></a><a class="main-user"></a><ul class="sidebar-tabs"></ul><ul class="sidebar-tabs-content"><li class="tweets"><ul class="tweets-list"></ul></li></ul></li>';Blu.log(a);var b=$("#panels .panel.user").filter(":last")[0],b=$(b.className);Blu.log(b.selector);Blu.DOM.zc.before(a)};
Blu.fn.user.createUserCard=function(a){Blu.info("Blu.fn.user.createUserCard()");a='<div class="user-card '+a+'"><div class="tw-status"></div><div class="profile-info"><div class="profile-image-container"><a target="_blank" class="profile-picture" href="#" title="'+Blu.txt("showTwitterProfile")+'"><img alt="" src="#"></a></div><div class="avatar-infos"><div class="full-name"><h3></h3></div><div class="screen-name-and-location"><a target="_blank" class="screen-name" href="#" title="'+Blu.txt("showTwitterProfile")+
'"></a></div><div class="location"></div></div><div class="more-infos"><div class="bio"></div><div class="url"><a href="#" target="_blank"></a></div><ul class="user-stats"><li><a href="#" target="_blank"><span class="count"></span> <span class="label">'+Blu.txt("stats_tweets")+'</span></a></li><li><a href="#" target="_blank"><span class="count"></span> <span class="label">'+Blu.txt("stats_following")+'</span></a></li><li><a href="#" target="_blank"><span class="count"></span> <span class="label">'+
Blu.txt("stats_followers")+'</span></a></li></ul></div></div><a class="bt-more" href="#more">More...</a><a class="close glyph general" href="#close">g</a></div> \x3c!-- Fin de user-card --\x3e';Blu.DOM.canvas.after(a)};
Blu.fn.user.showConversation=function(a){Blu.log("Blu.fn.user.showConversation");var b=Blu.history.length;a=a.replace("@","").toLowerCase();var b="user"+b+a,c=$("#panels .panel.user").filter(":last"),c=(!c[0]?"none":c.find(".screen-name-and-location a").html()).replace("@","").toLowerCase();if(a!==c||"none"===c)Blu.fn.users.createPanel(b),c=$(".panel.user."+b),Blu.fn.UI.showPanel(c),a!==Blu.history[Blu.history.length-1]&&Blu.fn.history.add(b)};
Blu.fn.user.positionUserCard=function(){if("undefined"===typeof Blu.usercards.hover.node)Blu.fn.usercards.reset();else{var a=Blu.usercards.selected.state.show?"selected":"hover",b=$(".user-card"),c=Blu.usercards[a];if(-1!==c.node&&(Blu.config.map.usercards.showHover||"hover"!==a)){var a=Blu.carto.nodes[c.node],d=a.coords.reel.r,e=c.position.align,f=-1!==e.search("left"),g=-1!==e.search("right"),h=-1!==e.search("bottom"),j=-1!==e.search("top"),e=-1!==e.search("custom"),k=!e?0:c.position.fromNode,k=
!e?k:k-(a.coords.reel.y-c.position.y),l=!c.state.locked&&c.state.expanded;f||!g&&a.coords.reel.x>Blu.zoneGraphe.largeur-b.outerWidth()-Blu.config.map.usercards.distance-d?(c.position.x=a.coords.reel.x-b.outerWidth()-Blu.config.map.usercards.distance-d,c.position.align="left"):(c.position.x=a.coords.reel.x+Blu.config.map.usercards.distance+d,c.position.align="right");h&&!l||h&&l&&c.position.y+b.outerHeight()>Blu.zoneGraphe.hauteur||j&&l&&0>c.position.y||!j&&a.coords.reel.y<b.outerHeight()+Blu.config.map.usercards.distance+
d?(c.position.y=a.coords.reel.y+Blu.config.map.usercards.distance+d,c.position.align+=" bottom"):(e||j&&l&&c.position.y+b.outerHeight()<Blu.zoneGraphe.hauteur||j&&0>a.coords.reel.y-b.outerHeight()-Blu.config.map.usercards.distance-d?(c.position.y-=k,c.position.align+=" custom"):c.position.y=a.coords.reel.y-b.outerHeight()-Blu.config.map.usercards.distance-d,c.position.align+=" top");c.position.fromNode=!c.state.locked?a.coords.reel.y-c.position.y:c.position.fromNode;b.css({left:c.position.x+"px",
top:c.position.y+"px"})}}};
Blu.fn.user.showUserCard=function(a){Blu.log("Blu.fn.user.showUserCard");var b=a.replace("@","").toLowerCase();Blu.fn.user.createUserCard(b);var c=Blu.DOM.zc.find(".user-card."+b),d=Blu.usercards.selected;c.find(".profile-info, .tw-status").hide();c.spin("small");c.addClass("loading");d.state.expanded&&c.addClass("expanded");Blu.fn.user.get(b).data.id?Blu.fn.user.fillUsercard(Blu.users[b].data,b):Blu.fn.app.twitterAuthRequest("users/show",{screen_name:a},function(a){a="undefined"===typeof a.code?
a:a.response;a.error||Blu.fn.user.fillUsercard(a,b)});Blu.fn.user.positionUserCard()};
Blu.fn.user.showProfile=function(a,b){Blu.info("showProfile > "+a);Blu.fn.map.selectUser(a,"click-map"!==(b||""));a=a.replace("@","").toLowerCase();Blu.config.users.profilePopUp?Blu.fn.UI.openPopup("https://twitter.com/intent/user?screen_name="+a,550,550):(Blu.fn.user.emptyProfile(),Blu.config.UI.mobile&&$("#panels-wrapper").show(),Blu.fn.UI.showPanel("profile"),Blu.fn.user.get(a).data.id_str?Blu.fn.user.fillProfile(Blu.users[a].data):($(".panel.profile").spin("sidebar"),Blu.fn.app.twitterAuthRequest("users/show",
{screen_name:a},Blu.fn.user.fillProfile)))};Blu.fn.user.lookupTopUsers=function(a){Blu.info("Blu.fn.user.lookupTopUsers...");var b={in_sidebar:[],others:[]},c,d;if(a.length){for(var e in a)d=a[e].user,c=b[36>e?"in_sidebar":"others"],Blu.fn.user.get(d).data.id_str||c.push(d);Blu.fn.users.lookup(b.in_sidebar,function(){Blu.fn.users.lookup(b.others,function(){Blu.fn.map.calcFollowed()});Blu.fn.map.calcFollowed()})}else Blu.warn("Users lookup: no users.")};
Blu.fn.map.lookupUsers=function(){if(Blu.carto){var a=[],b,c;for(c in Blu.carto.nodes)b=Blu.carto.nodes[c],Blu.fn.user.get(b.id).data.id_str||a.push(b.id);Blu.warn("Users lookup: looking for "+a.length+" users on this map...");Blu.fn.users.lookup(a,function(a){a.error||Blu.fn.map.calcFollowed()},!1)}};
Blu.fn.users.lookup=function(a,b,c){b={screen_names:a,offset:0,num_items:100,results:[],callback:b||{},ajax_id:"start-"+(new Date).getTime(),sequential:"undefined"!==typeof c?c:!1};Blu.info("Blu.fn.users.lookup... >> looking for "+a.length+" users");Blu.log(b);1>a.length?Blu.warn("Users lookup : no users. We stop here."):(Blu.ajax=Blu.ajax||{},Blu.ajax[b.ajax_id]={requests:[],countResults:0},Blu.fn.users.lookup_request(b))};
Blu.fn.users.lookup_request=function(a){var b=Math.min(a.offset+a.num_items-1,a.screen_names.length),c=a.screen_names.slice(a.offset,b);if(!a.sequential){var d=$.extend({},a);d.offset=b+1;d.offset<a.screen_names.length&&Blu.fn.users.lookup_request(d)}b=Blu.fn.app.twitterAuthRequest("users/lookup",{screen_name:c.toString()},function(c){var b=c.response;if(200!==c.code||b.errors||b.error)"function"===typeof a.callback&&a.callback(b);else{for(var d in b)c=b[d],Blu.fn.users.add(c),h=$(".user-list .rank-user."+
c.screen_name.toLowerCase()),h.find(".user-content span").text(c.name),h.find(".profile-pic img").attr("src",Blu.fn.user.getAvatarUrl(c.screen_name,"bigger"));Blu.warn("Users lookup: "+b.length+" users have been added.");d=a.offset+a.num_items;if(d<a.screen_names.length&&a.sequential)a.offset=d,Blu.fn.users.lookup_request(a);else{var h;"function"===typeof a.callback&&a.callback(b)}}});Blu.ajax[a.ajax_id].requests.push(b)};
Blu.fn.users.events=function(){Blu.DOM.findUser.live({keyup:function(){Blu.fn.AC.majAC(this);""===$(this).val()&&Blu.fn.UI.miniStats({countTweets:Blu.counts.tweets.filter,countUsers:Blu.counts.users.graph})},keydown:function(a){var b=Blu.DOM.ac,c=b.find("li").length;switch(a.keyCode){case 40:Blu.AC.position<c-1?Blu.AC.position++:Blu.AC.position=0;break;case 38:0<Blu.AC.position?Blu.AC.position--:Blu.AC.position=c-1;break;case 27:b.fadeOut();break;case 13:b.is(":visible")?(Blu.warn("[Enter] on autocomplete"),
b=$("#liac_"+Blu.AC.position),b.length&&$(this).val(b.find("span").text())):Blu.warn("[Enter] on autocomplete : AC not visible");break;default:Blu.AC.position=0}Blu.fn.AC.majAC(this);if(38===a.keyCode||40===a.keyCode)return!1},blur:function(){var a=Blu.DOM.ac;a.length&&setTimeout(function(){a.hide()},100)}});$("#recherche").submit(function(){var a=$(this).find("#inputrecherche");Blu.config.map.usercards.show&&(Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset(),Blu.usercards.selected.state.show=
!0);Blu.fn.user.showProfile(a.val());Blu.DOM.ac.hide();Blu.DOM.zc.find(".find-user").trigger("click");Blu.config.map.usercards.show&&Blu.fn.user.showUserCard(a.val());return!1})};Blu.fn.user.getFollowing=function(a){var b={},c=Blu.user.screen_name;c?(b.screen_name=c,b.cursor=-1,b.user_ids=[],b.callback=a||{},Blu.log("Let's see who @"+c+" is following..."),Blu.is.getFollowing=Blu.is.getFollowing||{},Blu.is.getFollowing[b.screen_name]=!0,Blu.fn.user.getFollowing_request(b)):Blu.warn("Logged out visitor: no following to look for.")};
Blu.fn.user.getFollowing_request=function(a){Blu.fn.app.twitterAuthRequest("friends/ids",{screen_name:a.screen_name,cursor:a.cursor,stringify_ids:!0},function(b){b="undefined"!==typeof b.code?b.response:b;b.error?"function"===typeof a.callback&&a.callback():(a.user_ids=a.user_ids.concat(b.ids),"0"!==b.next_cursor_str?(a.cursor=b.next_cursor_str,Blu.fn.user.getFollowing_request(a)):(Blu.is.getFollowing[a.screen_name]=!1,Blu.user.following.isLoaded=!0,Blu.user.following.list=a.user_ids,Blu.warn("@"+
a.screen_name+" follows "+Blu.user.following.list.length+" users (in general)"),"function"===typeof a.callback&&a.callback()))})};Blu.fn.user.isFollowed=function(a){if(1>Blu.user.following.list.length)return!1;a=Blu.fn.user.get(a);return a.data.id_str&&-1!==$.inArray(a.data.id_str,Blu.user.following.list)};Blu.fn.user.follow=function(a,b){Blu.info('Blu.fn.user.follow("'+a+'")');Blu.fn.app.twitterAuthRequest("friendships/create",{screen_name:a},function(a){"function"===typeof b&&b(a)})};
Blu.fn.user.unfollow=function(a,b){Blu.info('Blu.fn.user.unfollow("'+a+'")');Blu.fn.app.twitterAuthRequest("friendships/destroy",{screen_name:a},function(a){Blu.log(a);"function"===typeof b&&b(a)})};
Blu.fn.UI.followButton=function(a,b){if(!Blu.user.following.isLoaded)return Blu.fn.user.twitterFollowButton(a);var c="";return c=("undefined"===typeof b?Blu.fn.user.isFollowed(a):b)?'<a href="#unfollow" class="follow-button-api followed" data-user="'+a+'" data-text-change="'+Blu.txt("unfollowButton")+'" >'+Blu.txt("following")+"</a>":'<a href="#follow" class="follow-button-api unfollowed" data-user="'+a+'" data-text-change="'+Blu.txt("followButton")+'" >'+Blu.txt("followButton")+"</a>"};
$.fn.setFollowButton=function(a,b){if(!Blu.user.following.isLoaded&&"undefined"===typeof b)return this;("undefined"===typeof b?Blu.fn.user.isFollowed(a):b)?(this.data({action:"unfollow",user:a,"text-change":Blu.txt("unfollowButton")}),this.addClass("followed").removeClass("unfollowed"),this.children(".text").text(Blu.txt("following"))):(this.data({action:"follow",user:a,"text-change":Blu.txt("followButton")}),this.addClass("unfollowed").removeClass("followed"),this.children(".text").text(Blu.txt("followButton")));
return this};Blu.fn.user.activateFollowingMode=function(){Blu.user.screen_name?(Blu.config.map.showFollowing=!0,Blu.fn.user.getFollowing(),$("#options-map #following-mode").addClass("activated")):Blu.warn("Following Mode can't be activated (logged out visitor).")};Blu.fn.user.deactivateFollowingMode=function(){Blu.config.map.showFollowing=!1;$("#options-map #following-mode").removeClass("activated")};
Blu.fn.user.followEvents=function(){$("#options-map #following-mode").live("click",function(){Blu.config.map.showFollowing?(Blu.fn.user.deactivateFollowingMode(),mixpanel.track("Hide Following")):(Blu.fn.user.activateFollowingMode(),mixpanel.track("Show Following"));Blu.fn.map.traceMap(!0);Blu.fn.UI.updateNodesCounts();return!1});$(".user-actions .follow a").live({click:function(){var a=$(this),b=a.data("action");if(a.hasClass("locked")||-1===$.inArray(b,["follow","unfollow"]))return!1;a.setFollowButton(a.data("user"),
"follow"===b);a.addClass("locked");"follow"===b?Blu.fn.user.follow(a.data("user"),function(c){if(200==c.code){c=Blu.fn.user.get(a.data("user")).data;var b=c.id_str;b&&Blu.user.following.list.push(b);c.following=!0;Blu.fn.map.calcFollowed();a.addClass("unlocked");mixpanel.track("Follow User",{User:a.data("user")})}else a.setFollowButton(a.data("user"),!1)}):"unfollow"===b&&Blu.fn.user.unfollow(a.data("user"),function(c){if(200==c.code){c=Blu.fn.user.get(a.data("user")).data;var b=$.inArray(c.id_str,
Blu.user.following.list);-1!=b&&Blu.user.following.list.splice(b,1);c.following=!1;Blu.fn.map.calcFollowed();a.addClass("unlocked");mixpanel.track("Unfollow User",{User:a.data("user")})}else a.setFollowButton(a.data("user"),!0)});return!1},mouseover:function(){var a=$(this);if(a.hasClass("locked"))return!1;a.addClass("hover");a.data("text-original",a.children(".text").text());a.data("text-change")&&a.children(".text").text(a.data("text-change"))},mouseout:function(){var a=$(this);if(a.hasClass("unlocked"))return a.removeClass("locked unlocked"),
!1;a.removeClass("hover");a.data("text-original")&&a.children(".text").text(a.data("text-original"))}});$(".follow-button-api").live({click:function(){var a=$(this),b,c=a.data("action");if(a.hasClass("locked")||-1===$.inArray(c,["follow","unfollow"]))return!1;a.after(Blu.fn.UI.followButton(a.data("user"),"follow"===c));a.hide();b=a.next(".follow-button-api");b.addClass("locked");"follow"===c?Blu.fn.user.follow(a.data("user"),function(c){200==c.code?((c=Blu.fn.user.get(a.data("user")).data.id_str)&&
Blu.user.following.list.push(c),Blu.fn.map.calcFollowed(),b.addClass("unlocked"),a.remove(),mixpanel.track("Follow User",{User:a.data("user")})):(a.show(),b.remove())}):"unfollow"===c&&Blu.fn.user.unfollow(a.data("user"),function(c){200==c.code?(c=Blu.fn.user.get(a.data("user")),c=$.inArray(c.data.id_str,Blu.user.following.list),-1!=c&&Blu.user.following.list.splice(c,1),Blu.fn.map.calcFollowed(),b.addClass("unlocked"),a.remove(),mixpanel.track("Unfollow User",{User:a.data("user")})):(a.show(),b.remove())});
return!1},mouseover:function(){var a=$(this);if(a.hasClass("locked"))return!1;a.addClass("hover");a.data("text-original",a.text());a.data("text-change")&&a.text(a.data("text-change"))},mouseout:function(){var a=$(this);if(a.hasClass("unlocked"))return a.removeClass("locked unlocked"),!1;a.removeClass("hover");a.data("text-original")&&a.text(a.data("text-original"))}})};
Blu.fn.app.twitterAuthRequest=function(a,b,c){var d={api_function:a,api_params:b,refresh:Math.random()},e=$.getJSON(Blu.app.urls.main+"/twitter-api",d,function(a,b,d){d.isDone=!0;d.tw_api.ended_at=new Date;d.tw_api.duration=(d.tw_api.ended_at-d.tw_api.started_at)/1E3;Blu.info(e.tw_api.func+" > ends   "+e.tw_api.params+"... @ "+Blu.fn.misc.timeHour(e.tw_api.ended_at)+" ("+d.tw_api.duration+"s)");Blu.log(a);a||(a={code:0,response:{}});a.code||(a.code=0);"function"===typeof c&&c(a,b,d)});e.tw_api={func:a,
params:JSON.stringify(b).slice(0,50),started_at:new Date};Blu.info(e.tw_api.func+" > starts "+e.tw_api.params+"... @ "+Blu.fn.misc.timeHour(e.tw_api.started_at));return e};Blu.fn.user.emptyProfile=function(){var a=$(".panel.profile").find(".profile-info, .tw-status");a.html("");a.hide()};
Blu.fn.UI.getProfileTemplate=function(){if(Blu.templates.profile)return Blu.templates.profile;Blu.templates.profile='<a class="btn btn-small btn-primary visualize-map f-right" title="Visualize this user">Map</a><div class="profile-image-container"><a class="profile-picture" href="#" target="_blank" title="'+Blu.txt("showTwitterProfile")+'"><img alt="" src="'+Blu.images.default_user+'"></a></div><div class="profile-image-aside"><a class="name" href="#" target="_blank" title="'+Blu.txt("showTwitterProfile")+
'"><strong class="fullname"></strong><span class="screen-name"></span></a><p class="bio"></p><span class="location"></span><span class="divider">\u00b7</span><a class="url" href="#" target="_blank"></a><ul class="user-stats"><li class="tweets"><a href="#" target="_blank"><span class="count"></span> <span class="label">'+Blu.txt("stats_tweets")+'</span></a></li><li class="following"><a href="#" target="_blank"><span class="count"></span> <span class="label">'+Blu.txt("stats_following")+'</span></a></li><li class="followers"><a href="#" target="_blank"><span class="count"></span> <span class="label">'+
Blu.txt("stats_followers")+'</span></a></li></ul></div><ul class="user-actions"><li class="follow"><a href="#"><span class="ico"></span><span class="text">Follow</span></a></li><li class="mention"><a href="#"><span class="ico"></span><span class="text">Mention</span></a></li></ul>\x3c!--<p class="full-profile"><a href="#" target="_blank">Go to full profile \u2192</a></p>--\x3e';return Blu.templates.profile};
Blu.fn.UI.getPleaseConnectTemplate=function(){if(Blu.templates.pleaseConnect)return Blu.templates.pleaseConnect;Blu.templates.pleaseConnect='<div class="please-connect-msg"><p>Please connect your Twitter account in order to explore user profiles.</p><p class="align-center"><a class="btn btn-primary twitter-connect" data-action="connect-visitor" href="#twitter-connect">Connect with Twitter</a></p></div>';return Blu.templates.pleaseConnect};
Blu.fn.user.fillProfile=function(a){a=a||{};a.screen_name&&(a.code=200);var b=a.response||a;Blu.info("Blu.fn.user.fillProfile avec pour donn\u00e9es :");Blu.log(a);Blu.fn.users.add(b);var c=$(".panel.profile");c.spinStop();c.find(".profile-info").html(Blu.fn.UI.getProfileTemplate()).hide();var c=c.find(".twitter-panel"),d=c.find(".tw-status"),e=c.find(".profile-info"),f=c.find(".profile-image-aside"),g=c.find(".user-actions");c.find(".tweets-list");if(200!==a.code)if(Blu.user.id){var h="Sorry, we couln't get data from Twitter.";
404===a.code?h='Sorry, that user does not exist.<span class="detail">It may have been deleted or the username was just misspelled.</span>':b.errors&&(b.errors[0]&&b.errors[0].message)&&(h=b.errors[0].message);d.html(h).fadeIn();c.spinStop()}else e.html(Blu.fn.UI.getPleaseConnectTemplate()).removeClass("profile-info").show();else{a=b.screen_name.toLowerCase();var d="http://twitter.com/"+b.screen_name,j="undefined"!==typeof b.profile_image_url?Blu.fn.user.getAvatarUrl(b.screen_name,"bigger"):Blu.images.default_user;
c.find(".profile-picture img").attr("src",j);c.find(".profile-picture, a.name, .full-profile a").attr("href",d);f.find(".fullname").text(b.name);f.find(".screen-name").text("@"+b.screen_name);f.find(".bio").text(b.description);f.find(".location").text(b.location);b.url&&f.find(".url").attr("href",b.url).text(b.url.replace(/^https?:\/\/(www.)?/,""));b.location&&b.url&&f.find(".divider").show();f=c.find(".user-stats");f.find("li.tweets a").attr("href",d).find(".count").text(b.statuses_count);f.find("li.following a").attr("href",
d+"/following").find(".count").text(b.friends_count);f.find("li.followers a").attr("href",d+"/followers").find(".count").text(b.followers_count);Blu.user.screen_name.toLowerCase()!==a?g.find("li.follow a").setFollowButton(a,b.following):g.find("li.follow").hide();g.find("li.visualize a").attr("href",Blu.fn.user.visualizeLink(a));g.find("li.visualize a").data("user",b.screen_name);e.find(".visualize-map").attr("href",Blu.fn.user.visualizeLink(a));e.find(".visualize-map").data("user",b.screen_name);
g.find("li.mention a").data("prefill-tweet","@"+b.screen_name+" ");g=Blu.fn.tweets.find({string:a});f=Blu.fn.users.topUsers(g,a).user.mentions;0<f.length&&(e.append('<div class="extra-data"><h3>Connections</h4>'+Blu.fn.users.listUsers({theClass:"topUsers by_mentions",userRanked:"User",numberTitle:"Mentions",tab:f.slice(0,14)})+"</div>"),Blu.fn.user.lookupTopUsers(f));if(0<g.length){f="";for(h in g)f+=Blu.fn.tweet.display(g[h]);e.append('<div class="extra-data"><h3>'+g.length+" "+(1<g.length?"tweets":
"tweet")+" with @"+b.screen_name+'</h4><ul class="tweets-list">'+f+"</ul></div>")}c.spinStop();e.show();Blu.log("fin de Blu.fn.user.fillProfile")}};Blu.fn.timers.resetInterval=function(a){"undefined"!==typeof Blu.timers[a]&&(clearInterval(Blu.timers[a]),Blu.timers[a]=0)};Blu.fn.timers.resetTimeout=function(a){"undefined"!==typeof Blu.timers[a]&&(clearTimeout(Blu.timers[a]),Blu.timers[a]=0)};
Blu.fn.user.fillUsercard=function(a,b){Blu.info("Blu.fn.user.fillUsercard()");if(a.screen_name){var c=a.statuses_count,d=a.friends_count,e=a.followers_count,f=a.listed_count,g=a.screen_name.toLowerCase(),h="http://twitter.com/"+a.screen_name,j=a.profile_image_url?a.profile_image_url:Blu.images.default_user,k=Blu.DOM.zc.find(".user-card."+b),l=k.find(".avatar-infos"),m=k.find(".more-infos"),n=k.find(".close");k.spinStop();k.removeClass("loading");Blu.fn.users.add(a);k.find(".profile-picture img").attr("src",
j);k.find(".profile-picture").attr("href",h);k.find("a.screen-name").attr("href",h);a.name&&l.find(".full-name h3").text(a.name);l.find(".screen-name").text("@"+a.screen_name);l.find(".location").text(a.location);m.find(".bio").text(a.description);a.url&&m.find(".url a").text(a.url).attr("href",a.url);m.after(Blu.fn.UI.followButton(a.screen_name));Blu.fn.user.renderFollowButtons();j=k.find(".user-stats");j.find("li:nth-child(1) .count").text(c);j.find("li:nth-child(2) .count").text(d);j.find("li:nth-child(3) .count").text(e);
j.find("li:nth-child(4) .count").text(f);j.find("li:nth-child(1) a").attr("href",h);j.find("li:nth-child(2) a").attr("href",h+"/following");j.find("li:nth-child(3) a").attr("href",h+"/followers");j.find("li:nth-child(4) a").attr("href",h+"/lists/memberships");k.find(".profile-info").fadeIn();Blu.user.can.oneClickMapUser&&n.before('<a class="visualize-map button-gray" href="'+Blu.fn.user.visualizeLink(g)+'" title="'+("Visualize the Twitter Community of @"+g)+'" data-user="'+g+'" target="_blank">Visualize</a>')}Blu.log("fin de Blu.fn.user.fillUsercard")};
Blu.fn.user.visualizeLink=function(a){return Blu.app.urls.main+"/user/"+a.toLowerCase()};$(".user-actions .visualize a, .visualize-map").live("click",function(a){a.stopPropagation();if(!Blu.user.can.oneClickMapUser)return Blu.fn.UI.popupEnterYourMail(),!1;a=$(this).data("user");mixpanel.track("Button: Visualize User",{User:a});Blu.fn.project.create({type:"search-user",twitter_screen_name:a});return!1});
Blu.fn.user.twitterFollowButton=function(a){return'<a class="twitter-follow-button" href="https://twitter.com/'+a+'" data-show-count="false" data-align="right" data-lang="'+Blu.lang+'" data-show-screen-name="false"></a>'};
Blu.fn.user.twitterFollowButtonIframe=function(a){return'<iframe class="twitter-follow-button" allowtransparency="true" frameborder="0" scrolling="no"  src="https://platform.twitter.com/widgets/follow_button.html?'+("screen_name="+a+"&show_count=false&show_screen_name=false&lang="+Blu.lang)+'"></iframe>'};Blu.fn.user.renderFollowButtons=function(){"undefined"===typeof twttr||"undefined"===typeof twttr.widgets?$.getScript("http://platform.twitter.com/widgets.js",function(){twttr.widgets.load()}):twttr.widgets.load()};
Blu.fn.tweet.loadTextFunctions=function(a){var b=function(){"function"===typeof a&&a()};"undefined"===typeof twttr||"undefined"===typeof twttr.txt?(Blu.log("Premier chargement de twitter-text.js"),$.getScript(Blu.app.urls.main+"/js/twitter/twitter-text-1.5.0.min.js",b)):(Blu.log("twitter-text.js est d\u00e9j\u00e0 charg\u00e9"),b())};Blu.fn.connect={};Blu.fn.connect.twitter={};
Blu.fn.connect.twitter.authorize=function(a){var b=Blu.app.urls.main+"/connect/twitter";"connect-visitor"===a.action&&(b+="?action="+a.action);Blu.fn.UI.openPopup(b,700,550,function(){Blu.fn.connect.twitter.afterOAuthProcess(a)})};
Blu.fn.connect.twitter.afterOAuthProcess=function(a){a=$.extend({action:"",callback:null},a||{});$.getJSON(Blu.app.urls.ajax_base,{action:"get-twitter-connect-info",refresh:Math.random()},function(b){Blu.user.user_id==b.user_id&&Blu.user.screen_name===b.screen_name?b["twitter-connect-denied"]&&Blu.fn.UI.notification({message:Blu.txt("twitter-connect-denied"),type:"fail",id:"twitter-connect",delayOut:8}):(Blu.user=$.extend(Blu.fn.user.getDefaultUser(),b),Blu.user.screen_name&&Blu.user.user_id?$("body").removeClass("tw-unconnected").addClass("tw-connected"):
$("body").removeClass("tw-connected").addClass("tw-unconnected"),Blu.fn.UI.mainMenu(),Blu.fn.UI.menuAccount(),$("#account").hide(),Blu.user.screen_name?Blu.txt("twitter-connect-success","@"+Blu.user.screen_name):Blu.txt("twitter-disconnect"),Blu.fn.UI.popupWindow.close(),"function"===typeof a.callback&&a.callback())})};
Blu.fn.UI.menuAccount=function(){var a=[];Blu.user.id&&(Blu.config.clientMode&&a.push('<li><a class="my-searches" href="#">My Searches</a></li>'),Blu.user.isFromTeam&&a.push('<li><a class="new-fb-search" href="#">Facebook Search</a></li>'),Blu.user.can.createPremiumProjects&&a.push('<li><a href="'+Blu.app.urls.main+'/my-maps">Bluenod Pro</a></li>'),a.length&&a.push('<li class="divider"></li>'),Blu.user.can.createHashtagSearch&&(a.push('<li><a href="'+Blu.app.urls.main+'/settings">Settings</a></li>'),
a.push('<li class="divider"></li>')),a.push('<li><a href="'+Blu.app.urls.main+'/about">About</a></li>'),a.push('<li class="divider"></li>'),a.push('<li><a href="'+Blu.app.urls.main+'/tos">Terms of Service</a></li>'),a.push('<li><a href="'+Blu.app.urls.main+'/privacy">Privacy Policy</a></li>'),a.push('<li class="divider"></li>'),a.push('<li><a class="logout" href="'+Blu.app.urls.main+"/logout?redirect="+encodeURIComponent(document.URL)+'">Log out</a></li>'));var b=$("#main-menu .dropdown");b.find(".dropdown-menu").html(a.join(""));
b.find(".dropdown-toggle").dropdown()};
Blu.fn.UI.mainMenu=function(){var a=$("#barre"),b=a.find("#titre"),c=a.find("#main-menu"),d="";c.length||(b.after('<ul id="main-menu"></ul>'),c=a.find("#main-menu"));Blu.user.screen_name&&(d+='<li class="dropdown"><a class="settings dropdown-toggle" id="account-toggle" href="#settings" role="button" data-toggle="dropdown"><img src="'+(Blu.user.profile_image_url||"https://api.twitter.com/1/users/profile_image?size=mini&screen_name="+Blu.user.screen_name)+'" /><span>'+Blu.user.screen_name+'</span><b class="caret"></b></a><ul class="dropdown-menu pull-right" role="menu" aria-labelledby="account-toggle"></ul></li>');
c.html(d);Blu.config.clientMode&&1>a.find(".new-search").length&&(a=Blu.user.can.createHashtagSearch?"Search for a @username or a #hashtag":Blu.txt("enter-search-user"),c.after('<input type="text" class="new-search" data-type="search-user" placeholder="'+a+'"/>'))};
Blu.fn.UI.createGraphBottom=function(){Blu.DOM.zc.before('<div id="graph-bottom"><ul><li><ul class="count-nodes"><li class="total" title="Users on the map"><span class="count"></span><span class="title">Users</span><span class="img"></span></li><li class="following" title="People you follow"><span class="count"></span><span class="title">Following</span></li><li class="not-following" title="People you don\'t follow"><span class="count"></span><span class="title">Not Following</span></li></ul></li><li class="feedback"><a href="javascript:UserVoice.showPopupWidget();">Feedback</a></li><li class="tour"><a href="#tour">Tour</a></li></ul></div>');Blu.DOM.gBottom=
$("#graph-bottom");Blu.fn.UI.updateNodesCounts()};
Blu.fn.UI.createGraphHeader=function(){var a=[],b="";Blu.user.can.exportTopUsersCsv&&(Blu.projects.current.id&&Blu.projects.current.dates.max&&new Date>Blu.fn.misc.dateStringToObject(Blu.projects.current.dates.max,0))&&a.push('<a class="export-users-csv" href="#export-users-csv">Export Top Users (CSV)</a>');Blu.DOM.zc.before('<div id="graph-header"><ul><li class="count-tweets-alltime"><span class="count"></span></li><li id="timemachine-zone"><div class="tm-side left"><div class="date"><span class="day"></span><span class="hour"></span></div></div><div id="time-machine"><ul id="tm-title"><li class="interval min"></li><li class="graph min"></li><li class="graph max"></li><li class="interval max"></li><li class="timetravel"></li></ul><canvas id="mini-timeline" width="0" height="0"></canvas></div><div class="tm-side right"><div class="date"><span class="day"></span><span class="hour"></span></div></div></li><li class="actions-project dropdown"><a class="dropdown-toggle" id="toggle-actions-project" href="#" role="button" data-toggle="dropdown"><span class="glyph general">a</span></a><ul class="dropdown-menu pull-right" role="menu" aria-labelledby="toggle-actions-project"></ul></li></ul></div>');Blu.DOM.gHeader=
$("#graph-header");Blu.DOM.tmZone=Blu.DOM.gHeader.find("#timemachine-zone");Blu.DOM.tm=Blu.DOM.tmZone.find("#time-machine");Blu.DOM.tmSideLeft=Blu.DOM.tmZone.find(".tm-side.left");Blu.DOM.tmSideRight=Blu.DOM.tmZone.find(".tm-side.right");Blu.DOM.tmTitle=Blu.DOM.tmZone.find("#tm-title");Blu.DOM.tmTip=Blu.DOM.tmZone.find("#time-machine-tip");Blu.DOM.tmDate=Blu.DOM.tmZone.find("#time-machine-date");Blu.DOM.miniTimeline=Blu.DOM.tmZone.find("#mini-timeline");Blu.DOM.tmGraphMin=Blu.DOM.tmTitle.find(".graph.min");
Blu.DOM.tmGraphMax=Blu.DOM.tmTitle.find(".graph.max");Blu.DOM.tmTimeTravel=Blu.DOM.tmTitle.find(".timetravel");for(var c in a)b+="<li>"+a[c]+"</li>";a.length&&(c=Blu.DOM.gHeader.find("li.actions-project"),a=c.find(".dropdown-menu"),c=c.find(".dropdown-toggle"),a.html(b),c.show(),c.dropdown())};
Blu.fn.UI.updateNodesCounts=function(){var a=$("#graph-header, #graph-bottom").find(".count-nodes"),b=Blu.carto&&Blu.carto.nodes?Blu.carto.nodes.length:0,c=Blu.graphs.current.followedNodes||0,d=b-c;1>a.length||(a.find("li.following .count").text(c),a.find("li.not-following .count").text(d),a.find("li.total .count").text(b),Blu.config.map.showFollowing?a.find("li").show():(a.find("li").hide(),a.find("li.total").show()))};
Blu.fn.UI.bindEvents=function(){Blu.fn.users.events();var a=Blu.DOM.canvas;a.mousemove(function(a){a.stopPropagation();Blu.fn.canvas.mouseMove(a,"mousemove")}).click(function(a){a.stopPropagation();Blu.fn.canvas.click(a)}).mousedown(function(a){a.stopPropagation();Blu.fn.canvas.startMoving(a)}).mouseout(function(a){a.stopPropagation();Blu.mouse.pos=null;Blu.fn.canvas.endMoving(a)}).mousewheel(function(a,b,e,f){a.stopPropagation();Blu.fn.map.scrollMap(a,b,e,f)});document.body.addEventListener("touchmove",
function(a){a.preventDefault()},!1);if(1===Blu.user.id){var b=$(".panel:visible > .wrap");a.hammer({drag_lock_to_axis:!1}).on({transform:function(a){a.stopPropagation();b.html("Transform <br/>"+Blu.fn.touch.logGesture(a));Blu.fn.map.pinchMap(a)},transformstart:function(a){b.html("TransformStart<br/>"+Blu.fn.touch.logGesture(a));Blu.touch.startZoomLevel=Blu.map.params.zoomLevel;Blu.touch.startMapCenterX=Blu.map.params.centreX;Blu.touch.startMapCenterY=Blu.map.params.centreY},transformend:function(a){b.html("TransformEnd <br/>"+
Blu.fn.touch.logGesture(a))},drag:function(a){a.stopPropagation();Blu.fn.canvas.mouseMove(a,"drag")},dragstart:function(a){a.stopPropagation();Blu.fn.canvas.startMoving(a)},dragend:function(a){a.stopPropagation();Blu.mouse.pos=null;Blu.fn.canvas.endMoving(a)}})}Blu.fn.usercards.events();Blu.DOM.miniTimeline.mousemove(Blu.fn.timemachine.mouseMove).mousedown(Blu.fn.canvas.startMoving).mouseup(Blu.fn.timemachine.endMoving).mouseout(Blu.fn.timemachine.endMoving);$("#ctlzoom .zoom").click(function(a){a.stopPropagation();
var b=$(this).hasClass("in")?2:-2;Blu.fn.map.zoom(a,b);$(this).blur();return!1});$("#ctlzoom .find-user").click(function(a){a.stopPropagation();a=$(this);var b=a.siblings(".research"),e=b.find("#inputrecherche");b.toggle();a.toggleClass("selected");$(this).blur();e.val("");e.focus();return!1});"#tags"===document.location.hash&&$("#lien_tags").click();$("#btnedges").click(function(){Blu.map.params.showEdges=!Blu.map.params.showEdges;Blu.fn.UI.updateBtnEdges()});$("#sidebar-menu .bthome a, #ctlzoom .home").live({click:function(){Blu.fn.UI.goHome();
mixpanel.track("Button: Back Home");$(this).blur();return!1}});$(".prev-user").live({click:function(){var a=$(this),b=a.parents(".panel"),e=$("#panels"),f=$("#mini-stats"),g=Blu.history[Blu.history.length-2];Blu.config.map.usercards.show&&(Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset(),Blu.usercards.selected.state.show=!0,Blu.fn.user.showUserCard(g));Blu.fn.map.selectUser(g);f.find("li").removeClass("selected");b.hasClass("showed")?(e.animate({left:"+="+b.width()+"px"},"slow","easeOutCubic",
function(){Blu.log($(this));a.addClass("show-panel");b.remove()}),Blu.history.pop(),Blu.DOM.findUser.val(g)):Blu.fn.UI.showPanel(b);return!1}});$("#mini-stats a").live({click:function(){var a=$(this),b=a.attr("href").replace("#",""),e=a.parents(".numbers"),f=a.parents("#sidebar-menu"),g=$("#panels").find(".panel:last").find(".sidebar-tabs-content");f.children("li").removeClass("selected");e.children("li").removeClass("selected");e.children("li."+b).addClass("selected");g.children("li").addClass("hide");
g.children("li."+b).removeClass("hide");a.blur();return!1}});$("#tabs-menu a").live({click:function(a){a.stopPropagation();a=$(this);var b=a.attr("href").replace("#","");$("#panels").find(".panel."+b);"users"===b&&Blu.fn.UI.goHome();Blu.fn.UI.showPanel(b);a.blur();return!1}});$(".tweets-list .tweet h4 a, .rank-user h4 a, .profile-pic .avatar, p.tweet-text a.mention").live({click:function(a){a.stopPropagation();var b=$(this);a=b.data("user")?b.data("user"):b.find("a").data("user")||"";b=b.parents(".tweet").length?
"Tweet":"User";_miniStats=$("#mini-stats");_miniStats.find("li").removeClass("selected");_miniStats.find(".tweets").addClass("selected");if(!a)return!1;Blu.config.map.usercards.show&&(Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset(),Blu.usercards.selected.state.show=!0);Blu.fn.user.showProfile(a);mixpanel.track("Show Profile (via "+b+")",{User:a});Blu.config.map.usercards.show&&Blu.fn.user.showUserCard(a);return!1},mouseover:function(a){a.stopPropagation();$(this).data("user")?Blu.fn.map.survolNoeud("@"+
$(this).data("user")):Blu.fn.map.survolNoeud("@"+$(this).find("a").data("user"))},mouseout:function(a){a.stopPropagation();Blu.map.params.hoverNode=-1},focusin:function(a){a.stopPropagation();$(this).data("user")?Blu.fn.map.survolNoeud("@"+$(this).data("user")):Blu.fn.map.survolNoeud("@"+$(this).find("a").data("user"))},focusout:function(a){a.stopPropagation();Blu.map.params.hoverNode=-1}});$(".tweet-text a.url").live({click:function(a){a.stopPropagation();a=$(this).attr("href");Blu.fn.app.isAppUrl(a)||
Blu.fn.app.blockingIframeWebsites(a);return!0}});$(".tweet .actions a").live({click:function(){var a=$(this),b=a.parents(".tweet").attr("id").replace("tweet_",""),e={favorite:"https://twitter.com/intent/favorite?tweet_id=",retweet:"https://twitter.com/intent/retweet?tweet_id=",reply:"https://twitter.com/intent/tweet?in_reply_to="},a=a.attr("class"),b="undefined"!==typeof e[a]?e[a]+b:0;0!==b&&Blu.fn.UI.openPopup(b,550,550);return!1}});$(".tweets-list .new-tweets").live("click",Blu.fn.tweets.showNewTweets);
$("#autocomplete li.item a").live({click:function(){var a=$(this).data("user");a&&(Blu.DOM.ac.hide(),Blu.config.map.usercards.show&&(Blu.DOM.zc.find(".user-card").remove(),Blu.fn.usercards.reset(),Blu.usercards.selected.state.show=!0),Blu.fn.user.showProfile(a),mixpanel.track("Show Profile (via Search)",{User:a}),Blu.config.map.usercards.show&&Blu.fn.user.showUserCard(a),Blu.DOM.zc.find(".find-user").trigger("click"));return!1}});$("#autocomplete li.item").live({mouseover:function(){Blu.fn.AC.changePosAC($(this).data("posAC"))}});
$("#bluenod-logo a").click(function(){return $("body").hasClass("has-logo-img")?!1:Blu.config.clientMode?(Blu.fn.UI.showGallery(),!1):!0});$("h1 a").click(function(){Blu.DOM.findUser.val("");Blu.fn.tweets.search("",!0);Blu.fn.UI.miniStats({countTweets:Blu.counts.tweets.filter,countUsers:Blu.counts.users.graph});return!1});Blu.fn.project.events();$("a[data-tooltip]").tipsy({gravity:$.fn.tipsy.autoBounds(0,"sw"),fade:!0});$(".twitter-connect").live("click",function(){var a=$(this).data("action")||"default",
b={"default":{},"load-home-timeline":function(){Blu.fn.project.loadHomeTimeline()},"compose-tweet":function(){$(".compose-tweet").click()},"connect-visitor":function(){"registered"===Blu.user.status&&window.location.reload(!0);"visitor"===Blu.user.status&&Blu.fn.UI.popupEnterYourMail({after_oauth:!0})}};b[a]||(a="default");Blu.fn.connect.twitter.authorize({action:a,callback:b[a]});return!1});$("#account .twitter-disconnect").live("click",function(){$.getJSON(Blu.app.urls.main+"/connect/twitter/disconnect",
{},function(){Blu.fn.connect.twitter.afterOAuthProcess({action:"disconnect"})});return!1});$("#zonecentre, #barre, .panel, #graph-header, #graph-bottom").click(function(){$("#account").hide()});Blu.fn.user.followEvents();Blu.fn.UI.lightbox.events();Blu.fn.timeNav.events();$("input.copy, textarea.copy").live("click",function(){$(this).select()})};
Blu.fn.project.publish=function(){Blu.projects.current.id&&$.getJSON(Blu.app.urls.main+"/projects/publish",{project_id:Blu.projects.current.id},function(a){a.success?Blu.fn.UI.popupWindow.open({title:"Share your map",content:'<p>This map has its own URL now:</p><input type="text" class="copy" value="'+a.map_url+'">',width:"550"}):Blu.fn.UI.notification({message:a.message,type:"fail",delayOut:8})})};
Blu.fn.project.deleteProject=function(a,b){b=b||"";var c=a?Blu.fn.projects.findOne({id:a}):Blu.projects.current,d=c.id==Blu.projects.current.id;c.id&&(Blu.warn("deleteProject > project #"+c.id+"  (current : #"+Blu.projects.current.id+")"),$.getJSON(Blu.app.urls.main+"/projects/delete",{project_id:c.id},function(e){if(e.success)if(Blu.log("Project #"+c.id+" has been deleted."),mixpanel.track("Delete Search"),"AC"===b&&$("#new-search-ac").find('.list-projects li[data-project-id="'+a+'"]').animate({height:"0px"},
700,"easeOutCubic",function(){$("#new-search-ac").removeClass("stay-displayed");Blu.fn.UI.showNewSearchAC()}),$('#gallery li[data-project-id="'+a+'"]').fadeOut(700,function(){$(this).remove()}),d&&(Blu.fn.project.resetCurrent(),$("h1 a").text(""),$("h1 a .count").text("")),e=c.type,"search"===e||"search-user"===e){e={search:Blu.projects.search,"search-user":Blu.projects.user}[e];for(var f in e)if(e[f].id==c.id){e.splice(f,1);break}}else"home-timeline"===e&&(Blu.projects.home_timeline={});else Blu.warn("Search NOT deleted."),
Blu.warn(e.message)}))};Blu.fn.project.configUI=function(a){var b=$("h1 a"),c="",d=$("#barre .new-search");b.html("");!a||Blu.config.clientMode?b.hide():b.show();"search"===a.type?(a.query&&(c="Search: "+a.query,Blu.config.clientMode&&d.val(a.query)),a.title&&(c=a.title)):"search-user"===a.type?(c=a.title,Blu.config.clientMode&&d.val("@"+(a.twitter_screen_name||""))):"home-timeline"===a.type&&(c="Home");b.text(c)};
Blu.fn.project.select=function(a){if(a){if(Blu.info("S\u00e9lection du projet "+a.id),a&&(Blu.projects.current=a),!a.service||"twitter"===a.service){var b="search-user"===a.type?a.twitter_screen_name:a.query,c=Blu_Misc.fn.misc.toPermalink(b);history.pushState(a,"New Search: "+b,"search-user"===a.type?"/user/"+c:"/tag/"+c)}}else Blu.warn("Pas de projet \u00e0 s\u00e9lectionner")};
Blu.fn.project.selectLast=function(){var a=Blu.projects.current.id?Blu.projects.current:Blu.fn.projects.findOne({orderBy:"refreshed_at DESC"});if(0<a.id)return Blu.fn.project.select(a),!0;Blu.fn.project.select();Blu.warn("Aucun projet \u00e0 s\u00e9lectionner.");return!1};Blu.fn.project.get=function(a){for(var b in Blu.projects.search)if(Blu.projects.search[b].id==a)return Blu.projects.search[b];return{id:"0",query:"",type:"",dates:{min:"",max:""}}};
Blu.fn.projects.findOne=function(a){a=$.extend({limit:1,hideDup:!1},a||{});return Blu.fn.projects.find(a)[0]||{}};
Blu.fn.projects.find=function(a){Blu.info("Blu.fn.projects.find()");a=$.extend({id:"",query:"",twitter_screen_name:"",type:"",ac:"",orderBy:"",limit:0,offset:0,hideDup:!0,premium:!1},a||{});Blu.log(a);var b,c,d=[],e=[],f,g=0,h;for(h in Blu.projects)if(-1!==$.inArray(h,["search","user"]))for(var j in Blu.projects[h])if(b=Blu.projects[h][j],b.id&&(c=(a.id?a.id==b.id:!0)&&(a.query?a.query.toLowerCase()===b.query.toLowerCase():!0)&&(a.twitter_screen_name?a.twitter_screen_name.toLowerCase()===b.twitter_screen_name.toLowerCase():
!0)&&(a.type?a.type===b.type:!0)&&(a.ac.length?"search-user"===b.type?-1!==b.twitter_screen_name.toLowerCase().search(a.ac.toLowerCase().replace("@","")):-1!==b.query.toLowerCase().search(a.ac.toLowerCase().replace("#","")):!0)&&(null!==a.premium?a.premium&&b.isPremium||!a.premium&&!b.isPremium:!0))){f=!1;if(a.hideDup)for(var k in d)if(c=d[k],"search-user"===c.type&&c.twitter_screen_name.toLowerCase()===b.twitter_screen_name.toLowerCase()||"search"===c.type&&c.query.toLowerCase()===b.query.toLowerCase()){f=
!0;"undefined"===typeof e["dups_of_project"+b.id]&&(e["dups_of_project"+b.id]=[]);e["dups_of_project"+b.id].push(c);g++;break}f||d.push(b)}a.orderBy&&d.sort(function(b,c){switch(a.orderBy){case "id DESC":return c.id-b.id;case "id ASC":return b.id-c.id;case "refreshed_at DESC":return b.refreshed_at&&c.refreshed_at?c.refreshed_at<b.refreshed_at?-1:c.refreshed_at>b.refreshed_at?1:0:c.id-b.id;default:return 0}});a.limit&&(d=d.slice(a.offset,a.offset+a.limit));Blu.log(d.length+" project(s) found, out of a total "+
(Blu.projects.search.length+Blu.projects.user.length));a.hideDup&&(Blu.warn(g+" duplicates found on all projects:"),Blu.log(e));return d};
Blu.fn.UI.listProjects=function(a){a=$.extend({classList:"list-projects",classWrapper:"list-projects-wrapper",orderBy:"refreshed_at DESC",projects:null,avatarSize:"normal",titleMaxChar:22,returnItemsOnly:!1},a||{});null===a.projects&&(a.projects=Blu.fn.projects.find(a));var b="",b="",c,d,e,f;for(f in a.projects)c=a.projects[f],d="search"===c.type?c.query:"@"+c.twitter_screen_name,e="search"===c.type?Blu.images.default_search:Blu.images.default_user,"search-user"===c.type&&(e=Blu.fn.user.getAvatarUrl(c.twitter_screen_name||
"",a.avatarSize),e===Blu.images.default_user&&(e="https://api.twitter.com/1/users/profile_image?size="+a.avatarSize+"&screen_name="+c.twitter_screen_name)),e='<img src="'+e+'" />',b+='<li class="proj '+c.type+'" data-project-id="'+c.id+'" data-project-type="'+c.type+'"><a class="item" href="#project'+c.id+'">'+e+'<span class="title">'+Blu.fn.misc.cutLongString(d,a.titleMaxChar)+'</span></a><a class="delete" href="#" title="Remove search">Remove</a></li>';if(a.returnItemsOnly)return b;b=b?'<ul class="'+
a.classList+'">'+b+"</ul>":"";return'<div class="'+a.classWrapper+'">'+b+"</div>"};Blu.fn.misc.cutLongString=function(a,b){return a.length>b?a.slice(0,b-1)+"\u2026":a};
Blu.fn.UI.showGallery=function(){var a=$("#gallery"),b={limit:20,classWrapper:"maps-wrap",classList:"maps",avatarSize:"reasonably_small",titleMaxChar:16,returnItemsOnly:!0},c="";a.length||($("#barre").after('<div id="gallery"><div class="wrap"><h2>My Search History</h2></div><div class="maps-wrap"><ul class="maps"></ul></div></div>'),a=$("#gallery"),a.onScrollEnd(function(){var c={offset:a.find("ul."+b.classList+" li").length,returnItemsOnly:!0};(c=Blu.fn.UI.listProjects($.extend(b,c)))&&a.find("ul."+
b.classList).append(c)}));a.find("ul."+b.classList).html("");a.find("p.info-msg").remove();c=Blu.fn.UI.listProjects(b);c.length||(c='<p class="info-msg"><img class="hand-arrow-up" class="" src="'+Blu.app.urls.main+'/style/img/Handwritten_Arrow_StraightUp.png?20130415_2" /><br/>Hi @'+Blu.user.screen_name+"!<br/>In the search field above, you can enter <br/> any @username or #hashtag you want to visualize.</p>",a.find("h2").hide());a.find("ul."+b.classList).html(c);a.show();a.scrollTop(0)};
Blu.fn.project.events=function(){$("#actions-project .publish").live({click:function(){Blu.fn.project.publish();$(this).blur();return!1}});$(".actions-project .export-users-csv").live({click:function(){if(!Blu.user.can.exportTopUsersCsv)return!1;Blu.fn.UI.openPopup(Blu.app.urls.main+"/projects/export/top-users/csv?id="+Blu.projects.current.id,500,300);$(this).blur();return!1}});$("#graph-bottom .tour").live({click:function(){Blu.fn.UI.showTour();$(this).blur();return!1}});var a=$("#main-menu");a.find("a.my-searches").live({click:function(){var a=
$(this);Blu.fn.UI.showGallery();a.blur();return!1}});a.find("a.new-fb-search").live({click:function(){var a=$(this);Blu.fn.UI.popupWindow.open({title:"Facebook Search (Alpha)",content:'<form class="fb-search-check"><label>Public group</label><input type="text" class="groupid size2" placeholder="Enter the group id" /><input type="submit" class="btn btn-primary" value="Check" /></form>',width:620});a.blur();return!1}});$("form.fb-search-check").live({submit:function(){var a=$(this),c=a.parents("#popupWindow").find(".content > .wrap"),
a=a.find(".groupid").val().replace(/(https?:\/\/(www\.)?)?facebook.com(\/groups\/)?\/?/,"").replace("/",""),d={path:a};if(!a)return Blu.warn("No path entered in input.fb-search-check"),!1;$.getJSON(Blu.app.urls.main+"/facebook-api",d,function(a){Blu.dir(a);var b=a.response;c.find(".fb-check-response").remove();a.success&&(b.privacy?c.append('<div class="fb-check-response"><div class="fb-preview-object"><a class="name" href="http://www.facebook.com/groups/'+b.id+'" target="_blank">'+b.name+'</a><div class="description">'+
b.description+'</div></div><p class="align-right"><a class="create-fb-project btn btn-primary" href="#" data-target-id="'+b.id+'" data-target-name="'+encodeURIComponent(b.name)+'" data-target-type="fb-group">Map this group</a></p></div>'):b.name&&c.append('<div class="fb-check-response">Sorry, '+b.name+" is not a group!</div>"))});return!1}});Blu.fn.UI.hideNewSearchAC=function(){var a=$("#new-search-ac");a.hasClass("stay-displayed")||a.remove()};Blu.fn.UI.showNewSearchAC=function(){Blu.fn.UI.hideNewSearchAC();
var a=$("#new-search-ac");if(!(0<a.length)){var c=$("input.new-search"),a={ac:c.val(),limit:5};a.projects=Blu.fn.projects.find(a);a.ac&&0<a.projects.length&&($("body").append('<div id="new-search-ac">'+Blu.fn.UI.listProjects(a)+"</div>"),a=$("#new-search-ac"),a.css({left:c.position().left,top:c.position().top+c.outerHeight(!0),right:"auto"}))}};Blu.fn.UI.offsetNewSearchAC=function(a){Blu.info("Blu.fn.UI.offsetNewSearchAC( "+a+" )");var c=$("#new-search-ac").find("li"),d=c.length,e=c.filter(".selected").length?
c.filter(".selected").index():-1;d&&(c.removeClass("selected"),a=(e+a)%d,0>a&&(a=d-1),c.eq(a).addClass("selected"))};$("input.new-search").live({keyup:function(a){var c=$(this),d=$.trim(c.val());switch(a.keyCode){case 40:Blu.fn.UI.offsetNewSearchAC(1);break;case 38:Blu.fn.UI.offsetNewSearchAC(-1);break;case 27:Blu.fn.UI.hideNewSearchAC();break;case 13:a=$("#new-search-ac").find("li.selected");if(1===a.length)a.children("a").trigger("click");else{a="#"===d[0]?"search":"search-user";if("search-user"===
a&&1>d.length||"search"===a&&1>=d.length)break;else if("search"===a&&!Blu.user.can.createHashtagSearch){c.attr("title","Please type a username :)");c.tipsy({gravity:"nw",fade:!0,trigger:"manual"});c.tipsy("show");setTimeout(function(){c.attr("title")?(c.tipsy("hide"),c.attr("title","")):$(".tipsy-nw").remove()},4E3);break}a={type:a};"search"===a.type?a.query=d:"search-user"===a.type&&(a.twitter_screen_name=d.replace("@",""));Blu.fn.project.create(a);$("#gallery").hide()}c.blur();break;default:Blu.fn.UI.showNewSearchAC()}},
focus:function(){},blur:function(){$("#new-search-ac").length&&setTimeout(function(){Blu.fn.UI.hideNewSearchAC()},100)}});$(document).click(function(){Blu.fn.UI.hideNewSearchAC()});$("li.proj a.item").live({click:function(){var a=$(this).parent("li"),c=a.data("project-id");Blu.fn.project.create({id:c});Blu.fn.UI.hideNewSearchAC();$("#gallery").hide();0<a.parents("#gallery").length?mixpanel.track("Show Previous Search (History)"):mixpanel.track("Show Previous Search (Autocomplete)");return!1},mouseover:function(){var a=
$(this).parent("li");a.siblings().removeClass("selected");a.addClass("selected")},mouseout:function(){$(this).removeClass("selected")}});$("li.proj > .delete").live({click:function(a){a.stopPropagation();a=$(this).parent().data("project-id");var c=$(this).parents("ul").hasClass("list-projects")?"AC":"";Blu.fn.project.deleteProject(a,c);return!1}});$(".list-projects li .delete").live({mouseover:function(){$(this).closest("#new-search-ac").addClass("stay-displayed")},mouseout:function(){$(this).closest("#new-search-ac").removeClass("stay-displayed")}});
$(".create-fb-project").live({click:function(){var a=$(this),c=a.data("target-type"),d=a.data("target-id"),a=a.data("target-name"),c={service:"facebook",type:c,twitter_user_id:d,twitter_screen_name:decodeURIComponent(a)};Blu.fn.project.create(c);Blu.fn.UI.popupWindow.close();$("#gallery").hide();return!1}});$("a.compose-tweet, .user-actions .mention a").live({click:function(){if(!Blu.user.user_id)return Blu.fn.connect.twitter.infoPopup("compose-tweet"),!1;var a=$(this);Blu.fn.tweet.loadTextFunctions(function(){Blu.fn.UI.popupWindow.open({title:"Compose Tweet",
content:'<div class="compose"><div class="composer"><span>Tweeting as <strong>@'+Blu.user.screen_name+'</strong></span></div><textarea class="compose-input" autofocus></textarea><div class="bottom"><p class="info"></p><a class="btn btn-primary disabled" href="#">Tweet</a><span class="count">140</span></div></div>',width:550,closeOverlay:!1});var c=$(".compose-input");a.data("prefill-tweet")&&(c.val(a.data("prefill-tweet")),Blu.fn.tweet.composeInputEvent(c));c.focus();c.keydown(function(){var a=$(this);
setTimeout(function(){Blu.fn.tweet.composeInputEvent(a)},10)}).change(function(){var a=$(this);setTimeout(function(){Blu.fn.tweet.composeInputEvent(a)},10)}).bind("paste",function(){var a=$(this);setTimeout(function(){Blu.fn.tweet.composeInputEvent(a)},10)})});a.blur();return!1}});Blu.fn.tweet.composeInputEvent=function(a){var c=a.parents(".compose"),d=c.find(".count"),e=c.find(".info"),c=c.find(".btn-primary");a=twttr.txt.getTweetLength(a.val());var f=140-a;d.text(f);e.text("");0>f?(c.addClass("disabled"),
d.addClass("error")):(0==a?c.addClass("disabled"):c.removeClass("disabled"),10>=f?d.addClass("error"):d.removeClass("error"))};$(".compose .btn-primary").live({click:function(){var a=$(this),c=a.parents(".compose"),d=c.find(".compose-input"),e=c.find(".info"),f=twttr.txt.getTweetLength(d.val()),c=140<f,g=!Blu.user.user_id,f=!(0==f||c||g);if(d.data("sending"))return!1;e.text("");g?Blu.fn.connect.twitter.authorize():c&&e.text("Your tweet is over 140 characters. The shorter the better ;)");if(!f)return e.addClass("error"),
a.blur(),!1;d.data("sending",1).addClass("inactive");a.addClass("inactive");Blu.fn.app.twitterAuthRequest("statuses/update",{status:d.val()},function(c){d.removeData("sending").removeClass("inactive");a.removeClass("inactive");200!=c.code?e.text(c.response.error).addClass("error"):(e.text("Tweet posted!").addClass("ok"),setTimeout(function(){Blu.fn.UI.popupWindow.close()},5E3),mixpanel.track("Post a Tweet",{"Tweet URL":Blu.fn.tweet.statusUrl(c.response.user.screen_name,c.response.id_str)}))});a.blur();
return!1}});a.find("a.settings").live({click:function(){var a=$(this);$("#account").toggle();a.blur();return!1}});$("#sidebar-menu");$("#graph-notif.refresh a").live("click",function(){var a=$(this).data("graph");Blu.fn.map.chargeGraphe(a);Blu.fn.tweets.filter();Blu.fn.tweets.showList();Blu.fn.UI.removeGraphNotif();return!1})};
Blu.fn.project.create=function(a,b){b=$.extend({reload:!1},b||{});if(a.id){var c=Blu.fn.projects.findOne({id:a.id});if(!c.id){Blu.warn("No project found with the id "+b.id+" : we cannot create a new project from it.");return}a={type:c.type};"search"===c.type?a.query=c.query:"search-user"===c.type&&(a.twitter_screen_name=c.twitter_screen_name)}switch(a.type){case "search":if(!a.query){Blu.fn.UI.notification({message:"Please type a query",type:"fail",delayOut:4});return}break;case "search-user":if(!a.twitter_screen_name){Blu.fn.UI.notification({message:"Please type a username",
type:"fail",delayOut:4});return}break;case "home-timeline":if(!a.twitter_user_id){Blu.fn.connect.twitter.infoPopup("load-home-timeline");return}break;case "fb-group":case "fb-page":if(!a.twitter_user_id){Blu.warn("There is no ID (group or page).");return}}Blu.fn.project.resetCurrent();Blu.fn.map.traceMap(!0);Blu.fn.tweets.search("");Blu.fn.UI.miniStats();c={project:a,refresh:Math.random()};$.getJSON(Blu.app.urls.main+"/projects/create",c,function(a){a.success?(mixpanel.track("New Search",{Type:"search-user"===
a.project.type?"User":"Hashtag",Search:"search-user"===a.project.type?a.project.twitter_screen_name:a.project.query}),"search"===a.project.type?Blu.projects.search.push(a.project):"search-user"===a.project.type?Blu.projects.user.push(a.project):"home-timeline"===a.project.type&&(Blu.projects.home_timeline=a.project),Blu.fn.project.select(a.project),Blu.needs.lastGraph=!1,Blu.needs.allGraphs=!1,Blu.fn.project.grabNewTweets({create_graph:!0}),Blu.fn.UI.showCanvasScreen(),Blu.fn.project.loadCurrent(),
Blu.fn.project.deleteDuplicates(a.project)):Blu.fn.UI.notification({message:a.message,type:"fail",delayOut:8})})};
Blu.fn.project.deleteDuplicates=function(a){if(!a.type||!a.id)Blu.warn("deleteDuplicates: type/id of the source project is undefined");else{var b="search-user"===a.type?"twitter_screen_name":"query",c={type:a.type,hideDup:!1};c[b]=a[b];b=Blu.fn.projects.find(c);Blu.warn("deleteDuplicates: "+Math.max(0,b.length-1)+" project(s) will be deleted (duplicates of project #"+a.id+")");Blu.log(b);for(var d in b)c=b[d],c.id===a.id||(c.isPremium||c.type!==a.type)||Blu.fn.project.deleteProject(c.id)}};
Blu.fn.UI.showCanvasScreen=function(a){a=$.extend({error:!1,no_tweets:!1},a||{});var b=Blu.projects.current,c=b.service||"twitter",d="twitter"===c?"Twitter":"Facebook",e=b.twitter_screen_name||"",b=b.query||"",c=e?"twitter"===c?"@"+e:e:b,f=e?"https://api.twitter.com/1/users/profile_image?size=reasonably_small&screen_name="+e:Blu.images.default_search,g=Blu.DOM.zc,e=e?"You are mapping <br>the "+d+" community <br>of <strong>"+c+"</strong>":"You are mapping the Twitter community of <br/><strong>"+b+
"</strong>";a.error&&(e=a.no_tweets?"Hmm... There are no tweets for this search so we can't visualize the community of <strong>"+c+"</strong><br/><br/>":"Hmm... Looks like we don't have enough data to visualize the "+d+" community of <strong>"+c+"</strong><br/><br/>");Blu.fn.UI.removeCanvasScreen();g.prepend('<div id="canvas-screen" class="'+(a.error?"error ":"")+(f?"user":"hashtag")+'"><div class="loader">&nbsp;</div><div class="main-msg">'+(f?'<img class="avatar" src="'+f+'">':"")+'<div class="text">'+
e+"</div></div>"+(!a.error?'<div class="secondary-msg">Please wait a few seconds before starting exploration...</div>':"")+"</div>");a.error||g.find("#canvas-screen .loader").spin("create-graph")};Blu.fn.UI.removeCanvasScreen=function(){Blu.DOM.zc.find("#canvas-screen").remove()};
Blu.fn.UI.showWelcomeScreen=function(){Blu.fn.UI.popupWindow.open({title:"Welcome to Bluenod",content:"<p>Hello @"+Blu.user.screen_name+', we are happy to welcome you here!</p><p>Just before you start using Bluenod, let\'s have a quick tour.</p><p class="align-center"><a href="#" class="btn btn-primary next">Start the tour</a></p>',bg:"background: rgba(0,0,0, 0.85);",closeButton:!0,closeOverlay:!1});$("#popupWindow .next").click(function(){Blu.fn.UI.popupWindow.close();Blu.fn.UI.showTour();return!1})};
Blu.fn.UI.showTour=function(a){var b=[{title:"Search",content:"You can search any Twitter account or hashtag you want. Get a quick access to your search history.",focus:{height:"24%",left:"40%",top:"0%",width:"30%"},placement:"bottom",img:"step1.jpg"},{title:"Explore",content:"Each circle is a Twitter user. Browse the map to see how people are connecting.",focus:{height:"89%",left:"33.5%",top:"11%",width:"66.5%"},placement:"left",img:"step2.jpg"},{title:"Discover",content:"Dig into users profiles to get to know them better.",
focus:{height:"94.4%",left:"0%",top:"5.6%",width:"33.3%"},placement:"right",img:"step3.jpg"},{title:"Get in action!",content:"Follow interesting people, interact with them or visualize their own community.",focus:{height:"94.4%",left:"0%",top:"5.6%",width:"33.3%"},placement:"right",img:"step4.jpg"}],c=Blu.config.clientMode?b:b.splice(1),b='<div class="carousel slide" id="carousel-tour"><div class="carousel-inner">',d;for(d in c)b+='<div class="item '+(0==d?" active":"")+'" data-step="'+d+'"><div class="focus-block" data-toggle="popover" href="#"></div><img alt="" src="'+
Blu.app.urls.main+"/style/img/tour/"+c[d].img+'"></div>';Blu.fn.UI.popupWindow.open({title:"Bluenod Tour",content:b+"</div></div>",width:"965px",top:"30px",bg:"background: rgba(0,0,0, 0.85);",padding:"0",callback:function(){"function"===typeof a&&a()}});var e=$("#popupWindow .carousel"),f=e.find(".focus-block");e.carousel({interval:!1});f.each(function(){var a=$(this),b=a.parents(".item"),d=c[parseInt(b.data("step"),10)];a.css(d.focus);a.after('<div class="focus-overlay top"></div><div class="focus-overlay left"></div><div class="focus-overlay right"></div><div class="focus-overlay bottom"></div>');
var e=b.find(".focus-overlay"),f=parseFloat(d.focus.top),m=parseFloat(d.focus.left),n=parseFloat(d.focus.height),p=parseFloat(d.focus.width);e.filter(".top").css({top:0,height:f+"%",left:0,right:0});e.filter(".left").css({top:f+"%",height:n+"%",width:m+"%"});e.filter(".right").css({top:f+"%",left:m+p+"%",height:n+"%",right:0});e.filter(".bottom").css({top:f+n+"%",left:0,bottom:0,right:0});a.popover({title:"Step "+(b.data("step")+1)+": "+d.title,content:d.content+"<div>"+(0<b.data("step")?'<a class="btn prev" href="#">Back</a>':
"")+(b.data("step")<c.length-1?'<a class="btn btn-primary next" href="#">Next</a>':"")+(b.data("step")==c.length-1?'<a class="btn btn-primary finish" href="#" data-action="close">Close</a>':"")+"</div>",placement:d.placement,html:!0,trigger:"manual",delay:{show:1500,hide:100}})});setTimeout(function(){f.filter(":first").popover("show")},600);e.find(".popover .next, .popover .replay").live("click",function(){e.carousel("next");return!1});e.find(".popover .prev").live("click",function(){e.carousel("prev");
return!1});e.on({slide:function(){e.find(".item.active .focus-block").popover("hide")},slid:function(){setTimeout(function(){e.find(".item.active .focus-block").popover("show")},600)}})};
Blu.fn.UI.showGraphNotif=function(a){a=$.extend({text:"",html:"",spinner:!1,cssClass:""},a||{});if(a.text||a.html){Blu.fn.UI.removeGraphNotif();var b=Blu.DOM.zc;b.append('<div id="graph-notif" class="'+a.cssClass+'">'+(a.spinner?'<span class="spin">&nbsp;</span>':"")+(a.html?a.html:'<span class="text">'+a.text+"</span>")+"</div>");a.spinner&&b.find("#graph-notif .spin").spin("very-small")}};Blu.fn.UI.removeGraphNotif=function(){$("#graph-notif").remove()};
Blu.fn.connect.twitter.infoPopup=function(a){Blu.fn.UI.popupWindow.open({title:"Twitter Connect",content:'<p>Hello! In order to enjoy the Bluenod experience, please connect your Twitter account.</p><p class="align-center"><a class="btn btn-primary twitter-connect" data-action="'+a+'" href="#twitter-connect">Connect with Twitter</a> <a class="btn btn-mini btn-link cancel" href="#" data-action="close">No thanks</a></p>',width:450,closeButton:!0,closeOverlay:!1})};
Blu.fn.UI.popupEnterYourMail=function(a){a=$.extend({after_oauth:!1},a||{});Blu.fn.UI.popupWindow.open({title:a.after_oauth?"Congrats!":"Sign up",content:(a.after_oauth?'<p class="">You\'re now connected as <strong>@'+Blu.user.screen_name+"</strong></p>":"")+'<p class="">If you want to sign up to Bluenod, please enter your email.<br/></p><form class="create-user" action="'+Blu.app.urls.main+'/users/create" method="post" data-after-oauth="'+Number(a.after_oauth)+'"><input type="hidden" name="signup[stfu]" value=""/><input type="text" name="signup[mail]" class="size1" placeholder="Enter your mail"/><input type="submit" class="btn btn-primary" value="Sign up"/></form>',
width:400,callback:a.after_oauth?function(){window.location.reload(!0)}:function(){}})};
$("form.request-invite").live({submit:function(){var a=$(this);$.getJSON(a.attr("action"),a.serializeArray(),function(b){var c=$("#popupWindow").find(".content");b.success?Boolean(a.data("after-oauth"))?(Blu.fn.UI.popupWindow.open({title:"Welcome to Bluenod!",content:'<p class="align-center"><a class="btn btn-primary" href="#" data-action="close">Let\'s go</a></p>',callback:function(){window.location.reload(!0)}}),Blu.fn.connect.twitter.afterOAuthProcess()):Blu.fn.UI.popupWindow.open({title:"Thanks!",
content:'<p>You\'re now on our waiting list. We will come back to you in a couple of days. Stay tuned!</p><p class="align-center"><a class="btn btn-primary" href="#" data-action="close">Ok</a></p>'}):(c.find("p.message").remove(),c.append('<p class="message">'+b.message+"</p>"))});return!1}});
Blu.fn.project.loadHomeTimeline=function(){Blu.projects.home_timeline.id?(Blu.fn.project.select(Blu.projects.home_timeline),Blu.fn.project.loadCurrent()):Blu.user.user_id?Blu.fn.project.create({type:"home-timeline",twitter_user_id:Blu.user.user_id}):Blu.fn.connect.twitter.infoPopup()};
Blu.fn.url.extractGetParams=function(){if(1>=window.location.search.length)return{};for(var a={},b=window.location.search.substr(1).split("&"),c,d=0;d<b.length;d++)c=b[d].split("="),a[decodeURIComponent(c[0])]=1<c.length?decodeURIComponent(c[1]):"";return a};
Blu.fn.url.getFilterParams=function(){var a=document.location.hash.split("::"),b={};if("undefined"!==typeof a[1]){var a=a[1].split("&"),c;for(c in a){var d=a[c].split("="),e="undefined"!==typeof d[0]?d[0]:"",d="undefined"!==typeof d[1]?d[1]:"";""!=e&&(b[e]=d)}}Blu.log(b);return b};
Blu.fn.url.parseFragment=function(){0<$("#datasets li").length&&($("#datasets li").each(function(){Blu.datasets.push({name:$(this).data("set")})}),0<Blu.datasets.length&&"undefined"!==typeof Blu.datasets[0].name&&(Blu.currentDataset=Blu.datasets[0].name));document.location.hash.match(/#\/?(\w+)\/?(\w+)?\/?/);var a=Blu.viz.by_default,b=Blu.currentDataset;Blu.fn.url.getFilterParams();Blu.viz.current=a;Blu.currentDataset=b;Blu.currentSubset="";a=$("#datasets");0<a.find("li").length&&(a.find('li[data-set="'+
b+'"]').addClass("active"),a.find("li").hide(),a.find("li."+b).show())};Blu.fn.user.getDefaultUser=function(){return{id:0,screen_name:"",user_id:"",created_at:new Date,isFromTeam:!1,following:{list:[],isLoaded:!1},can:{}}};
Blu.fn.initConfig=function(){Blu.app.urls.ajax_base=Blu.app.urls.main+"/ajax/";Blu.app.urls.graphs_base=Blu.app.urls.main+"/static/graphs/";Blu.config.bluenodProxy=0<Blu.user.screen_name.length;Blu.config.timezoneOffset=(new Date).getTimezoneOffset();Blu.images.default_user=Blu.app.urls.main+Blu.images.default_user;Blu.map.defaults.zoomLevel=Blu.map.params.zoomLevel;Blu.map.defaults.centreX=Blu.map.params.centreX;Blu.map.defaults.centreY=Blu.map.params.centreY;Blu.app.getParams=Blu.fn.url.extractGetParams();
if("undefined"!==typeof Blu.app.getParams.timeNavGlobal||"undefined"!==typeof Blu.app.getParams.global)Blu.config.timeNavGlobal=!0,$("body").addClass("global-map")};
Blu.fn.initInterface=function(){Blu.DOM.canvas=$("#canvas");Blu.DOM.zc=$("#zonecentre");Blu.DOM.ac=$("#autocomplete");Blu.DOM.findUser=$("#inputrecherche");Blu.fn.UI.createGraphHeader();Blu.fn.UI.createGraphBottom();Blu.canvas.ctx=Blu.DOM.canvas.get(0).getContext("2d");Blu.canvas_mini.ctx=$("#miniature").get(0).getContext("2d");Blu.canvas_timemachine.ctx=Blu.DOM.miniTimeline.get(0).getContext("2d");var a=$("#barre"),b=Blu.config.UI.mobile,c=!b&&!Blu.config.timeNavGlobal,d=!b,e=!b,b=$("#panels-wrapper"),
e=e?parseInt(b.outerWidth(),10):0,f=a.outerHeight()-1+(c?Blu.DOM.gHeader.outerHeight():0),g=d?Blu.DOM.gBottom.outerHeight()||0:0,f={left:e,top:f,bottom:g};Blu.DOM.gHeader.css("top",a.outerHeight());b.css("top",a.outerHeight());Blu.DOM.gHeader.css("left",e);Blu.DOM.gBottom.css("left",e);c||Blu.DOM.gHeader.hide();d||Blu.DOM.gBottom.hide();Blu.config.mapOnly&&(b.hide(),a.hide());Blu.DOM.zc.css(f);Blu.fn.UI.showPanel();$(".panel.tweets").onScrollEnd(Blu.fn.tweets.showPartialList);$(".panel.users").onScrollEnd(function(){var a=
$(".panel.users"),b=a.children(".wrap").children("ul.user-list"),c=Blu.topUsers.global.by_mentions,d=b.children("li").length,e=Math.min(d+16,c.length);Blu.log("Panel Users: showing users #"+d+" to #"+e+" on "+c.length+" users");d>=c.length||(b.append(Blu.fn.users.listUsers({theClass:"topUsers by_mentions",userRanked:"User",numberTitle:"Mentions",tab:c.slice(d,e),items_only:!0})),a.getNiceScroll().resize())});$(".panel").niceScroll(Blu.config.style.scrollbar);a=$("#ulgranul li.actif a");a.length&&
(Blu.timeline.params.granularite=parseInt(a.attr("id").replace("granul_",""),10));Blu.fn.UI.mainMenu();Blu.fn.UI.menuAccount();Blu.fn.UI.preloadNotifications()};Blu.fn.UI.preloadNotifications=function(){if(Blu.notifications&&!(1>Blu.notifications.length))for(var a in Blu.notifications){var b=Blu.notifications[a];b.delayOut=8;Blu.fn.UI.notification(b)}};Blu.fn.misc.isCanvasSupported=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))};
Blu.fn.misc.isPageWidthTooSmall=function(){return 1010>$("body").width()};Blu.fn.misc.configMixpanel=function(){!Blu.user.id||Blu.user.isFromTeam||Blu.fn.localhost()?Blu.fn.misc.disableMixpanel():(mixpanel.identify(Blu.user.id),mixpanel.people.identify(Blu.user.id),mixpanel.name_tag(Blu.user.screen_name),mixpanel.people.set({$name:Blu.user.screen_name,$username:Blu.user.screen_name,$created:Blu.user.created_at,$last_login:new Date,"Profile URL":"http://twitter.com/"+Blu.user.screen_name}),Blu.warn("Mixpanel : config OK"))};
Blu.fn.misc.disableMixpanel=function(){mixpanel.disable();mixpanel.set_config({track_pageview:!1});Blu.warn("Mixpanel : disabled")};
Blu.init=function(){Blu.log("Initializing App... @ "+Blu.fn.misc.timeNow());Blu.fn.misc.configMixpanel();Blu.config.welcomeScreen&&mixpanel.track("Sign Up");mixpanel.track(Blu.config.clientMode?"Page Client Loaded":"Page Mapping Loaded");Blu.fn.initConfig();if(Blu.fn.misc.isCanvasSupported()){if(Blu.fn.misc.isPageWidthTooSmall()||Blu.app.getParams.mobile)$("body").addClass("mobile"),Blu.config.UI.mobile=!0;Blu.fn.url.parseFragment();Blu.fn.initInterface();Blu.fn.UI.updateSize();Blu.fn.project.resetCurrent();
Blu.fn.project.loadCurrent();Blu.fn.UI.bindEvents();Blu.fn.socialShare();Blu.fn.tweets.updateTweetDates();Blu.fn.test()}else Blu.fn.UI.popupWindow.open({title:"Please Upgrade Your Browser",content:Blu.txt("error_oldBrowser"),width:600,closeButton:!1,closeOverlay:!1}),mixpanel.track("Error: Canvas Not Supported",{"User Agent":navigator.userAgent})};Blu.fn.test=function(){};
Blu.fn.project.resetCurrent=function(){Blu.info("Blu.fn.project.resetCurrent()");Blu.has={loadedTweets:!1,loadedTimestamps:!1,loadedGraph:!1,loadedAllGraphs:!1};Blu.needs={tweets:!0,timestamps:!0,graph:!0,lastGraph:!0,allGraphs:!0,newGraph:!1};if(!Blu.projects.current||!Blu.projects.current.id)Blu.warn("Pas de projet courant.");else{Blu.projects.current.service&&"facebook"===Blu.projects.current.service&&(Blu.needs.tweets=!1,Blu.needs.timestamps=!1);Blu.fn.users.resetPanels();Blu.tweets.length=0;
Blu.newTweets.length=0;Blu.counts.tweets.alltime=0;Blu.timestamps.length=0;Blu.tranches.length=0;Blu.timeline.params.granularite="auto";Blu.intervals.length=0;Blu.canvas_timemachine.ctx.clearRect(0,0,Blu.timeline.mini.width,Blu.timeline.mini.height);Blu.canvas_mini.timeline.image="";Blu.fn.timeline.traceTimeline();var a=Blu.fn.misc.dateStringToObject(Blu.projects.current.dates.min,0),b=Blu.fn.misc.dateStringToObject(Blu.projects.current.dates.max,0);Blu.timeline.params.filter.dates={min:a,max:b};
Blu.projects.current.datesTotal||(Blu.projects.current.datesTotal={min:Blu.projects.current.dates.min,max:Blu.projects.current.dates.max});Blu.carto=null;Blu.map.isIdentical=!1;Blu.map.params.hoverNode=-1;Blu.map.params.selectedNode=-1;Blu.fn.map.resetZoom();Blu.graphs.all.length=0;Blu.fn.map.traceMap(!0);Blu.fn.tweets.search("");Blu.fn.UI.mapNotification("");Blu.fn.UI.miniStats();Blu.fn.UI.removeCanvasScreen();Blu.fn.UI.removeGraphNotif();Blu.DOM.gHeader.find(".count-tweets-alltime .count").text("");
Blu.DOM.gBottom.find(".count-nodes .total .count").text("");Blu.timers.waitAndLoadNewData&&(clearInterval(Blu.timers.waitAndLoadNewData),Blu.timers.waitAndLoadNewData=0);Blu.timers.calcTopUsers&&(clearInterval(Blu.timers.calcTopUsers),Blu.timers.calcTopUsers=0)}};
Blu.fn.project.loadCurrent=function(){Blu.info("Blu.fn.project.loadCurrent()");Blu.projects.current.id?(Blu.fn.project.configUI(Blu.projects.current),Blu.config.users.connectVisitor&&!Blu.user.user_id&&Blu.fn.UI.showTour(function(){setTimeout(function(){Blu.warn("connect popup after tour");Blu.fn.connect.twitter.infoPopup("connect-visitor")},100)}),Blu.projects.current.isNew&&(Blu.needs.newGraph=!0),Blu.config.timeNavGlobal&&(Blu.timeNav.mode="archive"),Blu.config.timeNavigation&&Blu.fn.timeNav.createHtml(),
Blu.fn.map.init(),Blu.config.map.nodeLabel="id",Blu.projects.current.service&&"facebook"===Blu.projects.current.service&&(Blu.config.map.nodeLabel="name"),Blu.fn.tweets.load({show:!0}),Blu.fn.timestamps.load(),Blu.fn.timemachine.load(),Blu.fn.project.waitAndLoadNewData(),Blu.fn.tweets.timerNewTweets(),Blu.fn.tweets.timerNewTweets_API(),Blu.fn.tweets.timerOldTweets(),Blu.config.map.showFollowing&&Blu.fn.user.activateFollowingMode()):-1!==location.pathname.search(/\/user\/[\w]+/)?Blu.fn.project.create({type:"search-user",
twitter_screen_name:location.pathname.replace("/user/","")}):-1!==location.pathname.search(/\/tag\/[\w]+/)?Blu.fn.project.create({type:"search",query:"#"+location.pathname.replace("/tag/","")}):Blu.config.clientMode&&(Blu.config.welcomeScreen&&Blu.fn.UI.showWelcomeScreen(),Blu.fn.UI.showGallery())};
Blu.fn.project.waitAndLoadNewData=function(){Blu.config.clientMode&&(Blu.timers.waitAndLoadNewData=setInterval(function(){if(Blu.has.loadedTweets&&(clearInterval(Blu.timers.waitAndLoadNewData),Blu.timers.waitAndLoadNewData=0,Blu.info("Projet charg\u00e9. On va charger de nouvelles donn\u00e9es en arri\u00e8re-plan."),Blu.needs.newGraph)){var a={since_id:Blu.fn.tweets.getLastTweetId(),create_graph:!0,backgroundTask:!Blu.projects.current.isNew,showNotifications:!1,reload:!0};a.backgroundTask?Blu.fn.UI.showGraphNotif({text:"Loading new graph...",
spinner:!0}):Blu.fn.UI.showCanvasScreen();Blu.fn.project.grabNewTweets(a)}},100))};Blu.fn.user.getAvatarUrl=function(a,b){var c=Blu.fn.user.get(a).data.profile_image_url;c||(c=Blu.images.default_user);return c===Blu.images.default_user?c:c.replace("_normal.","_"+b+".")};
Blu.fn.users.listUsers=function(a){a=$.extend({items_only:!1},a);Blu.log("Blu.fn.users.listUsers");var b="",c,d;for(d in a.tab)c=a.tab[d],c='<li class="rank-user '+c.user+'"><a class="profile-pic" href="http://twitter.com/'+c.user+'" data-user="'+c.user+'" target="_blank" title="'+Blu.txt("showProfile")+'"><img class="avatar" src="'+Blu.fn.user.getAvatarUrl(c.user,"bigger")+'" data-user="'+c.user+'" /></a></li>',b+=c;a.tab.length||(b='<li class="rank-user no-data">\x3c!--'+Blu.txt("noData")+"--\x3e</li>");
return a.items_only?b:'<ul class="user-list">'+b+"</ul>"};
Blu.fn.users.tableUsers=function(a){Blu.log("Blu.fn.users.tableUsers");for(var b=a.tab.length,c=a.userRanked||"",d=a.numberTitle||"",e=a.theClass,f="",g="",h=0;h<b;h++)var f=a.tab[h],j=f.user.replace(/(^|\s)(@)([\w_\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f0\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff]+)/g,'$1<a class="mention" href="http://twitter.com/$3" data-user="$3" target="_blank"><span>$2</span>$3</a>'),f='<tr><td class="rank">'+
(h+1)+'</td><td class="img"><img src="'+Blu.fn.user.get(f.user).data.profile_image_url+'"/></td><td class="username">'+j+'</td><td class="number" title="'+f.user+" le mentionne "+f.searchMentioned+" fois & est mentionn\u00e9 "+f.searchMentioning+' fois par lui">'+f.count+"</td></tr>",g=g+f;return'<table class="'+e+'"><thead><tr><th class="rank">Rang</th><th class="img"></th><th class="username">'+c+'</th><th class="number">'+d+"</th><tr></thead><tbody>"+g+"</tbody></table>"};
Blu.fn.socialShare=function(){if(!Blu.config.mapOnly&&!Blu.config.clientMode&&!Blu.config.UI.mobile){var a=$("#share");a.hide().html(Blu.share.html);a.show()}};
"undefined"!==typeof CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.dashedLineTo=function(a,b,c,d,e){var f=function(a,b){return a<=b},g=function(a,b){return a>=b},h=function(a,b){return Math.min(a,b)},j=function(a,b){return Math.max(a,b)},k={thereYet:g,cap:h},g={thereYet:g,cap:h};0<b-d&&(g.thereYet=f,g.cap=j);0<a-c&&(k.thereYet=f,k.cap=j);this.moveTo(a,b);for(var f=a,j=b,h=0,l=!0;!k.thereYet(f,c)||!g.thereYet(j,d);){var m=Math.atan2(d-b,c-a),n=e[h],f=k.cap(c,f+Math.cos(m)*n),j=g.cap(d,
j+Math.sin(m)*n);l?this.lineTo(f,j):this.moveTo(f,j);h=(h+1)%e.length;l=!l}});Blu.fn.app.isAppUrl=function(a){var b=location.protocol+"//"+location.host+"/"+location.pathname,b=b.replace(/\/$/,"");a=a.replace(/(\/?(#(.*))?)$/,"");if(a==Blu.app.urls.main||a==location.href||a==b)return!0;for(var c in Blu.app.urls.alt)if(b=Blu.app.urls.alt[c].replace(/\/$/,""),a==b)return!0;return!1};
Blu.fn.app.blockingIframeWebsites=function(a){a=Blu.fn.misc.domainFromUrl(a);var b="youtube.com facebook.com vimeo.com flickr.com livestream.com lefigaro.fr scribd.com over-blog.com knol.google.com metacafe.com stackoverflow.com nytimes.com boston.com eurekalert.org palais-decouverte.fr leparisien.fr megavideo.com revoirlatele.com rnews.be unblog.fr".split(" "),c;for(c in b)if(a==b[c])return!0;return!1};Blu.fn.localhost=function(){return-1!=location.host.search(/localhost/)};
Blu.log=function(a){(Blu.fn.localhost()||Blu.debugMode)&&"undefined"!=typeof console&&console.log(a)};Blu.dir=function(a){(Blu.fn.localhost()||Blu.debugMode)&&("undefined"!==typeof window.console&&"undefined"!==typeof window.console.dir)&&console.dir(a)};Blu.warn=function(a){(Blu.fn.localhost()||Blu.debugMode)&&("undefined"!==typeof window.console&&"undefined"!==typeof window.console.warn)&&console.warn(a)};
Blu.info=function(a){(Blu.fn.localhost()||Blu.debugMode)&&("undefined"!==typeof window.console&&"undefined"!==typeof window.console.info)&&console.info(a)};
Blu.localizedStrings={date_format:{fr:"{0} {1}",en:"{1} {0}"},date_yymmdd:{fr:"{0}/{1}/{2}",en:"{1}/{0}/{2}"},date_text:{fr:"{3} {0} {1} {2}",en:"{3}, {1} {0}, {2}"},date_hhmm:{fr:"{0}/{1}/{2}  {3}:{4}",en:"{1}/{0}/{2}  {3}:{4}"},date_hhmm2:{fr:"{0} {1} {2}  {3}:{4}",en:"{1} {0} {2}  {3}:{4}"},months:{fr:"janvier f\u00e9vrier mars avril mai juin juillet ao\u00fbt septembre octobre novembre d\u00e9cembre".split(" "),en:"January February March April May June July August September October November December".split(" ")},
days:{fr:"Dimanche Lundi Mardi Mercredi Jeudi Vendredi Samedi".split(" "),en:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")},months_abbrev:{fr:"jan fev mars avr mai juin juil aout sept oct nov dec".split(" "),en:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")},just_now:{fr:"\u00e0 l'instant",en:"just now"},x_seconds_ago:{fr:"il y a {0} secondes",en:"{0} seconds ago"},"1_minute_ago":{fr:"il y a 1 minute",en:"1 minute ago"},x_minutes_ago:{fr:"il y a {0} minutes",
en:"{0} minutes ago"},"1_hour_ago":{fr:"il y a 1 heure",en:"1 hour ago"},x_hours_ago:{fr:"il y a {0} heures",en:"{0} hours ago"},yesterday:{fr:"Hier",en:"Yesterday"},x_days_ago:{fr:"il y a {0} jours",en:"{0} days ago"},day_with_hour:{fr:"{0} {1}, \u00e0 {2}:{3}",en:"{0} {1}, at {2}:{3}"},"1_week_ago":{fr:"il y a 1 semaine",en:"1 week ago"},x_weeks_ago:{fr:"il y a {0} semaines",en:"{0} weeks ago"},error_oldBrowser:{fr:'<p><strong>Mauvaise nouvelle</strong>: votre navigateur est obsol\u00e8te et ne peut afficher correctement les cartes Bluenod...</p>\n                <p><strong>Bonne nouvelle</strong>: mettre \u00e0 jour votre navigateur est simple et ne prend que quelques minutes ! Choisissez un navigateur \u00e0 t\u00e9l\u00e9charger depuis le site officiel : \n                </p>\n                <p class="align-center">\n                    <a class="btn btn-primary" href="http://www.mozilla.com/" target="_blank">Firefox</a> \n                    <a class="btn btn-primary" href="http://www.google.com/chrome/" target="_blank">Chrome</a> \n                    <a class="btn btn-primary" href="http://www.apple.com/safari/" target="_blank">Safari</a> \n                    <a class="btn btn-primary" href="http://windows.microsoft.com/fr-FR/internet-explorer/products/ie/home" target="_blank">Internet Explorer</a>\n                </p>',
en:'<p><strong>Bad news</strong>: the browser you are using is out of date and cannot display our maps correctly...</p>\n                <p><strong>Good news</strong>: updating your browser is easy and just takes a few minutes! Just choose a browser to download from the official website: \n                </p>\n                <p class="align-center">\n                    <a class="btn btn-primary" href="http://www.mozilla.com/" target="_blank">Firefox</a> \n                    <a class="btn btn-primary" href="http://www.google.com/chrome/" target="_blank">Chrome</a> \n                    <a class="btn btn-primary" href="http://www.apple.com/safari/" target="_blank">Safari</a> \n                    <a class="btn btn-primary" href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home" target="_blank">Internet Explorer</a>\n                </p>'},
loading:{fr:"Chargement...",en:"Loading..."},home:{fr:"Accueil",en:"Home"},search:{fr:"Recherche",en:"Search"},showEdges:{fr:"Afficher les connexions",en:"Show connections"},hideEdges:{fr:"Cacher les connexions",en:"Hide connections"},tweetsWithX:{fr:"{0} tweets avec {1}",en:"{0} tweets with {1}"},tweetWithX:{fr:"{0} tweet avec {1}",en:"{0} tweet with {1}"},legendTotal:{fr:"{0} tweets",en:"{0} tweets"},legendSlice:{fr:"{0} ({1} - {2}) : {3} tweets",en:"{0} ({1} - {2}) : {3} tweets"},legendSliceOneDay:{fr:"{0} : {1} tweets",
en:"{0} : {1} tweets"},legendSliceAxis:{fr:"{0} ({1} - {2})",en:"{0} ({1} - {2})"},legendSliceAxisOneDay:{fr:"{0}",en:"{0}"},legendUser:{fr:"{0} <br/> {1} tweet(s) <br/> {2} mention(s)",en:"{0} <br/> {1} tweet(s) <br/> {2} mention(s)"},showProfile:{fr:"Afficher le profil",en:"Show profile"},followButton:{fr:"Suivre",en:"Follow"},following:{fr:"Abonn\u00e9",en:"Following"},unfollowButton:{fr:"Ne plus suivre",en:"Unfollow"},lookTwitterStatus:{fr:"Voir le statut sur Twitter",en:"Look status on Twitter"},
errorTwitterProfile:{fr:"Impossible de r\u00e9cup\u00e9rer les informations (compte supprim\u00e9 ou probl\u00e8me de l'API Twitter).",en:"Sorry, we couldn't get data from this Twitter account. \n                It could be a temporary problem from the Twitter API or maybe this account has been deleted."},titleEmbedImage:{fr:"Ouvrir le lien",en:"Open link"},AC_words:{fr:"Hashtags",en:"Hashtags"},AC_people:{fr:"Personnes",en:"People"},timeMachine:{fr:"Machine \u00e0 remonter le temps",en:"Time Machine"},
timeMachineTip:{fr:"\u2039 Remonter dans le temps",en:"\u2039 Go back in time"},timeMachineTipHover:{fr:"Cliquez pour remonter le temps",en:"Click for a time travel"},timeMachineTipPresent:{fr:"Reinitialisation \u203a",en:"Reset \u203a"},timeMachineTraveling:{fr:"Chargement des tweets\u2026",en:"Loading tweets\u2026"},notifNewTweets:{fr:"{0} nouveaux tweets",en:"{0} new tweets"},notifNewTweet:{fr:"1 nouveau tweet",en:"1 new tweet"},twActions_favorite:{fr:"Favori",en:"Favorite"},twActions_retweet:{fr:"Retweeter",
en:"Retweet"},twActions_reply:{fr:"R\u00e9pondre",en:"Reply"},stats_tweets:{fr:"Tweets",en:"Tweets"},stats_following:{fr:"Abonnements",en:"Following"},stats_followers:{fr:"Abonn\u00e9s",en:"Followers"},stats_listed:{fr:"List\u00e9",en:"Listed"},showTwitterProfile:{fr:"Afficher le profil Twitter",en:"Show Twitter profile"},togglePanel:{fr:"Afficher / cacher le panneau",en:"Show / hide the panel"},noData:{fr:"Pas de donn\u00e9es disponibles",en:"No data available"},close:{fr:"Fermer",en:"Close"},more:{fr:"+",
en:"+"},"delete-project":{fr:"Le projet va \u00eatre supprim\u00e9. \u00cates-vous s\u00fbr ?",en:"You are about to remove this search. Are you sure?"},"twitter-connect-success":{fr:"Vous avez connect\u00e9 votre compte Twitter ({0})",en:"You have connected your Twitter account ({0})"},"twitter-disconnect":{fr:"Vous avez d\u00e9connect\u00e9 votre compte Twitter",en:"You have disconnected your Twitter account"},"twitter-connect-denied":{fr:"Vous n'avez pas autoris\u00e9 Bluenod \u00e0 se connecter \u00e0 votre compte Twitter !",
en:"You didn't authorize Bluenod to connect your Twitter account!"},"twitter-rate-limit-exceeded":{fr:"Erreur Twitter : nombre de requ\u00eates maximum atteint.",en:"Twitter error: rate limit exceeded."},Disconnect:{fr:"D\u00e9connexion",en:"Disconnect"},"Connect your Twitter account":{fr:"Connectez votre compte Twitter",en:"Connect your Twitter account"},"search-history":{fr:"Pr\u00e9c\u00e9dentes recherches",en:"Search history"},"enter-search-general":{fr:"Entrez un #hashtag ou n'importe quel terme \u00e0 chercher",
en:"Type a #hashtag or any search term"},"enter-search-user":{fr:"Rechercher un @utilisateur",en:"Search for a @username"},"no-history-search-general":{en:"No search yet.<br/> Type any #hashtag or topic and hit [Enter] to create a map."},"no-history-search-user":{en:"No search yet.<br/> Type any Twitter username and hit [Enter] to create a map."}};Array.remove=function(a,b,c){c=a.slice((c||b)+1||a.length);a.length=0>b?a.length+b:b;return a.push.apply(a,c)};
(function(a){function b(b,d){this.$element=a(b);this.options=d;this.enabled=!0;this.fixTitle()}b.prototype={show:function(){var b=this.getTitle();if(b&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](b);d[0].className="tipsy";d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var b=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight}),e=d[0].offsetWidth,f=d[0].offsetHeight,
g="function"==typeof this.options.gravity?this.options.gravity.call(this.$element[0]):this.options.gravity,h;switch(g.charAt(0)){case "n":h={top:b.top+b.height+this.options.offset,left:b.left+b.width/2-e/2};break;case "s":h={top:b.top-f-this.options.offset,left:b.left+b.width/2-e/2};break;case "e":h={top:b.top+b.height/2-f/2,left:b.left-e-this.options.offset};break;case "w":h={top:b.top+b.height/2-f/2,left:b.left+b.width+this.options.offset}}2==g.length&&(h.left="w"==g.charAt(1)?b.left+b.width/2-
15:b.left+b.width/2-e+15);d.css(h).addClass("tipsy-"+g);d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+g.charAt(0);this.options.className&&d.addClass("function"==typeof this.options.className?this.options.className.call(this.$element[0]):this.options.className);this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):
this.tip().remove()},fixTitle:function(){var a=this.$element;if(a.attr("title")||"string"!=typeof a.attr("original-title"))a.attr("original-title",a.attr("title")||"").removeAttr("title")},getTitle:function(){var a,b=this.$element,e=this.options;this.fixTitle();e=this.options;"string"==typeof e.title?a=b.attr("title"==e.title?"original-title":e.title):"function"==typeof e.title&&(a=e.title.call(b[0]));return(""+a).replace(/(^\s*|\s*$)/,"")||e.fallback},tip:function(){this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'));
return this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.options=this.$element=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}};a.fn.tipsy=function(c){function d(d){var e=a.data(d,"tipsy");e||(e=new b(d,a.fn.tipsy.elementOptions(d,c)),a.data(d,"tipsy",e));return e}function e(){var a=d(this);a.hoverState="in";0==c.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},
c.delayIn))}function f(){var a=d(this);a.hoverState="out";0==c.delayOut?a.hide():setTimeout(function(){"out"==a.hoverState&&a.hide()},c.delayOut)}if(!0===c)return this.data("tipsy");if("string"==typeof c){var g=this.data("tipsy");if(g)g[c]();return this}c=a.extend({},a.fn.tipsy.defaults,c);c.live||this.each(function(){d(this)});if("manual"!=c.trigger){var g=c.live?"live":"bind",h="hover"==c.trigger?"mouseleave":"blur";this[g]("hover"==c.trigger?"mouseenter":"focus",e)[g](h,f)}return this};a.fn.tipsy.defaults=
{className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:0.8,title:"title",trigger:"hover"};a.fn.tipsy.elementOptions=function(b,d){return a.metadata?a.extend({},d,a(b).metadata()):d};a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"};a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"};a.fn.tipsy.autoBounds=function(b,d){return function(){var e=
d[0],f=1<d.length?d[1]:!1,g=a(document).scrollTop()+b,h=a(document).scrollLeft()+b,j=a(this);j.offset().top<g&&(e="n");j.offset().left<h&&(f="w");a(window).width()+a(document).scrollLeft()-j.offset().left<b&&(f="e");a(window).height()+a(document).scrollTop()-j.offset().top<b&&(e="s");return e+(f?f:"")}}})(jQuery);
!function(a,b,c){function d(a,c){var d=b.createElement(a||"div"),e;for(e in c)d[e]=c[e];return d}function e(a){for(var b=1,c=arguments.length;b<c;b++)a.appendChild(arguments[b]);return a}function f(a,b){var d=a.style,e,f;if(d[b]!==c)return b;b=b.charAt(0).toUpperCase()+b.slice(1);for(f=0;f<l.length;f++)if(e=l[f]+b,d[e]!==c)return e}function g(a,b){for(var c in b)a.style[f(a,c)||c]=b[c];return a}function h(a){for(var b=1;b<arguments.length;b++){var d=arguments[b],e;for(e in d)a[e]===c&&(a[e]=d[e])}return a}
function j(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}function k(a){if(!this.spin)return new k(a);this.opts=h(a||{},k.defaults,s)}var l=["webkit","Moz","ms","O"],m={},n,p,q=d("style",{type:"text/css"});e(b.getElementsByTagName("head")[0],q);p=q.sheet||q.styleSheet;var s={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",speed:1,trail:100,opacity:0.25,fps:20,zIndex:2E9,className:"spinner",top:"auto",left:"auto",position:"relative"};
k.defaults={};h(k.prototype,{spin:function(a){this.stop();var b=this,c=b.opts,e=b.el=g(d(0,{className:c.className}),{position:c.position,width:0,zIndex:c.zIndex}),f=c.radius+c.length+c.width,h,k;a&&(a.insertBefore(e,a.firstChild||null),k=j(a),h=j(e),g(e,{left:("auto"==c.left?k.x-h.x+(a.offsetWidth>>1):parseInt(c.left,10)+f)+"px",top:("auto"==c.top?k.y-h.y+(a.offsetHeight>>1):parseInt(c.top,10)+f)+"px"}));e.setAttribute("aria-role","progressbar");b.lines(e,b.opts);if(!n){var l=0,m=c.fps,p=m/c.speed,
q=(1-c.opacity)/(p*c.trail/100),r=p/c.lines;(function u(){l++;for(var a=c.lines;a;a--){var d=Math.max(1-(l+a*r)%p*q,c.opacity);b.opacity(e,c.lines-a,d,c)}b.timeout=b.el&&setTimeout(u,~~(1E3/m))})()}return b},stop:function(){var a=this.el;a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c);return this},lines:function(a,b){function c(a,e){return g(d(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:e,transformOrigin:"left",
transform:"rotate("+~~(360/b.lines*f+b.rotate)+"deg) translate("+b.radius+"px,0)",borderRadius:(b.corners*b.width>>1)+"px"})}for(var f=0,h;f<b.lines;f++){h=d();var j=1+~(b.width/2)+"px",k=b.hwaccel?"translate3d(0,0,0)":"",l=b.opacity,q;if(q=n){q=b.opacity;var r=b.trail,t=f,s=b.lines,v=["opacity",r,~~(100*q),t,s].join("-"),t=0.01+100*(t/s),s=Math.max(1-(1-q)/r*(100-t),q),u=n.substring(0,n.indexOf("Animation")).toLowerCase(),u=u&&"-"+u+"-"||"";m[v]||(p.insertRule("@"+u+"keyframes "+v+"{0%{opacity:"+
s+"}"+t+"%{opacity:"+q+"}"+(t+0.01)+"%{opacity:1}"+(t+r)%100+"%{opacity:"+q+"}100%{opacity:"+s+"}}",p.cssRules.length),m[v]=1);q=v+" "+1/b.speed+"s linear infinite"}h=g(h,{position:"absolute",top:j,transform:k,opacity:l,animation:q});b.shadow&&e(h,g(c("#000","0 0 4px #000"),{top:"2px"}));e(a,e(h,c(b.color,"0 0 1px rgba(0,0,0,.1)")))}return a},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}});var r=function(a,b){return d("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',
b)},q=g(d("group"),{behavior:"url(#default#VML)"});!f(q,"transform")&&q.adj?(p.addRule(".spin-vml","behavior:url(#default#VML)"),k.prototype.lines=function(a,b){function c(){return g(r("group",{coordsize:h+" "+h,coordorigin:-f+" "+-f}),{width:h,height:h})}function d(a,h,j){e(k,e(g(c(),{rotation:360/b.lines*a+"deg",left:~~h}),e(g(r("roundrect",{arcsize:b.corners}),{width:f,height:b.width,left:b.radius,top:-b.width>>1,filter:j}),r("fill",{color:b.color,opacity:b.opacity}),r("stroke",{opacity:0}))))}
var f=b.length+b.width,h=2*f,j=2*-(b.width+b.length)+"px",k=g(c(),{position:"absolute",top:j,left:j});if(b.shadow)for(j=1;j<=b.lines;j++)d(j,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(j=1;j<=b.lines;j++)d(j);return e(a,k)},k.prototype.opacity=function(a,b,c,d){a=a.firstChild;d=d.shadow&&d.lines||0;if(a&&b+d<a.childNodes.length&&(a=(a=(a=a.childNodes[b+d])&&a.firstChild)&&a.firstChild))a.opacity=c}):n=f(q,"animation");"function"==typeof define&&define.amd?
define(function(){return k}):a.Spinner=k}(window,document);
$.fn.spin=function(a){var b={};if("object"===typeof a)b=a;else switch(a){case "create-graph":case "big":b={lines:13,length:4,width:5,radius:16,corners:1,rotate:0,color:"#32aff5",speed:2,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2E9,top:"auto",left:"auto"};break;case "small":b={lines:12,length:3,width:2,radius:7,rotate:0,color:"#555",trail:50};break;case "very-small":b={lines:10,length:2,width:2,radius:4,rotate:0,color:"#555",trail:50};break;case "sidebar":b={lines:11,length:4,width:4,
radius:8,corners:1,rotate:0,color:"#555",speed:1.5,trail:68,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2E9,top:"auto",left:"auto"};break;default:b={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:0.25,fps:20,zIndex:2E9,className:"spinner",top:"auto",left:"auto"}}this.each(function(){var c=$(this),d=c.data();d.spinner&&(d.spinner.stop(),delete d.spinner);b&&(d.spinner=(new Spinner($.extend({color:c.css("color")},b))).spin(this),Blu.log('Spinner > new "'+a+'"'))});
return this};$.fn.spinStop=function(){this.each(function(){var a=$(this).data();a.spinner&&(Blu.log("Spinner > stop : "+JSON.stringify(a.spinner.opts)+""),a.spinner.stop(),delete a.spinner)});return this};$.fn.onScrollEnd=function(a){"function"!==typeof a?Blu.warn("No callback in $.fn.onScrollEnd"):$(this).bind("scroll",function(){var b=$(this);b.scrollTop()+b.innerHeight()>=b[0].scrollHeight&&a()})};
(function(a){function b(b){var c=b||window.event,d=[].slice.call(arguments,1),h=0,j=0,k=0;b=a.event.fix(c);b.type="mousewheel";c.wheelDelta&&(h=c.wheelDelta/120);c.detail&&(h=-c.detail/3);k=h;void 0!==c.axis&&c.axis===c.HORIZONTAL_AXIS&&(k=0,j=-1*h);void 0!==c.wheelDeltaY&&(k=c.wheelDeltaY/120);void 0!==c.wheelDeltaX&&(j=-1*c.wheelDeltaX/120);d.unshift(b,h,j,k);return(a.event.dispatch||a.event.handle).apply(this,d)}var c=["DOMMouseScroll","mousewheel"];if(a.event.fixHooks)for(var d=c.length;d;)a.event.fixHooks[c[--d]]=
a.event.mouseHooks;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=c.length;a;)this.addEventListener(c[--a],b,!1);else this.onmousewheel=b},teardown:function(){if(this.removeEventListener)for(var a=c.length;a;)this.removeEventListener(c[--a],b,!1);else this.onmousewheel=null}};a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);
(function(){if("ontouchstart"in window&&!/chrome/i.test(navigator.userAgent)){var a,b,c,d=function(a,b){return 5<Math.abs(a[0]-b[0])||5<Math.abs(a[1]-b[1])};document.addEventListener("touchstart",function(a){this.startXY=[a.touches[0].clientX,a.touches[0].clientY];this.treshold=!1},!1);document.addEventListener("touchmove",function(a){if(this.treshold)return!1;this.threshold=d(this.startXY,[a.touches[0].clientX,a.touches[0].clientY])},!1);document.addEventListener("touchend",function(a){if(!this.treshold&&
!d(this.startXY,[a.changedTouches[0].clientX,a.changedTouches[0].clientY])){var b=a.changedTouches[0],c=document.createEvent("MouseEvents");c.initMouseEvent("click",!0,!0,window,0,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);c.simulated=!0;a.target.dispatchEvent(c)}},!1);document.addEventListener("click",function(d){var f=Date.now(),g=f-a,h=d.clientX,j=d.clientY,k=[Math.abs(b-h),Math.abs(c-j)],l;a:{for(l=d.target;l!==document.body;){if(!l||"A"===l.nodeName)break a;l=l.parentNode}l=
null}var m=l||d.target;l="A"===m.nodeName;var n=window.navigator.standalone&&l&&d.target.getAttribute("href");a=f;b=h;c=j;if(!d.simulated&&(500>g||1500>g&&50>k[0]&&50>k[1])||n)if(d.preventDefault(),d.stopPropagation(),!n)return!1;window.navigator.standalone&&l&&m.getAttribute("href")&&(window.location=m.getAttribute("href"));m&&m.classList&&(m.classList.add("m-focus"),window.setTimeout(function(){m.classList.remove("m-focus")},150))},!0)}})();